{"componentChunkName":"component---src-templates-blog-post-js","path":"/2023-10-26-technical-intro-to-defi-lending-protocols-with-zklend-codebase-as-an-example/","result":{"data":{"site":{"siteMetadata":{"title":"Joel's dev blog","author":"Joel Mun","siteUrl":"https://9oelm.github.io"}},"markdownRemark":{"id":"948de1a1-c622-51ea-b545-248979eb45a7","excerpt":"How a lending protocol works Functionalities Deposit Borrow Leverage Shorting Liquidate Repay Over-collateralization Utilization rate Interest rate Borrow…","html":"<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#how-a-lending-protocol-works\">How a lending protocol works</a></p>\n<ul>\n<li>\n<p><a href=\"#functionalities\">Functionalities</a></p>\n<ul>\n<li>\n<p><a href=\"#deposit\">Deposit</a></p>\n</li>\n<li>\n<p><a href=\"#borrow\">Borrow</a></p>\n<ul>\n<li><a href=\"#leverage\">Leverage</a></li>\n<li><a href=\"#shorting\">Shorting</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#liquidate\">Liquidate</a></p>\n</li>\n<li>\n<p><a href=\"#repay\">Repay</a></p>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#over-collateralization\">Over-collateralization</a></p>\n</li>\n<li>\n<p><a href=\"#utilization-rate\">Utilization rate</a></p>\n</li>\n<li>\n<p><a href=\"#interest-rate\">Interest rate</a></p>\n<ul>\n<li>\n<p><a href=\"#borrow-interest-rate\">Borrow interest rate</a></p>\n</li>\n<li>\n<p><a href=\"#supply-interest-rate\">Supply interest rate</a></p>\n</li>\n<li>\n<p><a href=\"#compound-interest-calculation\">Compound interest calculation</a></p>\n<ul>\n<li><a href=\"#cumulated-liquidity-index\">Cumulated liquidity index</a></li>\n<li><a href=\"#example-interest-rate-calculation\">Example: interest rate calculation</a></li>\n<li><a href=\"#example-continued-cumulated-liquidity-index--cumulated-borrow-index-calculation\">Example (continued): cumulated liquidity index &#x26; cumulated borrow index calculation</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#liquidation\">Liquidation</a></p>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#technical-review\">Technical review</a></p>\n<ul>\n<li><a href=\"#deposit-1\">Deposit</a></li>\n<li><a href=\"#withdraw\">Withdraw</a></li>\n<li><a href=\"#borrow-1\">Borrow</a></li>\n<li><a href=\"#repay-1\">Repay</a></li>\n<li><a href=\"#liquidate-1\">Liquidate</a></li>\n</ul>\n</li>\n</ul>\n</div>\n<p>Here’s an extensive intro to DeFi lending protocols, especially for a dummy like me. We will look at fundamental concepts and theory, primarily complemented by zklend smart contract codebase at <a href=\"https://github.com/zkLend/zklend-v1-core/commit/10dfb3d1f01b1177744b038f8417a5a9c3e94185\">the commit hash of 10dfb3d1f01b1177744b038f8417a5a9c3e94185</a>.</p>\n<h1 id=\"how-a-lending-protocol-works\" style=\"position:relative;\">How a lending protocol works<a href=\"#how-a-lending-protocol-works\" aria-label=\"how a lending protocol works permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<h2 id=\"functionalities\" style=\"position:relative;\">Functionalities<a href=\"#functionalities\" aria-label=\"functionalities permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>There are 4 major functionalities that a lending protocol provides to the users:</p>\n<h3 id=\"deposit\" style=\"position:relative;\">Deposit<a href=\"#deposit\" aria-label=\"deposit permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Users can deposit tokens into the smart contract as much as they want. For example, I can deposit 1000 USDC into the smart contract.</p>\n<p>This will accrue interest over time. The interest accrual can only happen when there is at least one borrower, because the borrower will need to pay for the depositor’s interests. Otherwise, the interest rate stays at 0%. Deposit is the beginning of every other functionalities.</p>\n<h3 id=\"borrow\" style=\"position:relative;\">Borrow<a href=\"#borrow\" aria-label=\"borrow permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Users are able to borrow certain amount of token, but only based on the amount of collaterals by depositing. For example, you may supply 1.1 ETH to borrow 500 USDC, only if 1.1 ETH is sufficiently more than the value of 500 USDC in USD.</p>\n<p>For example, 1.1 ETH is 1,813.79 USD today, and 500 USDC is approximately 500 USD. The collateralization factor, which denotes the value of borrowed amount that can be covered with an amount of collateralized token, is 80%. This means <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1813.79</mn><mo>×</mo><mn>0.8</mn><mo>=</mo><mn>1451.032</mn></mrow><annotation encoding=\"application/x-tex\">1813.79 \\times 0.8 = 1451.032</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mord\">8</span><span class=\"mord\">1</span><span class=\"mord\">3</span><span class=\"mord\">.</span><span class=\"mord\">7</span><span class=\"mord\">9</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">8</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">4</span><span class=\"mord\">5</span><span class=\"mord\">1</span><span class=\"mord\">.</span><span class=\"mord\">0</span><span class=\"mord\">3</span><span class=\"mord\">2</span></span></span></span></span> USD worth of other assets can be borrowed from the protocol. This way, all of the borrowings in the protocol are backed by overly sufficient amount of tokens, which is called overcollateralization.</p>\n<p>But why borrow in the first place, if you already have as much as (or even more than) the amount of token that you want to borrow?</p>\n<p>Below are the possible reasons:</p>\n<h4 id=\"leverage\" style=\"position:relative;\">Leverage<a href=\"#leverage\" aria-label=\"leverage permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h4>\n<p>Here’s a table describing the variables for this example:</p>\n<table>\n<thead>\n<tr>\n<th>name</th>\n<th>value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Price of 1 ETH in USD</td>\n<td>1200</td>\n</tr>\n<tr>\n<td>Price of 1 USDC in USD</td>\n<td>1</td>\n</tr>\n<tr>\n<td>Bob’s initial ETH balance</td>\n<td>2</td>\n</tr>\n<tr>\n<td>Collateral factor of ETH</td>\n<td>80%</td>\n</tr>\n<tr>\n<td>Gas fees, interests</td>\n<td>0</td>\n</tr>\n</tbody>\n</table>\n<p>Bob thinks the value of ETH will dramatically increase over time, so just a simple x1 long position is not enough for him. He is so sure that he want to get more than x1 profit when the price of ETH increases. This is how he would position himself at a leveraged long position:</p>\n<ol>\n<li>Bob deposits 2 ETH into the protocol</li>\n<li>Bob borrows <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1200</mn><mo>×</mo><mn>2</mn><mo>×</mo><mn>0.5</mn><mo>=</mo><mn>1200</mn><mo>&#x3C;</mo><mn>1200</mn><mo>×</mo><mn>2</mn><mo>×</mo><mn>0.8</mn><mo>=</mo><mn>1920</mn></mrow><annotation encoding=\"application/x-tex\">1200 \\times 2 \\times 0.5 = 1200 &#x3C; 1200 \\times 2 \\times 0.8 = 1920</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mord\">2</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68354em;vertical-align:-0.0391em;\"></span><span class=\"mord\">1</span><span class=\"mord\">2</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&#x3C;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mord\">2</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">8</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">9</span><span class=\"mord\">2</span><span class=\"mord\">0</span></span></span></span></span> worth of USDC from the protocol. Now he can spend 1200 USDC for whatever he wants.</li>\n<li>Bob goes to Uniswap, and swaps 1200 USDC for 1 ETH.</li>\n<li>Now Bob owns 3 ETH, although he has a debt of 1200 USDC.</li>\n<li>A few days later, the price of 1 ETH in USD increases to 1600 USD. Now his total profit off of this increase is <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1600</mn><mo>×</mo><mn>3</mn><mo>−</mo><mn>1200</mn><mo>×</mo><mn>3</mn><mo>=</mo><mn>1200</mn></mrow><annotation encoding=\"application/x-tex\">1600 \\times 3 - 1200 \\times 3 = 1200</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mord\">6</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mord\">2</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">3</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">2</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span></span></span>:\n<ol>\n<li>Bob now swaps his 1 ETH with 1600 USDC. Then he repays for his 1200 USDC debt. He still has 400 USDC left in his wallet.</li>\n<li>Then Bob withdraws 2 ETH from the protocol, and swaps that for <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1600</mn><mo>×</mo><mn>2</mn><mo>=</mo><mn>3200</mn></mrow><annotation encoding=\"application/x-tex\">1600 \\times 2 = 3200</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mord\">6</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">3</span><span class=\"mord\">2</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span></span></span> USDC at Uniswap.</li>\n<li><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>3200</mn><mo>+</mo><mn>400</mn><mo>=</mo><mn>3600</mn></mrow><annotation encoding=\"application/x-tex\">3200 +  400 = 3600</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">3</span><span class=\"mord\">2</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">4</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">3</span><span class=\"mord\">6</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span></span></span> USDC is the total he now has.</li>\n<li>Bob started with 2 ETH that was equivalent to 2400 USD, but after the price increase, he made additional 400 USD in addition to 800 USD that is the increase in the USD value of 2 ETH.</li>\n</ol>\n</li>\n<li>Imagine if Bob held 3 ETH from the beginning. Then this would be valued at 4800 USD after the price increase, leaving Bob with 1200 USD of profit as well. Without the protocol, he wouldn’t have been able to achieve the same profit.</li>\n</ol>\n<h4 id=\"shorting\" style=\"position:relative;\">Shorting<a href=\"#shorting\" aria-label=\"shorting permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h4>\n<h3 id=\"liquidate\" style=\"position:relative;\">Liquidate<a href=\"#liquidate\" aria-label=\"liquidate permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>The value of tokens supplied as collaterals fluctuates over time. For example, if you have deposited 1.1 ETH as a collateral, it might be 1809.47 USD today, but it could have been 1790 USD yesterday. In such a case, the total value of collaterals might not be able to cover the total amount of tokens borrowed by a user.</p>\n<p>Then other users get a chance to liquidate that user’s position. In liquidation, a substantial amount of the user’s debt can be repaid by the liquidator, and the borrower will take an additional percentage of the user’s collateral as a liquidation bonus (or a penalty, from POV of the borrower). More on this later too.</p>\n<h3 id=\"repay\" style=\"position:relative;\">Repay<a href=\"#repay\" aria-label=\"repay permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>repay for the amount of token you borrowed, plus the accrued interest.</p>\n<h2 id=\"over-collateralization\" style=\"position:relative;\">Over-collateralization<a href=\"#over-collateralization\" aria-label=\"over collateralization permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Any lending protocol would want to assume over-colleteralization for maximum measure of security. Typically, the more volatile/unstable the price of an asset is, the lower collateral factor it would count for.</p>\n<p>Usually, lending protocols would restrict which assets can be used as a collateral. However, it’s also worth noting that there are some protocols that allow users to create their own pairs of asset to be borrowed and collateralized.</p>\n<p>An example of overcollateralization can be seen in any lending protocols; For example, $LINK has a 79% of collateral factor on Compound today. This means if you deposit $100 worth of $LINK, you will be ables to borrow $79 worth of any assets without being liquidated.</p>\n<h2 id=\"utilization-rate\" style=\"position:relative;\">Utilization rate<a href=\"#utilization-rate\" aria-label=\"utilization rate permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>We will need to define a few key terms to further understand other concepts.</p>\n<p><strong>Utilization rate</strong> denotes how much of a single asset deposited in the pool is being borrowed at a time.</p>\n<blockquote>\n<p>The <strong>utilisation rate of each pool</strong> is a function of the current outstanding loan amount over the total capital supply in the specific liquidity pool (from zklend whitepaper)</p>\n</blockquote>\n<p>Here’s an example:</p>\n<ul>\n<li>Bob deposits 100 USDT (worth 100 USD) in USDT pool</li>\n<li>Alice deposits 100 DAI (worth 100 USD) in DAI pool</li>\n<li>The collateral factor of DAI is 80%, so Alice borrows 80 USDT, which is the maximum of what she can safely borrow without getting liquidated</li>\n<li>Now, the utilization rate of USDT is <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><mn>80</mn><mn>100</mn></mfrac><mo>=</mo><mn>80</mn><mi mathvariant=\"normal\">%</mi></mrow><annotation encoding=\"application/x-tex\">\\frac{80}{100} = 80\\%</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.190108em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">0</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">8</span><span class=\"mord mtight\">0</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.80556em;vertical-align:-0.05556em;\"></span><span class=\"mord\">8</span><span class=\"mord\">0</span><span class=\"mord\">%</span></span></span></span></span> and that of DAI is <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><mn>0</mn><mn>100</mn></mfrac><mo>=</mo><mn>0</mn><mi mathvariant=\"normal\">%</mi></mrow><annotation encoding=\"application/x-tex\">\\frac{0}{100} = 0\\%</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.190108em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\">0</span><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">0</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.80556em;vertical-align:-0.05556em;\"></span><span class=\"mord\">0</span><span class=\"mord\">%</span></span></span></span></span></li>\n</ul>\n<p>Utilization rate of an asset will change whenever there is a new borrowing or supply.</p>\n<p>Here’s <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/irms/default_interest_rate_model.cairo#L63-L71\">calculate_utilization_rate</a> from zklend contract:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">calculate_utilization_rate</span><span class=\"token punctuation\">(</span>reserve_balance<span class=\"token punctuation\">:</span> felt252<span class=\"token punctuation\">,</span> total_debt<span class=\"token punctuation\">:</span> felt252<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> felt252 <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> total_debt <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token number\">0</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> total_liquidity <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>reserve_balance<span class=\"token punctuation\">,</span> total_debt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> utilization_rate <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">div</span><span class=\"token punctuation\">(</span>total_debt<span class=\"token punctuation\">,</span> total_liquidity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        utilization_rate\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The function’s calculation is as follows: <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><mtext>total debt</mtext><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>e</mi><mi>r</mi><mi>v</mi><mi>e</mi><mo>+</mo><mtext>total debt</mtext></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">\\frac{\\text{total debt}}{reserve + \\text{total debt}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.283439em;vertical-align:-0.403331em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8801079999999999em;\"><span style=\"top:-2.655em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mbin mtight\">+</span><span class=\"mord text mtight\"><span class=\"mord mtight\">total debt</span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">total debt</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.403331em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span>. Here, <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>e</mi><mi>r</mi><mi>v</mi><mi>e</mi></mrow><annotation encoding=\"application/x-tex\">reserve</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">e</span></span></span></span></span> denotes the cash available in the liquidity pool that is not being utilized.</p>\n<h2 id=\"interest-rate\" style=\"position:relative;\">Interest rate<a href=\"#interest-rate\" aria-label=\"interest rate permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>For the interest rate, we need to talk about the interest rate model first. An interest model is meant to encourage borrowing when there is enough capital, and discourage borrowing (encourage repayment) and additional supply when there is not enough capital. Logically, we arrive at the conclusion that the interest rate must be high when there is high utilization rate, and low when there is low utilization rate.</p>\n<p>We would also want to set an optimal utilization rate, because we generally would not want the utilization rate to be too low (no one’s using it) or too high (no one can borrow anymore).</p>\n<h3 id=\"borrow-interest-rate\" style=\"position:relative;\">Borrow interest rate<a href=\"#borrow-interest-rate\" aria-label=\"borrow interest rate permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>With all of these in mind, we can introduce this interest rate model <strong>for borrowing</strong>:</p>\n<table>\n<thead>\n<tr>\n<th>Variable</th>\n<th>Meaning</th>\n<th>Domain (or Range)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>U</mi></mrow><annotation encoding=\"application/x-tex\">U</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span></span></span></span></span></td>\n<td>Utilization rate</td>\n<td><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>U</mi><mo>∈</mo><mo stretchy=\"false\">[</mo><mn>0</mn><mo separator=\"true\">,</mo><mn>1</mn><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">U \\in [0, 1]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72243em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∈</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">]</span></span></span></span></span></td>\n</tr>\n<tr>\n<td><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>U</mi><mtext>optimal</mtext></msub></mrow><annotation encoding=\"application/x-tex\">U_{\\text{optimal}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">optimal</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span></td>\n<td>Optimal utilization rate</td>\n<td><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>U</mi><mtext>optimal</mtext></msub><mo>∈</mo><mo stretchy=\"false\">[</mo><mn>0</mn><mo separator=\"true\">,</mo><mn>1</mn><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">U_{\\text{optimal}} \\in [0, 1]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">optimal</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∈</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">]</span></span></span></span></span></td>\n</tr>\n<tr>\n<td><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi></mrow><annotation encoding=\"application/x-tex\">R</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span></span></span></span></span></td>\n<td>Interest rate at utiliation rate <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>U</mi></mrow><annotation encoding=\"application/x-tex\">U</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span></span></span></span></span></td>\n<td><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi><mo>∈</mo><mo stretchy=\"false\">[</mo><mn>0</mn><mo separator=\"true\">,</mo><mi mathvariant=\"normal\">∞</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">R \\in [0, \\infty]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72243em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∈</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">∞</span><span class=\"mclose\">]</span></span></span></span></span></td>\n</tr>\n<tr>\n<td><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>R</mi><mtext>slope1</mtext></msub></mrow><annotation encoding=\"application/x-tex\">R_{\\text{slope1}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">slope1</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span></td>\n<td>Variable Rate Slope 1 (the slope that is going to be applied on the left side of the graph)</td>\n<td><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>R</mi><mtext>slope1</mtext></msub><mo>∈</mo><mo stretchy=\"false\">[</mo><mn>0</mn><mo separator=\"true\">,</mo><mi mathvariant=\"normal\">∞</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">R_{\\text{slope1}} \\in [0, \\infty]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">slope1</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∈</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">∞</span><span class=\"mclose\">]</span></span></span></span></span></td>\n</tr>\n<tr>\n<td><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>R</mi><mtext>slope2</mtext></msub></mrow><annotation encoding=\"application/x-tex\">R_{\\text{slope2}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">slope2</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span></td>\n<td>Variable Rate Slope 2 (the slope that is going to be applied on the right side of the graph)</td>\n<td><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>R</mi><mtext>slope2</mtext></msub><mo>∈</mo><mo stretchy=\"false\">[</mo><mn>0</mn><mo separator=\"true\">,</mo><mi mathvariant=\"normal\">∞</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">R_{\\text{slope2}} \\in [0, \\infty]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">slope2</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∈</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">∞</span><span class=\"mclose\">]</span></span></span></span></span></td>\n</tr>\n<tr>\n<td><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>R</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">R_0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span></td>\n<td>Base interest rate. This adjusts the y-intercept of the interest rate curve.</td>\n<td><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>R</mi><mn>0</mn></msub><mo>∈</mo><mo stretchy=\"false\">[</mo><mn>0</mn><mo separator=\"true\">,</mo><mn>1</mn><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">R_0 \\in [0, 1]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∈</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">]</span></span></span></span></span></td>\n</tr>\n</tbody>\n</table>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>U</mi><mo>&#x3C;</mo><mo>=</mo><msub><mi>U</mi><mrow><mi>o</mi><mi>p</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>l</mi></mrow></msub><mo>⇒</mo><mi>R</mi><mo>=</mo><msub><mi>R</mi><mn>0</mn></msub><mo>+</mo><mfrac><mi>U</mi><msub><mi>U</mi><mtext>optimal</mtext></msub></mfrac><mo stretchy=\"false\">(</mo><msub><mi>R</mi><mtext>slope1</mtext></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">U &#x3C;= U_{optimal} \\rArr R = R_0 + \\frac{U}{U_{\\text{optimal}}}(R_{\\text{slope1}})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72243em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&#x3C;</span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">m</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">⇒</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.332438em;vertical-align:-0.972108em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.36033em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">optimal</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.972108em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">slope1</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span></div>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>U</mi><mo>></mo><msub><mi>U</mi><mrow><mi>o</mi><mi>p</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>l</mi></mrow></msub><mo>⇒</mo><mi>R</mi><mo>=</mo><msub><mi>R</mi><mn>0</mn></msub><mo>+</mo><msub><mi>R</mi><mtext>slope1</mtext></msub><mo>+</mo><msub><mi>R</mi><mtext>slope2</mtext></msub><mfrac><mrow><mi>U</mi><mo>−</mo><msub><mi>U</mi><mtext>optimal</mtext></msub></mrow><mrow><mn>1</mn><mo>−</mo><msub><mi>U</mi><mtext>optimal</mtext></msub></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">U > U_{optimal} \\rArr R = R_0 + R_{\\text{slope1}} + R_{\\text{slope2}}\\frac{U - U_{\\text{optimal}}}{1 - U_{\\text{optimal}}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72243em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">m</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">⇒</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">slope1</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.332438em;vertical-align:-0.972108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">slope2</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.36033em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">optimal</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">optimal</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.972108em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span></div>\n<p>It may just be easy to use a graph to find out what it means rather than looking at the equations.</p>\n<p><a href=\"https://www.geogebra.org/calculator/cpbssemc\">You can interact with the graphs I created here</a>.</p>\n<p>Below graph is the interest rate model for <a href=\"https://docs.aave.com/risk/liquidity-risk/borrow-interest-rate#rate-strategy-stable-one\">‘Rate Strategy Stable One’ on Aave</a>. This refers to “Low liquidity stablecoins have lower Optimal Utilisation Ratio than those with higher liquidity”. A rate strategy is just a list of variables used for the interest rate model. You would want to use different strategies for different crypto assets, owing to their stability/volatility. Every lending protocol has their own interest rate strategy for different assets; <a href=\"https://zklend.gitbook.io/documentation/using-zklend/technical/asset-parameters#for-interest-rate-model\">Zklend has also has one</a>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/55e36fdd7440cc764d48c6557cba3042/8698d/rate-strategy-stable-one-curve.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.21621621621621%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA6UlEQVQ4y62S4XKEIAyEff+HtSCEkABuJ7ly017V88cxswOJ+LlJXIgVhQXMjJQSeu8QEdRan1LV9xLBtq5YtDBqKQ7MOTvUIK01B5vsfKne0cxESljazxfM2RjDd4vt4nRo55l7leftHauECEsfA/u+P2VrXjbXE3iqCSTyshdzNddHgUcOb5ds+12gDcX6eulSxIHm9BB4NJRbwNauHf7u4VnJ/swmXMoHgC/90ztAkYr+7qcuhK6PXp8CRRTM1aX6iEX/i6six4REjJjLMbBwxRoywkaury27/sTRcoQQEnKIIK6IW8I36Lz9aKZLP4gAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Rate Strategy Stable One Interest Rate Model\"\n        title=\"Rate Strategy Stable One Interest Rate Model\"\n        src=\"/static/55e36fdd7440cc764d48c6557cba3042/fcda8/rate-strategy-stable-one-curve.png\"\n        srcset=\"/static/55e36fdd7440cc764d48c6557cba3042/12f09/rate-strategy-stable-one-curve.png 148w,\n/static/55e36fdd7440cc764d48c6557cba3042/e4a3f/rate-strategy-stable-one-curve.png 295w,\n/static/55e36fdd7440cc764d48c6557cba3042/fcda8/rate-strategy-stable-one-curve.png 590w,\n/static/55e36fdd7440cc764d48c6557cba3042/efc66/rate-strategy-stable-one-curve.png 885w,\n/static/55e36fdd7440cc764d48c6557cba3042/c83ae/rate-strategy-stable-one-curve.png 1180w,\n/static/55e36fdd7440cc764d48c6557cba3042/8698d/rate-strategy-stable-one-curve.png 1239w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>As you can see, until the utilization rate hits 90%, the interest rate stays quite low. But when it becomes slightly above 90%, the borrow interest rate would become 10%. This will (hopefully) act as an disincentive for people to borrow and incentive for the borrowers to repay the money, thereby decreasing the utilization rate, hopefully back to <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>U</mi><mtext>Optimal</mtext></msub></mrow><annotation encoding=\"application/x-tex\">U_{\\text{Optimal}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">Optimal</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<p>The calculation of borrow interest rate is handled by <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/irms/default_interest_rate_model.cairo#L73\">calculate_borrow_rate</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">calculate_borrow_rate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">@</span><span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span> utilization_rate<span class=\"token punctuation\">:</span> felt252<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> felt252 <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> params <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>curve_params<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> below_optimal_rate <span class=\"token operator\">=</span> <span class=\"token class-name\">Into</span><span class=\"token punctuation\">::</span><span class=\"token operator\">&lt;</span>_<span class=\"token punctuation\">,</span>\n    u256<span class=\"token operator\">></span><span class=\"token punctuation\">::</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span>utilization_rate<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token class-name\">Into</span><span class=\"token punctuation\">::</span><span class=\"token operator\">&lt;</span>_<span class=\"token punctuation\">,</span> u256<span class=\"token operator\">></span><span class=\"token punctuation\">::</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>optimal_rate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> below_optimal_rate <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> temp_1 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">div</span><span class=\"token punctuation\">(</span>utilization_rate<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">.</span>optimal_rate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> temp_2 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>slope_0<span class=\"token punctuation\">,</span> temp_1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> borrow_rate <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>y_intercept<span class=\"token punctuation\">,</span> temp_2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        borrow_rate\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// No need to use safe math here</span>\n        <span class=\"token keyword\">let</span> excess_utilization_rate <span class=\"token operator\">=</span> utilization_rate <span class=\"token operator\">-</span> params<span class=\"token punctuation\">.</span>optimal_rate<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> optimal_to_one <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token constant\">SCALE</span> <span class=\"token operator\">-</span> params<span class=\"token punctuation\">.</span>optimal_rate<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> temp_1 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">div</span><span class=\"token punctuation\">(</span>excess_utilization_rate<span class=\"token punctuation\">,</span> optimal_to_one<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> temp_2 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>slope_1<span class=\"token punctuation\">,</span> temp_1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> temp_3 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">.</span>y_intercept<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">.</span>slope_0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> borrow_rate <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>temp_2<span class=\"token punctuation\">,</span> temp_3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        borrow_rate\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">curve_params</code> has a type of <code class=\"language-text\">CurveParams</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">CurveParams</span> <span class=\"token punctuation\">{</span>\n    slope_0<span class=\"token punctuation\">:</span> felt252<span class=\"token punctuation\">,</span>\n    slope_1<span class=\"token punctuation\">:</span> felt252<span class=\"token punctuation\">,</span>\n    y_intercept<span class=\"token punctuation\">:</span> felt252<span class=\"token punctuation\">,</span>\n    optimal_rate<span class=\"token punctuation\">:</span> felt252\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>It does nothing but to define the variables we just saw in the equation of the borrow interest rate.</p>\n<p>The function is pretty straightforward; <code class=\"language-text\">if below_optimal_rate</code> calculates the borrow interest rate when <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>U</mi><mo>&#x3C;</mo><mo>=</mo><msub><mi>U</mi><mrow><mi>o</mi><mi>p</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>l</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">U &#x3C;= U_{optimal}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72243em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&#x3C;</span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">m</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span>. <code class=\"language-text\">else</code> block calculates when <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>U</mi><mo>></mo><msub><mi>U</mi><mrow><mi>o</mi><mi>p</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>l</mi></mrow></msub></mrow><annotation encoding=\"application/x-tex\">U > U_{optimal}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72243em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">m</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span>.</p>\n<h3 id=\"supply-interest-rate\" style=\"position:relative;\">Supply interest rate<a href=\"#supply-interest-rate\" aria-label=\"supply interest rate permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>The supply interest rate is the rate at which interest is generated when someone deposits a token into the liquidity pool. It must always be smaller than the borrow interest rate, because otherwise the protocol wouldn’t have a way to fund the interests and take some part of the borrow interests into its reserve.</p>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>Supply Interest Rate</mtext><mo>=</mo><mtext>Borrow Interest Rate</mtext><mo>×</mo><mi>U</mi><mo>×</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mtext>−Reserve Factor</mtext><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\text{Supply Interest Rate} = \\text{Borrow Interest Rate} \\times U \\times (1 − \\text{Reserve Factor})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord text\"><span class=\"mord\">Supply Interest Rate</span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.76666em;vertical-align:-0.08333em;\"></span><span class=\"mord text\"><span class=\"mord\">Borrow Interest Rate</span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.76666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mord\">−</span><span class=\"mord text\"><span class=\"mord\">Reserve Factor</span></span><span class=\"mclose\">)</span></span></span></span></span></div>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mtext>Reserve Factor</mtext><mo>∈</mo><mo stretchy=\"false\">[</mo><mn>0</mn><mo separator=\"true\">,</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\text{Reserve Factor} \\in [0, 1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72243em;vertical-align:-0.0391em;\"></span><span class=\"mord text\"><span class=\"mord\">Reserve Factor</span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∈</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span></span></div>\n<p><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>Borrow Interest Rate</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{Borrow Interest Rate}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord text\"><span class=\"mord\">Borrow Interest Rate</span></span></span></span></span></span> is what we already calculated from the previous section. <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>Reserve Factor</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{Reserve Factor}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord text\"><span class=\"mord\">Reserve Factor</span></span></span></span></span></span> is the percentage of the borrowing interest rate that the protocol takes as a profit.</p>\n<p>Let’s say we have a reserve factor of <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0.15</mn></mrow><annotation encoding=\"application/x-tex\">0.15</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">1</span><span class=\"mord\">5</span></span></span></span></span>. If we take all rates into the axis, we will get:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bdf6a2b054ed8d076d8254995d573f9e/81315/rate-strategy-stable-one-curve-with-supply-rate.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.37837837837838%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABH0lEQVQoz42RjW7DIAyEef8nnbS1geA/wOQmaFM17bYM6WRhw8dhB4oJKd20rityJqSYwCSo1VFrQWvtVO4NVQ3BmaGqYGaUUuDu2LYOM4dqg5neL/gplK+EoFJBxIgpQkQer5XSoOooxSbsTBO4MIJIn6Cc83S6uxlQZoeZ/Qnx3b0ZOClCrW1eGnoGzhf/AZznu8NIoWQIvXfsa9u2g0MRh4i9AV57OoCaFTaAA7KvAX8GjsEQnQFvZzUJzNoR+HDYfgfOWjv28DZhnrkJ3KEjDtD4wlBzR8722P+sPqNEQd/6u0PTgvKkuBiq1UNul7GiEIMvK9LHCkmCcGiuO+hKyJeMfM3gyFi+FLQIeLnn77UZFwZlw/JJoCgoVvAN/xlegSq48SsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"rate strategy stable one curve with supply rates\"\n        title=\"rate strategy stable one curve with supply rates\"\n        src=\"/static/bdf6a2b054ed8d076d8254995d573f9e/fcda8/rate-strategy-stable-one-curve-with-supply-rate.png\"\n        srcset=\"/static/bdf6a2b054ed8d076d8254995d573f9e/12f09/rate-strategy-stable-one-curve-with-supply-rate.png 148w,\n/static/bdf6a2b054ed8d076d8254995d573f9e/e4a3f/rate-strategy-stable-one-curve-with-supply-rate.png 295w,\n/static/bdf6a2b054ed8d076d8254995d573f9e/fcda8/rate-strategy-stable-one-curve-with-supply-rate.png 590w,\n/static/bdf6a2b054ed8d076d8254995d573f9e/efc66/rate-strategy-stable-one-curve-with-supply-rate.png 885w,\n/static/bdf6a2b054ed8d076d8254995d573f9e/c83ae/rate-strategy-stable-one-curve-with-supply-rate.png 1180w,\n/static/bdf6a2b054ed8d076d8254995d573f9e/81315/rate-strategy-stable-one-curve-with-supply-rate.png 1656w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>The blue curve is the supply interest rate, and the red borrow interest rate. And we only care about the range of functions for which <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi><mo>∈</mo><mo stretchy=\"false\">[</mo><mn>0</mn><mo separator=\"true\">,</mo><mn>1</mn><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">x \\in [0, 1]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5782em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">∈</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">]</span></span></span></span></span>, where <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi></mrow><annotation encoding=\"application/x-tex\">x</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">x</span></span></span></span></span> is the utilization rate.</p>\n<p>As you noticed from the equation, the supply interest rate curve must always be a parabola, because we have <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>U</mi></mrow><annotation encoding=\"application/x-tex\">U</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span></span></span></span></span> being multipled by itself once (<span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>Borrow Interest Rate</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{Borrow Interest Rate}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord text\"><span class=\"mord\">Borrow Interest Rate</span></span></span></span></span></span> has <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>U</mi></mrow><annotation encoding=\"application/x-tex\">U</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span></span></span></span></span> in it, and it’s being multiplied by <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>U</mi></mrow><annotation encoding=\"application/x-tex\">U</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span></span></span></span></span> again).</p>\n<h3 id=\"compound-interest-calculation\" style=\"position:relative;\">Compound interest calculation<a href=\"#compound-interest-calculation\" aria-label=\"compound interest calculation permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<h4 id=\"cumulated-liquidity-index\" style=\"position:relative;\">Cumulated liquidity index<a href=\"#cumulated-liquidity-index\" aria-label=\"cumulated liquidity index permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h4>\n<p>But calculating borrow and supply interest rates is not the end of the story. What we’ve looked at so far is calculation of simple interest rate, without regards to time.</p>\n<p>If you have deposited a sum of a token, the interest should pile up on top of another as time goes on. Therefore we need a way to calculate compound interest.</p>\n<p>If you have tried any DeFi lending protocol before, you would retrieve some token that represents a token deposited in the protocol that is 1:1 to the real underlying asset in return to your deposit. For example, you get <a href=\"https://docs.compound.finance/v2/ctokens/\">cToken on Compound</a>, <a href=\"https://docs.aave.com/developers/tokens/atoken\">aToken on Aave</a>, and <a href=\"https://zklend.gitbook.io/documentation/using-zklend/supply/ztokens\">zToken on Zklend</a>. And if you check the balance of those tokens on metamask from time to time, you can notice that it changes over time, even if you don’t do anything. This is because of interest accrual.</p>\n<p>Below is an example of <code class=\"language-text\">aDai</code> on Aave that increases over time as compound interest accrues:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/64428226ca4f4918ef2fd9556189c422/cecac/aDai-balance-0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 166.2162162162162%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAhCAYAAADZPosTAAAACXBIWXMAABYlAAAWJQFJUiTwAAAFVklEQVRIx41WSW4bRxTlKRxLZA81dFf1wJlsziLFWdRoy5YHybJkO04Ex+MiMBwHiAEnQIAA9jbIAATJEbLKJXKD7HKEbPOCqqYoSnZsLz5Y3fXr8Q/vv+rEfuNbOCKESTlMwkG4ABc+uOuDCQ9ECv3eIPE+dSSY62kf9euIYOar3iV2Gy9BmITNOJKmjXMLSTBHwnR8NLMST1p1XN47wPXdG9g/uIWlTg9+OqfBbOqiP5nAL+c1sJfOIuF5Vb1pUQ7DpjoK/e/ChycDlLwswnwJGW1lyCALx0vHWQgfwk+De2odwJEBEjYPYTMXNnVgs6mpNeWwbIKUZcI0DBimBcMwYFkWbNOATaj2swjXwRxbgjpZnSI9ZQJUpkGKXZBoDBKNQNW6sgJSHsKub4KGESgXZ87JGPA4/GNzVIHTZbD+AcjqfZCVI9DBLZDJZyBrD2FdfgFeHsR+Z87OAOc7Z6mUuYDBJEwmYVAJyw1hUAGTe7C4hEnjMs2fU3YqQk0DGWAwnqDR6mD70g7GkzWsbWyhNxhhZXUd3f4Qk7UNbGxtYzheRTpX1KnG5/03AV0vxCdH93B4+2M8ePQE9x8+xudPn+Ha3j52bxzg6bPneu/wzl3cunMX+WJ0wt23p+xrUBlkYHOJYlRDpztAVGuiUmui3upoSlHXg/TTOiN2XMP5lNn0BXflrB6KGs12F2ubF7Dc7etUe8MVMEdoPzr15447O3+SsnIQIajMgDsiBkxXYBMGUxHeTetGWIRpH0Ur5UdFADuMwLmjQWeAinveleeQh6/BKINx7SX83/4F6e6CpyP4n/4AZ3RbR+fufgP3+teglgnn6Eckv/8Hdn0DnNI5QO6CrT8Eu/IClBCkLjxF8vXfsJoXwcMS2M1XIMt7YCqSS1+Cbn8BogAPvoN8/ReM0gCcsRhQtT2dK6BQKqMUVZHJFZDL5bHcHyMIQrjSR6nSQJDOwnElytUGiuUqpB9iudtDbzBGJaqAOh4SzI2VQw15kMlrU2svzKEU1eBqIQiQyRfhhVldpzBb0M+ODJEtlDV1wmwxJrZF5Yw2eh650HVSa5uJk45P5zautwThcurjwmLubC+xmEpNWy5BC0uw2zsg0RBcxnKkQMvVOnauXkehXJ2RWHG1P1rRE6Om6ZjHMaCfg11owy52YVdGsMsDkFIXNKu0UmpgRXQFMj+7XpDRYuuHJ8ORWDQMTRlVNxkEOlKtIq53aiTPSv9J6mK2pwHPLXyEajTEq3t/YtK7icFkjL39Qy31Z++QeTAFpIRBXQtbFy/j0s5VTNY3kTifXEQ6HeHx7s9o17dRW2phfWsb/fEqOv0R+qMJZJiNx+x4ROeAFStU91XqMkjHKTNXwKQpUM6RzRVRLEXI5ovI5Uv6WagGqZQ0mHcq9Xm11imnDANdTpG3OCqMo8oIImKh7rCpcTSEg7bLURQC5AzoG4q9cH4B240Cfv/pES5uDNHqjrC2dREmc2FQByZ1YDABX3iouw5sNwZ8G1gMuLCIzWoef/z6AHvbfSz1VrRcdQdjNJaW0er0UKg0ILmLmnBhi/cAWoaBBqcwqQBlLspRVVur1UGt1kCzuRSPluOi/iGAyZSBtuDIWRQN4aJgplCyLVQZ1VZhBFXO0BIOMq4AfW/KKUN/lxztNtFs1dAerKBcayJpc1hcaLMVgbXsx6rM/gdsBig9iV++6qLfymA42UJ/OEa5Utf3R6lSQzZf0h8DJzx8R4QxDz0kLUfrmbqUVDPa3QE6vSGWlvsoVepzV6X3TtOA+mtBBvFITedTf+9MjUzBPsS02ugB52I66G83wj/M/gNPsv2t9PUMgwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"aDai balance #0\"\n        title=\"aDai balance #0\"\n        src=\"/static/64428226ca4f4918ef2fd9556189c422/fcda8/aDai-balance-0.png\"\n        srcset=\"/static/64428226ca4f4918ef2fd9556189c422/12f09/aDai-balance-0.png 148w,\n/static/64428226ca4f4918ef2fd9556189c422/e4a3f/aDai-balance-0.png 295w,\n/static/64428226ca4f4918ef2fd9556189c422/fcda8/aDai-balance-0.png 590w,\n/static/64428226ca4f4918ef2fd9556189c422/cecac/aDai-balance-0.png 728w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ac41ac3eb3ba82837e8a6dc41c669f61/3cb0f/aDai-balance-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 169.59459459459458%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAiCAYAAABfqvm9AAAACXBIWXMAABYlAAAWJQFJUiTwAAAFrElEQVRIx42WyW4cxxnH5ymMiOSwl6quXmemZ985G2cjOaTIWJYpWrZoxTIMQ17iRZGtXJwcnFNyCBAg5yDLA/iWg18ir5LrL6gaTmsoOUgOf1RVV33/+vbqnAoSXC9EeCFSxei1hvQT8irGdv0MrgyQfoy3OaNipKdlCnh+YsbcviNxPcXPdvO8sbOLI30cLyJNfJ72y6xO3+Rodcrq7gWH8yWlSg3pR1iuR7PTozsdmXlSKiNUQM71AvK2YCdvsWc5CBUi/IgojJjHFbqDCf3hhIPhhEq9RZCUjJb6XJiUiKplM/ejgrko50iFLTxsoXCEMqNeW47kjuOym99nN2+xu7dP3nKwHBfbFeac5UosW97MPTRXztUm3oLC8QKcqIIb13CT+tZYxUnqOFE5O78tr+c5reZthMi4ijt5hH36Jfbqc9zZB9jHn2CffEb+8nvcw0d4QczrshE547Mb6A/mJhVixQ2cYgen0MLWY7GNU+pipwOssJJppWW2OXJC6Q9RtlGq1IkKJar1BoVialCu1IgLRaI4oVAo0mx3Sat1iuUaOqhr2RsNt9XVmx9+9DEP37vm2fNv+fpX3/D8219z/fgJz56/4LNffsmzb17w7qPHfP7FV4wOZxlhZvKrhDo9JrMFB6ND+sMxi6MVo8mMeqtLfzA2SCt1huMpjXYXR/4E4dp/MTKITfgt4bNjS1q9ARf37nN+722myxPeurzCCxNsGdykSYAIiwgte5O/uU0whBAI1zWknqeQ+Tso5RMmKaHv4/u+SWqz5zp4WiMV4OXvIF3XkGnStcmej+xfICYPkdLDbs6xn/wZtzHDFRJn9A6ie4arBRszxOwxIkgQxSY77/8Ja/QAqRXyY00Y4ngh4fXvCZ7+1TSAnQe/I/wRrKvvzTr89O/4139YE/78OeHXP+CWOtiThxR/hJ0vfkDkd5C6Oehw+0GEai/wD87x/QCvNkRc/RavOjAae4N7yNYSKSWqMcEbPzCuCctNSu/9hnh0Yc4ZH+rI6nxqNpo06nWTh6VSymo2ppSuC7/TblGr1oxAtVrjoN8jTIp0ewcsJgOmhxP8qLhO7CzTvQDh+WuoCNd0lPWejrqzlcDaV1oRHel9sxduR3kdLRFXEIUGIq5mNb1pS61O32j+sipCklKFSq1JtdEmiApZ6eY2Hdgt97F75zjtY0SUZomuBXVydw9GmZa6htu9AYvjFSen57cuy7lRym6pjZ32sYpd8oUO++UBbtrNtFwn8ctGsLlszxLsWm7WD40Pg7DEuHdOUkxNSbU6PdJKDVeqW11om2wzr7c6xh1ptWFGFSbkBp1z/vHi3yyH77NYHfHOw2tTu1po09alIdrG2uzV2QX3L684Xt3lzfuX5knI+VHK3flTSmmferfH7PiU4XTJeH7M/OSMQqVhatfVZmqoCEet53uOx54tjLn6XVqbrHxce5dQStK4QBonFMOYQhBRDCOSICRWAbH/ClRAIQhNUZj6v+nguZES9HRqqICWJ2n76jV0trBZt3zFQOnzHs7m6dCEl9M2//rnd9w9mTA+OuOtq3exVcSuNkco9ly1Hm/meeGvv8mAwA9pKWXckBEeNcv87Y9POJ116A2nzJfHzBZrzJcnJgcn0wXT+ZLl8SmD0SGzxRHN7gGRt9bU3dawLiVvWL4pr2KlTlprUmm0qbW6VJsdM9+MGnpf78XlOpEKjAtuEfaVR8Vy6HoeDXufpmPRkYKOdDO0hUNbuAbZWgpGvqSqfBP1jDAIA776xZh+r8V0fkyne8C+LcxfhH709eOtu/NPYdMQTEVt3pRCEvCX7yYMOzGHyzPjH21ipz+k1uxQrrXM4XWXeR0vyW401BHasdYPjibQTWA8XXA4P2IwntLuHbxSguFruEWoJ14QZeW0KXQN8wMl/Yxsu5b/G3LZTf/j8P9Dpgn/A1IuI85xFf0uAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"aDai balance #1\"\n        title=\"aDai balance #1\"\n        src=\"/static/ac41ac3eb3ba82837e8a6dc41c669f61/fcda8/aDai-balance-1.png\"\n        srcset=\"/static/ac41ac3eb3ba82837e8a6dc41c669f61/12f09/aDai-balance-1.png 148w,\n/static/ac41ac3eb3ba82837e8a6dc41c669f61/e4a3f/aDai-balance-1.png 295w,\n/static/ac41ac3eb3ba82837e8a6dc41c669f61/fcda8/aDai-balance-1.png 590w,\n/static/ac41ac3eb3ba82837e8a6dc41c669f61/3cb0f/aDai-balance-1.png 708w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>But how is it done under the hood? Let’s read code on Zklend.</p>\n<p>Below are <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/z_token/view.cairo#L51-L62\">functions to calculate the balance of a ZToken</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">balanceOf</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">@</span><span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span> account<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> u256 <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">felt_balance_of</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> account<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">felt_balance_of</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">@</span><span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span> account<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> felt252 <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> accumulator <span class=\"token operator\">=</span> <span class=\"token namespace\">internal<span class=\"token punctuation\">::</span></span><span class=\"token function\">get_accumulator</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> balance <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>raw_balances<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>account<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> scaled_up_balance <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>balance<span class=\"token punctuation\">,</span> accumulator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    scaled_up_balance\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">felt_balance_of</code> reads from <code class=\"language-text\">ContractState</code> the raw balance of the token, but it times that with <code class=\"language-text\">accumulator</code>. So that’s the secret. If the value of <code class=\"language-text\">accumulator</code> is somehow dynamic, every time your Metamask wallet calls <code class=\"language-text\">balanceOf</code> from the blockchain, the token balance should also be dynamic.</p>\n<p>But what does <code class=\"language-text\">accumulator</code> do? First of all, <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/z_token/internal.cairo#L31-L35\">get_accumulator</a> will get the corresponding accumulator that is in the <code class=\"language-text\">Market</code> contract by calling <code class=\"language-text\">get_lending_accumulator</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">get_accumulator</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">@</span><span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> felt252 <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> market_addr <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>market<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> underlying_addr <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>underlying<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">IMarketDispatcher</span> <span class=\"token punctuation\">{</span> contract_address<span class=\"token punctuation\">:</span> market_addr <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">get_lending_accumulator</span><span class=\"token punctuation\">(</span>underlying_addr<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This is <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/view.cairo#L32-L67\">get_lending_accumulator</a>, where the compound interest is calculated:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">get_lending_accumulator</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">@</span><span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> felt252 <span class=\"token punctuation\">{</span>\n    <span class=\"token namespace\">internal<span class=\"token punctuation\">::</span></span><span class=\"token function\">assert_reserve_enabled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> reserve <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>reserves<span class=\"token punctuation\">.</span><span class=\"token function\">read_for_get_lending_accumulator</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> block_timestamp<span class=\"token punctuation\">:</span> felt252 <span class=\"token operator\">=</span> <span class=\"token function\">get_block_timestamp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> reserve<span class=\"token punctuation\">.</span>last_update_timestamp <span class=\"token operator\">==</span> block_timestamp <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Accumulator already updated on the same block</span>\n        reserve<span class=\"token punctuation\">.</span>lending_accumulator\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Apply simple interest</span>\n        <span class=\"token keyword\">let</span> time_diff <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>block_timestamp<span class=\"token punctuation\">,</span> reserve<span class=\"token punctuation\">.</span>last_update_timestamp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Treats reserve factor as zero if treasury address is not set</span>\n        <span class=\"token keyword\">let</span> treasury_addr <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>treasury<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> effective_reserve_factor <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> treasury_addr<span class=\"token punctuation\">.</span><span class=\"token function\">is_zero</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token number\">0</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            reserve<span class=\"token punctuation\">.</span>reserve_factor\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> one_minus_reserve_factor <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>\n            <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token constant\">SCALE</span><span class=\"token punctuation\">,</span> effective_reserve_factor\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// New accumulator</span>\n        <span class=\"token comment\">// (current_lending_rate * (1 - reserve_factor) * time_diff / SECONDS_PER_YEAR + 1) * accumulator</span>\n        <span class=\"token keyword\">let</span> temp_1 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>reserve<span class=\"token punctuation\">.</span>current_lending_rate<span class=\"token punctuation\">,</span> time_diff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> temp_2 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>temp_1<span class=\"token punctuation\">,</span> one_minus_reserve_factor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> temp_3 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">div</span><span class=\"token punctuation\">(</span>temp_2<span class=\"token punctuation\">,</span> <span class=\"token constant\">SECONDS_PER_YEAR</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> temp_4 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">div</span><span class=\"token punctuation\">(</span>temp_3<span class=\"token punctuation\">,</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token constant\">SCALE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> temp_5 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>temp_4<span class=\"token punctuation\">,</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token constant\">SCALE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> latest_accumulator <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>temp_5<span class=\"token punctuation\">,</span> reserve<span class=\"token punctuation\">.</span>lending_accumulator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        latest_accumulator\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Below is the description of the variables being used from <code class=\"language-text\">self.reserves</code>:</p>\n<table>\n<thead>\n<tr>\n<th>name</th>\n<th>description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class=\"language-text\">last_update_timestamp</code></td>\n<td>the timestamp at which <code class=\"language-text\">lending_accumulator</code> was updated for the last time, in seconds since the epoch</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">lending_accumulator</code></td>\n<td>cumulated liquidity index (or simply interest index). Tracks the interest cumulated by the reserve during the time interval, updated whenever a borrow, deposit, repay, redeem, swap, liquidation event occurs.</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">current_lending_rate</code></td>\n<td>the current lending rate that was calculated by <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/irms/default_interest_rate_model.cairo#L49-L61\"><code class=\"language-text\">get_interest_rates</code> of <code class=\"language-text\">DefaultInterestRateModel</code></a></td>\n</tr>\n</tbody>\n</table>\n<p>The equation for calculating a cumulated liquidity/borrow index is as follows:</p>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>I</mi><mi>n</mi><mi>d</mi><mi>e</mi><msub><mi>x</mi><mi>n</mi></msub><mo>=</mo><mi>I</mi><mi>n</mi><mi>d</mi><mi>e</mi><msub><mi>x</mi><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>×</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>+</mo><mi>r</mi><mo>×</mo><mi>t</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">Index_n = Index_{n-1} \\times (1 + r \\times t)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.902771em;vertical-align:-0.208331em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.301108em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.66666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span></span></span></span></span></div>\n<p>where</p>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>t</mi><mo>=</mo><mtext>Time Interval (length of time since the last index calculation)</mtext></mrow><annotation encoding=\"application/x-tex\">t = \\text{Time Interval} \\text{ (length of time since the last index calculation)}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.61508em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">Time Interval</span></span><span class=\"mord text\"><span class=\"mord\"> (length of time since the last index calculation)</span></span></span></span></span></span></div>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>r</mi><mo>=</mo><mtext>Interest Rate</mtext></mrow><annotation encoding=\"application/x-tex\">r = \\text{Interest Rate}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord text\"><span class=\"mord\">Interest Rate</span></span></span></span></span></span></div>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>n</mi><mo>=</mo><msup><mi>n</mi><mrow><mi>t</mi><mi>h</mi></mrow></msup><mtext> index calculated</mtext></mrow><annotation encoding=\"application/x-tex\">n = n^{th}\\text{ index calculated}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8991079999999999em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8991079999999999em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">h</span></span></span></span></span></span></span></span></span><span class=\"mord text\"><span class=\"mord\"> index calculated</span></span></span></span></span></span></div>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>I</mi><mi>n</mi><mi>d</mi><mi>e</mi><msub><mi>x</mi><mn>0</mn></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">Index_0 = 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span></span></div>\n<p>we can see that <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>r</mi></mrow><annotation encoding=\"application/x-tex\">r</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.43056em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span></span></span></span></span> is represented by <code class=\"language-text\">current_lending_rate * (1 - reserve_factor)</code>, and <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.61508em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span></span> by <code class=\"language-text\">time_diff / SECONDS_PER_YEAR</code> (look at the comment in the code), and <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>I</mi><mi>n</mi><mi>d</mi><mi>e</mi><msub><mi>x</mi><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding=\"application/x-tex\">Index_{n-1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.902771em;vertical-align:-0.208331em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.301108em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span></span></span></span></span> by <code class=\"language-text\">reserve.lending_accumulator</code>.</p>\n<p>This works exactly the same way for <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/view.cairo#L69\">get_debt_accumulator</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">get_debt_accumulator</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">@</span><span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> felt252 <span class=\"token punctuation\">{</span>\n    <span class=\"token namespace\">internal<span class=\"token punctuation\">::</span></span><span class=\"token function\">assert_reserve_enabled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> reserve <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>reserves<span class=\"token punctuation\">.</span><span class=\"token function\">read_for_get_debt_accumulator</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> block_timestamp<span class=\"token punctuation\">:</span> felt252 <span class=\"token operator\">=</span> <span class=\"token function\">get_block_timestamp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>reserve<span class=\"token punctuation\">.</span>last_update_timestamp <span class=\"token operator\">==</span> block_timestamp<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Accumulator already updated on the same block</span>\n        reserve<span class=\"token punctuation\">.</span>debt_accumulator\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Apply simple interest</span>\n        <span class=\"token keyword\">let</span> time_diff <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>block_timestamp<span class=\"token punctuation\">,</span> reserve<span class=\"token punctuation\">.</span>last_update_timestamp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// (current_borrowing_rate * time_diff / SECONDS_PER_YEAR + 1) * accumulator</span>\n        <span class=\"token keyword\">let</span> temp_1 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>reserve<span class=\"token punctuation\">.</span>current_borrowing_rate<span class=\"token punctuation\">,</span> time_diff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> temp_2 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">div</span><span class=\"token punctuation\">(</span>temp_1<span class=\"token punctuation\">,</span> <span class=\"token constant\">SECONDS_PER_YEAR</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> temp_3 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>temp_2<span class=\"token punctuation\">,</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token constant\">SCALE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> latest_accumulator <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>temp_3<span class=\"token punctuation\">,</span> reserve<span class=\"token punctuation\">.</span>debt_accumulator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        latest_accumulator\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>It is the same logic as <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/view.cairo#L32-L67\"><code class=\"language-text\">get_lending_accumulator</code></a>, except that the reserve factor is not a part of the equation because we are taking profit from the debtors, not for lending. That means we want to take the full borrow index as it is from the debt, and instead lower the liquidity index for lending so that the protocol can take certain % as a profit.</p>\n<h4 id=\"example-interest-rate-calculation\" style=\"position:relative;\">Example: interest rate calculation<a href=\"#example-interest-rate-calculation\" aria-label=\"example interest rate calculation permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h4>\n<p>To find the final amount of borrowing or deposit with the accrued interests considered, all you need to do is to multiply the raw principal value with the cumulated liquidity/borrow index. But calculating the index requires calculating interest rates. So let’s dive into one example. This example is based on <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/tests/market.cairo#L198\">zklend’s smart contract tests</a>.</p>\n<p>Here’s an example for calculating accrued interests for borrowing and deposit.</p>\n<p>Let’s say we got $SIS and $BRO tokens:</p>\n<table>\n<thead>\n<tr>\n<th>Token</th>\n<th>Oracle Price (USD)</th>\n<th>Collateral factor</th>\n<th><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>R</mi><mtext>slope1</mtext></msub></mrow><annotation encoding=\"application/x-tex\">R_{\\text{slope1}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">slope1</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span></th>\n<th><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>R</mi><mtext>slope2</mtext></msub></mrow><annotation encoding=\"application/x-tex\">R_{\\text{slope2}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">slope2</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span></th>\n<th><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>R</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">R_0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span></th>\n<th><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>U</mi><mtext>optimal</mtext></msub></mrow><annotation encoding=\"application/x-tex\">U_{\\text{optimal}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">optimal</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span></th>\n<th>Reserve factor</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>$SIS</td>\n<td>50</td>\n<td>50%</td>\n<td>0.1</td>\n<td>0.5</td>\n<td>1%</td>\n<td>60%</td>\n<td>10%</td>\n</tr>\n<tr>\n<td>$BRO</td>\n<td>100</td>\n<td>75%</td>\n<td>0.2</td>\n<td>0.3</td>\n<td>5%</td>\n<td>80%</td>\n<td>20%</td>\n</tr>\n</tbody>\n</table>\n<p>Bob deposits <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>10000</mn></mrow><annotation encoding=\"application/x-tex\">10000</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span></span></span> $BRO, Alice deposits <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>100</mn></mrow><annotation encoding=\"application/x-tex\">100</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span></span></span> $SIS.</p>\n<p>Alice borrows</p>\n<p>22.5 $BRO =</p>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mn>22.5</mn><mo>×</mo><mi mathvariant=\"normal\">$</mi><mn>100</mn><mo>=</mo><mi mathvariant=\"normal\">$</mi><mn>2250</mn><mo>&#x3C;</mo><mn>100</mn><mo>×</mo><mn>50</mn><mo>×</mo><mn>0.5</mn><mo>=</mo><mi mathvariant=\"normal\">$</mi><mn>2500</mn></mrow><annotation encoding=\"application/x-tex\">22.5 \\times \\$100 = \\$2250 &#x3C; 100 \\times 50 \\times 0.5 = \\$2500</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">2</span><span class=\"mord\">2</span><span class=\"mord\">.</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.80556em;vertical-align:-0.05556em;\"></span><span class=\"mord\">$</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.80556em;vertical-align:-0.05556em;\"></span><span class=\"mord\">$</span><span class=\"mord\">2</span><span class=\"mord\">2</span><span class=\"mord\">5</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&#x3C;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">5</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.80556em;vertical-align:-0.05556em;\"></span><span class=\"mord\">$</span><span class=\"mord\">2</span><span class=\"mord\">5</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span></span></span></div>\n<p>which is well within the value of collateral supplied.</p>\n<p>Now,</p>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>U</mi><mrow><mi>B</mi><mi>R</mi><mi>O</mi></mrow></msub><mo>=</mo><mfrac><mn>22.5</mn><mrow><mn>10</mn><mo separator=\"true\">,</mo><mn>000</mn></mrow></mfrac><mo>=</mo><mn>0.00225</mn><mspace linebreak=\"newline\"></mspace><mo>=</mo><mn>0.225</mn><mi mathvariant=\"normal\">%</mi><mo>&#x3C;</mo><msub><mi>U</mi><mrow><mrow><mi>B</mi><mi>R</mi><mi>O</mi></mrow><msub><mrow></mrow><mrow><mi>O</mi><mi>p</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>l</mi></mrow></msub></mrow></msub><mo>=</mo><mn>80</mn><mi mathvariant=\"normal\">%</mi><mspace linebreak=\"newline\"></mspace></mrow><annotation encoding=\"application/x-tex\">U_{BRO} = \\frac{22.5}{10,000} = 0.00225 \\newline = \n0.225\\% &#x3C; U_{{BRO}{_{Optimal}}} = 80\\% \\newline</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">O</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.20188em;vertical-align:-0.8804400000000001em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"mord\">2</span><span class=\"mord\">.</span><span class=\"mord\">5</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8804400000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">2</span><span class=\"mord\">2</span><span class=\"mord\">5</span></span><span class=\"mspace newline\"></span><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.80556em;vertical-align:-0.05556em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">2</span><span class=\"mord\">2</span><span class=\"mord\">5</span><span class=\"mord\">%</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&#x3C;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.03641em;vertical-align:-0.35307999999999995em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">O</span></span><span class=\"mord mtight\"><span class=\"mord mtight\"><span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.3487714285714287em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">m</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.29011428571428566em;\"><span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.35307999999999995em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.80556em;vertical-align:-0.05556em;\"></span><span class=\"mord\">8</span><span class=\"mord\">0</span><span class=\"mord\">%</span></span><span class=\"mspace newline\"></span></span></span></span></div>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>U</mi><mrow><mi>B</mi><mi>R</mi><mi>O</mi></mrow></msub><mo>&#x3C;</mo><mo>=</mo><msub><mi>U</mi><mrow><mrow><mi>B</mi><mi>R</mi><mi>O</mi></mrow><msub><mrow></mrow><mrow><mi>O</mi><mi>p</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>l</mi></mrow></msub></mrow></msub><mo>⇒</mo><mspace linebreak=\"newline\"></mspace><msub><mi>R</mi><msub><mtext>BRO</mtext><mtext>Borrow</mtext></msub></msub><mo>=</mo><msub><mi>R</mi><msub><mtext>BRO</mtext><mtext>0</mtext></msub></msub><mo>+</mo><mfrac><msub><mi>U</mi><mrow><mi>B</mi><mi>R</mi><mi>O</mi></mrow></msub><msub><mi>U</mi><mrow><mrow><mi>B</mi><mi>R</mi><mi>O</mi></mrow><msub><mrow></mrow><mrow><mi>O</mi><mi>p</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>a</mi><mi>l</mi></mrow></msub></mrow></msub></mfrac><mo stretchy=\"false\">(</mo><msub><mi>U</mi><mrow><mrow><mi>B</mi><mi>R</mi><mi>O</mi></mrow><msub><mrow></mrow><mrow><mi>s</mi><mi>l</mi><mi>o</mi><mi>p</mi><mi>e</mi><mn>1</mn></mrow></msub></mrow></msub><mo stretchy=\"false\">)</mo><mspace linebreak=\"newline\"></mspace><mo>=</mo><mn>0.05</mn><mo>+</mo><mfrac><mn>0.00225</mn><mn>0.8</mn></mfrac><mo>×</mo><mn>0.2</mn><mo>=</mo><mn>0.0505625</mn></mrow><annotation encoding=\"application/x-tex\">U_{BRO} &#x3C;= U_{{BRO}{_{Optimal}}} \\rArr \\newline R_{{\\text{BRO}}_\\text{Borrow}} = R_{{\\text{BRO}}_\\text{0}} + \\frac{U_{BRO}}{U_{{BRO}{_{Optimal}}}}(U_{{BRO}{_{slope1}}}) \\newline = 0.05 + \\frac{0.00225}{0.8} \\times 0.2 = 0.0505625</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">O</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&#x3C;</span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.03641em;vertical-align:-0.35307999999999995em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">O</span></span><span class=\"mord mtight\"><span class=\"mord mtight\"><span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.3487714285714287em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">m</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.29011428571428566em;\"><span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.35307999999999995em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">⇒</span></span><span class=\"mspace newline\"></span><span class=\"base\"><span class=\"strut\" style=\"height:0.933635em;vertical-align:-0.250305em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">BRO</span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.3567071428571427em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">Borrow</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.14329285714285717em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.250305em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.93343em;vertical-align:-0.2501em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">BRO</span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.31731428571428577em;\"><span style=\"top:-2.357em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">0</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2501em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.39941em;vertical-align:-1.03908em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.36033em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">O</span></span><span class=\"mord mtight\"><span class=\"mord mtight\"><span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.3487714285714287em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">m</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.29011428571428566em;\"><span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.35307999999999995em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">O</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.03908em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">O</span></span><span class=\"mord mtight\"><span class=\"mord mtight\"><span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.3487714285714287em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">s</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\">p</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.29011428571428566em;\"><span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.35307999999999995em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span><span class=\"mspace newline\"></span><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">0</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.00744em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">8</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">2</span><span class=\"mord\">2</span><span class=\"mord\">5</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">0</span><span class=\"mord\">5</span><span class=\"mord\">0</span><span class=\"mord\">5</span><span class=\"mord\">6</span><span class=\"mord\">2</span><span class=\"mord\">5</span></span></span></span></span></div>\n<p>Now we calculate the supply interest rate, but without considering the reserve factor for now.</p>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>R</mi><mrow><mrow><mi>B</mi><mi>R</mi><mi>O</mi></mrow><msub><mrow></mrow><mtext>Supply (no reserve)</mtext></msub></mrow></msub><mo>=</mo><msub><mi>R</mi><msub><mtext>BRO</mtext><mtext>Borrow</mtext></msub></msub><mo>×</mo><msub><mi>U</mi><mrow><mi>B</mi><mi>R</mi><mi>O</mi></mrow></msub><mo>=</mo><mn>0.0505625</mn><mo>×</mo><mn>0.00225</mn><mo>=</mo><mn>0.000113765625</mn></mrow><annotation encoding=\"application/x-tex\">R_{{BRO}{_{\\text{Supply (no reserve)}}}} = R_{{\\text{BRO}}_\\text{Borrow}} \\times U_{BRO} = 0.0505625 \\times 0.00225 = 0.000113765625</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0919699999999999em;vertical-align:-0.40864em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.55em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">O</span></span><span class=\"mord mtight\"><span class=\"mord mtight\"><span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.3447999999999998em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5357142857142856em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">Supply (no reserve)</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3694857142857143em;\"><span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.40864em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.933635em;vertical-align:-0.250305em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">BRO</span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.3567071428571427em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">Borrow</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.14329285714285717em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.250305em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">O</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">0</span><span class=\"mord\">5</span><span class=\"mord\">0</span><span class=\"mord\">5</span><span class=\"mord\">6</span><span class=\"mord\">2</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">2</span><span class=\"mord\">2</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">3</span><span class=\"mord\">7</span><span class=\"mord\">6</span><span class=\"mord\">5</span><span class=\"mord\">6</span><span class=\"mord\">2</span><span class=\"mord\">5</span></span></span></span></span></div>\n<p>So there we have it:</p>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi>R</mi><msub><mtext>BRO</mtext><mtext>Borrow</mtext></msub></msub><mo>=</mo><mn>0.0505625</mn><mspace linebreak=\"newline\"></mspace><msub><mi>R</mi><mrow><mrow><mi>B</mi><mi>R</mi><mi>O</mi></mrow><msub><mrow></mrow><mtext>Supply (no reserve)</mtext></msub></mrow></msub><mo>=</mo><mn>0.000113765625</mn></mrow><annotation encoding=\"application/x-tex\">R_{{\\text{BRO}}_\\text{Borrow}} = 0.0505625 \\newline\nR_{{BRO}{_{\\text{Supply (no reserve)}}}} = 0.000113765625</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.933635em;vertical-align:-0.250305em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">BRO</span></span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.3567071428571427em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">Borrow</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.14329285714285717em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.250305em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">0</span><span class=\"mord\">5</span><span class=\"mord\">0</span><span class=\"mord\">5</span><span class=\"mord\">6</span><span class=\"mord\">2</span><span class=\"mord\">5</span></span><span class=\"mspace newline\"></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0919699999999999em;vertical-align:-0.40864em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.55em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05017em;\">B</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">O</span></span><span class=\"mord mtight\"><span class=\"mord mtight\"><span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3448em;\"><span style=\"top:-2.3447999999999998em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5357142857142856em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">Supply (no reserve)</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3694857142857143em;\"><span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.40864em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">3</span><span class=\"mord\">7</span><span class=\"mord\">6</span><span class=\"mord\">5</span><span class=\"mord\">6</span><span class=\"mord\">2</span><span class=\"mord\">5</span></span></span></span></span></div>\n<h4 id=\"example-continued-cumulated-liquidity-index--cumulated-borrow-index-calculation\" style=\"position:relative;\">Example (continued): cumulated liquidity index &#x26; cumulated borrow index calculation<a href=\"#example-continued-cumulated-liquidity-index--cumulated-borrow-index-calculation\" aria-label=\"example continued cumulated liquidity index  cumulated borrow index calculation permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h4>\n<p>And let’s say:</p>\n<ul>\n<li>100 seconds have elapsed, starting from timestamp 0</li>\n<li>no cumulated liquidity index and cumulated borrow index were calculated before, making them 1 respectively by default</li>\n</ul>\n<p>Then you can calculate them as follows:</p>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mtext>Cumulated Liquidity Index</mtext><mi>n</mi></msub><mo>=</mo><mspace linebreak=\"newline\"></mspace><msub><mtext>Cumulated Liquidity Index</mtext><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>×</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>+</mo><mi>r</mi><mo>×</mo><mi>t</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mspace linebreak=\"newline\"></mspace><mn>1</mn><mo>×</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>+</mo><mo stretchy=\"false\">(</mo><mn>0.000113765625</mn><mo>×</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>−</mo><mn>0.2</mn><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo><mo>×</mo><mfrac><mn>100</mn><mrow><mn>365</mn><mo>×</mo><mn>86400</mn></mrow></mfrac><mo stretchy=\"false\">)</mo><mo>=</mo><mn>1.000000000288598744292237442</mn><mspace linebreak=\"newline\"></mspace></mrow><annotation encoding=\"application/x-tex\">\\text{Cumulated Liquidity Index}_n = \\newline \n\\text{Cumulated Liquidity Index}_{n-1} \\times (1 + r \\times t) = \\newline\n1 \\times (1 + (0.000113765625 \\times (1 - 0.2)) \\times \\frac{100}{365 \\times 86400}) = 1.000000000288598744292237442\n\\newline</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.93858em;vertical-align:-0.24414em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">Cumulated Liquidity Index</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.057252em;\"><span style=\"top:-2.4558600000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.24414em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span></span><span class=\"mspace newline\"></span><span class=\"base\"><span class=\"strut\" style=\"height:0.9969109999999999em;vertical-align:-0.302471em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">Cumulated Liquidity Index</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.20696799999999999em;\"><span style=\"top:-2.45586em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.302471em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.66666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span></span><span class=\"mspace newline\"></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">3</span><span class=\"mord\">7</span><span class=\"mord\">6</span><span class=\"mord\">5</span><span class=\"mord\">6</span><span class=\"mord\">2</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">2</span><span class=\"mclose\">)</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.09077em;vertical-align:-0.7693300000000001em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">3</span><span class=\"mord\">6</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\">8</span><span class=\"mord\">6</span><span class=\"mord\">4</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7693300000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">.</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">2</span><span class=\"mord\">8</span><span class=\"mord\">8</span><span class=\"mord\">5</span><span class=\"mord\">9</span><span class=\"mord\">8</span><span class=\"mord\">7</span><span class=\"mord\">4</span><span class=\"mord\">4</span><span class=\"mord\">2</span><span class=\"mord\">9</span><span class=\"mord\">2</span><span class=\"mord\">2</span><span class=\"mord\">3</span><span class=\"mord\">7</span><span class=\"mord\">4</span><span class=\"mord\">4</span><span class=\"mord\">2</span></span><span class=\"mspace newline\"></span></span></span></span></div>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mtext>Cumulated Borrow Index</mtext><mi>n</mi></msub><mo>=</mo><mspace linebreak=\"newline\"></mspace><msub><mtext>Cumulated Borrow Index</mtext><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>×</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>+</mo><mi>r</mi><mo>×</mo><mi>t</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mspace linebreak=\"newline\"></mspace><mn>1</mn><mo>×</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>+</mo><mn>0.0505625</mn><mo>×</mo><mfrac><mn>100</mn><mrow><mn>365</mn><mo>×</mo><mn>86400</mn></mrow></mfrac><mo stretchy=\"false\">)</mo><mo>=</mo><mn>1.000000160332635717909690512</mn></mrow><annotation encoding=\"application/x-tex\">\\text{Cumulated Borrow Index}_n = \\newline\n\\text{Cumulated Borrow Index}_{n-1} \\times (1 + r \\times t) = \\newline\n1 \\times (1 + 0.0505625 \\times \\frac{100}{365 \\times 86400}) = 1.000000160332635717909690512</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.84444em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">Cumulated Borrow Index</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span></span><span class=\"mspace newline\"></span><span class=\"base\"><span class=\"strut\" style=\"height:0.902771em;vertical-align:-0.208331em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">Cumulated Borrow Index</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.301108em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.66666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span></span><span class=\"mspace newline\"></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">0</span><span class=\"mord\">5</span><span class=\"mord\">0</span><span class=\"mord\">5</span><span class=\"mord\">6</span><span class=\"mord\">2</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.09077em;vertical-align:-0.7693300000000001em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">3</span><span class=\"mord\">6</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\">8</span><span class=\"mord\">6</span><span class=\"mord\">4</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7693300000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">.</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">6</span><span class=\"mord\">0</span><span class=\"mord\">3</span><span class=\"mord\">3</span><span class=\"mord\">2</span><span class=\"mord\">6</span><span class=\"mord\">3</span><span class=\"mord\">5</span><span class=\"mord\">7</span><span class=\"mord\">1</span><span class=\"mord\">7</span><span class=\"mord\">9</span><span class=\"mord\">0</span><span class=\"mord\">9</span><span class=\"mord\">6</span><span class=\"mord\">9</span><span class=\"mord\">0</span><span class=\"mord\">5</span><span class=\"mord\">1</span><span class=\"mord\">2</span></span></span></span></span></div>\n<p>Instead of factoring the reserve factor into the lending rate, we instead do it when we calculate it in the cumulated liquidity index.</p>\n<p><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.61508em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span></span> is calculated as 100 seconds divided by the number of seconds per year (without caring about leap years).</p>\n<p>Other than this, the calculation above should be straightforward.</p>\n<h2 id=\"liquidation\" style=\"position:relative;\">Liquidation<a href=\"#liquidation\" aria-label=\"liquidation permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>A few more terms need to be defined to be able to understand liquidation.</p>\n<p><strong>Health factor</strong>. <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>Health factor</mtext><mo>=</mo><mfrac><mrow><mo>∑</mo><mrow><mi>C</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>a</mi><msub><mi>l</mi><mi>i</mi></msub><mo>×</mo><msub><mtext>USD value of Collateral</mtext><mi>i</mi></msub><mo>×</mo><msub><mtext>Collateral factor</mtext><mi>i</mi></msub></mrow></mrow><mrow><mo>∑</mo><mrow><mi>L</mi><mi>i</mi><mi>a</mi><mi>b</mi><mi>i</mi><mi>l</mi><mi>i</mi><mi>t</mi><msub><mi>y</mi><mi>i</mi></msub><mo>×</mo><msub><mtext>USD value of Liability</mtext><mi>i</mi></msub></mrow></mrow></mfrac></mrow><annotation encoding=\"application/x-tex\">\\text{Health factor} = \\frac{\\sum{Collateral_i \\times \\text{USD value of Collateral}_i \\times \\text{Collateral factor}_i}}{\\sum{Liability_i \\times \\text{USD value of Liability}_i}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord text\"><span class=\"mord\">Health factor</span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.5411149999999998em;vertical-align:-0.5311079999999999em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0100069999999999em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mop op-symbol small-op mtight\" style=\"position:relative;top:-0.0000050000000000050004em;\">∑</span><span class=\"mspace mtight\" style=\"margin-right:0.19516666666666668em;\"></span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">L</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">b</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3280857142857143em;\"><span style=\"top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span><span class=\"mbin mtight\">×</span><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">USD value of Liability</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.20521714285714282em;\"><span style=\"top:-2.2341314285714287em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.26586857142857145em;\"><span></span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.485007em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mop op-symbol small-op mtight\" style=\"position:relative;top:-0.0000050000000000050004em;\">∑</span><span class=\"mspace mtight\" style=\"margin-right:0.19516666666666668em;\"></span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal mtight\">o</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mathnormal mtight\">t</span><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal mtight\">a</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3280857142857143em;\"><span style=\"top:-2.357em;margin-left:-0.01968em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span><span class=\"mbin mtight\">×</span><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">USD value of Collateral</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3280857142857143em;\"><span style=\"top:-2.357em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span><span class=\"mbin mtight\">×</span><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">Collateral factor</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3280857142857143em;\"><span style=\"top:-2.357em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.143em;\"><span></span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.5311079999999999em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span>. It denotes the status of user’s position. If the health factor is lower than 1, the position may be liquidated, because that would mean the value of collaterals is not enough to back the value of borrowings.</p>\n<p><strong>Liquidation bonus</strong> (or penalty, for debtors). Additional % applied on the collateral deposited by the debtor, which in turn is received by the liquidator after the repayment. This is to incentivize liquidators to liquidate.</p>\n<p>Potential liquidators will be monitoring the market closely and frequently, and try to call <code class=\"language-text\">liquidate()</code> earlier than their competitors with suitable amount of gas fee that might get their transaction get through earlier than others. Once the transaction gets through, the debtor’s position will be liquidated and the corresponding amount of collateral in USD plus the liquidation bonus will be paid back to the liquidator. Liquidators are only allowed to repay no more than the amount that will bring the borrower’s Health Factor back to 1.</p>\n<p>Liquidation is essential to the healthy operation of a lending protocol; it removes unhealthy, undercollateralized positions to keep it healthy.</p>\n<h1 id=\"technical-review\" style=\"position:relative;\">Technical review<a href=\"#technical-review\" aria-label=\"technical review permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<h2 id=\"deposit-1\" style=\"position:relative;\">Deposit<a href=\"#deposit-1\" aria-label=\"deposit 1 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>All typical user interactions will be done at <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market.cairo\">market.cairo</a> file.</p>\n<p>The <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market.cairo#L230-L232\">deposit</a> function in <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market.cairo\">market.cairo</a> will call <code class=\"language-text\">deposit</code> function from <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/external.cairo#L41C1-L45C2\">market/external.cairo</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token comment\">// deposit in market.cairo</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">deposit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">:</span> felt252<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token namespace\">external<span class=\"token punctuation\">::</span></span><span class=\"token function\">deposit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Again, <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/external.cairo#L41C1-L45C2\">that</a> will call <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/internal.cairo#L67-L108\"><code class=\"language-text\">internal::deposit</code> from <code class=\"language-text\">market/internal.cairo</code></a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token comment\">// deposit in market/external.cairo</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">deposit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">:</span> felt252<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token namespace\">reentrancy_guard<span class=\"token punctuation\">::</span></span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token namespace\">internal<span class=\"token punctuation\">::</span></span><span class=\"token function\">deposit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token namespace\">reentrancy_guard<span class=\"token punctuation\">::</span></span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token comment\">// deposit in market/internal.cairo</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">deposit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">:</span> felt252<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">.</span><span class=\"token function\">is_non_zero</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token namespace\">errors<span class=\"token punctuation\">::</span></span><span class=\"token constant\">ZERO_AMOUNT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> caller <span class=\"token operator\">=</span> <span class=\"token function\">get_caller_address</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> this_address <span class=\"token operator\">=</span> <span class=\"token function\">get_contract_address</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> <span class=\"token class-name\">UpdatedAccumulators</span><span class=\"token punctuation\">{</span>debt_accumulator<span class=\"token punctuation\">:</span> updated_debt_accumulator<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">..</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">update_accumulators</span><span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">assert_reserve_enabled</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> z_token_address <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>reserves<span class=\"token punctuation\">.</span><span class=\"token function\">read_z_token_address</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Updates interest rate</span>\n    <span class=\"token function\">update_rates_and_raw_total_debt</span><span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span>\n        token<span class=\"token punctuation\">,</span> <span class=\"token comment\">// token</span>\n        updated_debt_accumulator<span class=\"token punctuation\">,</span> <span class=\"token comment\">// updated_debt_accumulator</span>\n        <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// is_delta_reserve_balance_negative</span>\n        amount<span class=\"token punctuation\">,</span> <span class=\"token comment\">// abs_delta_reserve_balance</span>\n        <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// is_delta_raw_total_debt_negative</span>\n        <span class=\"token number\">0</span> <span class=\"token comment\">// abs_delta_raw_total_debt</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">self</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span>\n            <span class=\"token namespace\">contract<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Event</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Deposit</span><span class=\"token punctuation\">(</span>\n                <span class=\"token namespace\">contract<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Deposit</span> <span class=\"token punctuation\">{</span> user<span class=\"token punctuation\">:</span> caller<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">:</span> token<span class=\"token punctuation\">,</span> face_amount<span class=\"token punctuation\">:</span> amount <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Takes token from user</span>\n\n    <span class=\"token keyword\">let</span> amount_u256<span class=\"token punctuation\">:</span> u256 <span class=\"token operator\">=</span> amount<span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> transfer_success <span class=\"token operator\">=</span> <span class=\"token class-name\">IERC20Dispatcher</span> <span class=\"token punctuation\">{</span>\n        contract_address<span class=\"token punctuation\">:</span> token<span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">transferFrom</span><span class=\"token punctuation\">(</span>caller<span class=\"token punctuation\">,</span> this_address<span class=\"token punctuation\">,</span> amount_u256<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>transfer_success<span class=\"token punctuation\">,</span> <span class=\"token namespace\">errors<span class=\"token punctuation\">::</span></span><span class=\"token constant\">TRANSFERFROM_FAILED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Mints ZToken to user</span>\n    <span class=\"token class-name\">IZTokenDispatcher</span> <span class=\"token punctuation\">{</span> contract_address<span class=\"token punctuation\">:</span> z_token_address <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">mint</span><span class=\"token punctuation\">(</span>caller<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The first thing that this <code class=\"language-text\">deposit</code> function does is to call <code class=\"language-text\">update_accumulators</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">update_accumulators</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">UpdatedAccumulators</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> block_timestamp<span class=\"token punctuation\">:</span> felt252 <span class=\"token operator\">=</span> <span class=\"token function\">get_block_timestamp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> updated_lending_accumulator <span class=\"token operator\">=</span> <span class=\"token namespace\">view<span class=\"token punctuation\">::</span></span><span class=\"token function\">get_lending_accumulator</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> updated_debt_accumulator <span class=\"token operator\">=</span> <span class=\"token namespace\">view<span class=\"token punctuation\">::</span></span><span class=\"token function\">get_debt_accumulator</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">self</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span>\n            <span class=\"token namespace\">contract<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Event</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">AccumulatorsSync</span><span class=\"token punctuation\">(</span>\n                <span class=\"token namespace\">contract<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">AccumulatorsSync</span> <span class=\"token punctuation\">{</span>\n                    token<span class=\"token punctuation\">,</span>\n                    lending_accumulator<span class=\"token punctuation\">:</span> updated_lending_accumulator<span class=\"token punctuation\">,</span>\n                    debt_accumulator<span class=\"token punctuation\">:</span> updated_debt_accumulator\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// It's okay to call this function here as the updated accumulators haven't been written into</span>\n    <span class=\"token comment\">// storage yet</span>\n    <span class=\"token keyword\">let</span> amount_to_treasury <span class=\"token operator\">=</span> <span class=\"token namespace\">view<span class=\"token punctuation\">::</span></span><span class=\"token function\">get_pending_treasury_amount</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// No need to check reserve existence since it's done in `get_lending_accumulator` and</span>\n    <span class=\"token comment\">// `get_debt_accumulator`</span>\n    <span class=\"token keyword\">let</span> z_token_address <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>reserves<span class=\"token punctuation\">.</span><span class=\"token function\">read_z_token_address</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">self</span>\n        <span class=\"token punctuation\">.</span>reserves\n        <span class=\"token punctuation\">.</span><span class=\"token function\">write_accumulators</span><span class=\"token punctuation\">(</span>\n            token<span class=\"token punctuation\">,</span> block_timestamp<span class=\"token punctuation\">,</span> updated_lending_accumulator<span class=\"token punctuation\">,</span> updated_debt_accumulator\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// No need to check whether treasury address is zero as amount would be zero anyways</span>\n    <span class=\"token keyword\">if</span> amount_to_treasury<span class=\"token punctuation\">.</span><span class=\"token function\">is_non_zero</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> treasury_addr <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>treasury<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">IZTokenDispatcher</span> <span class=\"token punctuation\">{</span>\n            contract_address<span class=\"token punctuation\">:</span> z_token_address\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">mint</span><span class=\"token punctuation\">(</span>treasury_addr<span class=\"token punctuation\">,</span> amount_to_treasury<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token class-name\">UpdatedAccumulators</span> <span class=\"token punctuation\">{</span>\n        lending_accumulator<span class=\"token punctuation\">:</span> updated_lending_accumulator<span class=\"token punctuation\">,</span> debt_accumulator<span class=\"token punctuation\">:</span> updated_debt_accumulator\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And this respectively calls accumulators for debt and lending:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">get_lending_accumulator</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">@</span><span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> felt252 <span class=\"token punctuation\">{</span>\n    <span class=\"token namespace\">internal<span class=\"token punctuation\">::</span></span><span class=\"token function\">assert_reserve_enabled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> reserve <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>reserves<span class=\"token punctuation\">.</span><span class=\"token function\">read_for_get_lending_accumulator</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> block_timestamp<span class=\"token punctuation\">:</span> felt252 <span class=\"token operator\">=</span> <span class=\"token function\">get_block_timestamp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> reserve<span class=\"token punctuation\">.</span>last_update_timestamp <span class=\"token operator\">==</span> block_timestamp <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Accumulator already updated on the same block</span>\n        reserve<span class=\"token punctuation\">.</span>lending_accumulator\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Apply simple interest</span>\n        <span class=\"token keyword\">let</span> time_diff <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>block_timestamp<span class=\"token punctuation\">,</span> reserve<span class=\"token punctuation\">.</span>last_update_timestamp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Treats reserve factor as zero if treasury address is not set</span>\n        <span class=\"token keyword\">let</span> treasury_addr <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>treasury<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> effective_reserve_factor <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> treasury_addr<span class=\"token punctuation\">.</span><span class=\"token function\">is_zero</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token number\">0</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            reserve<span class=\"token punctuation\">.</span>reserve_factor\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> one_minus_reserve_factor <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>\n            <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token constant\">SCALE</span><span class=\"token punctuation\">,</span> effective_reserve_factor\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// New accumulator</span>\n        <span class=\"token comment\">// (current_lending_rate * (1 - reserve_factor) * time_diff / SECONDS_PER_YEAR + 1) * accumulator</span>\n        <span class=\"token keyword\">let</span> temp_1 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>reserve<span class=\"token punctuation\">.</span>current_lending_rate<span class=\"token punctuation\">,</span> time_diff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> temp_2 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>temp_1<span class=\"token punctuation\">,</span> one_minus_reserve_factor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> temp_3 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">div</span><span class=\"token punctuation\">(</span>temp_2<span class=\"token punctuation\">,</span> <span class=\"token constant\">SECONDS_PER_YEAR</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> temp_4 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">div</span><span class=\"token punctuation\">(</span>temp_3<span class=\"token punctuation\">,</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token constant\">SCALE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> temp_5 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>temp_4<span class=\"token punctuation\">,</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token constant\">SCALE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> latest_accumulator <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>temp_5<span class=\"token punctuation\">,</span> reserve<span class=\"token punctuation\">.</span>lending_accumulator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        latest_accumulator\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">get_debt_accumulator</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">@</span><span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> felt252 <span class=\"token punctuation\">{</span>\n    <span class=\"token namespace\">internal<span class=\"token punctuation\">::</span></span><span class=\"token function\">assert_reserve_enabled</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> reserve <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>reserves<span class=\"token punctuation\">.</span><span class=\"token function\">read_for_get_debt_accumulator</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> block_timestamp<span class=\"token punctuation\">:</span> felt252 <span class=\"token operator\">=</span> <span class=\"token function\">get_block_timestamp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>reserve<span class=\"token punctuation\">.</span>last_update_timestamp <span class=\"token operator\">==</span> block_timestamp<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Accumulator already updated on the same block</span>\n        reserve<span class=\"token punctuation\">.</span>debt_accumulator\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Apply simple interest</span>\n        <span class=\"token keyword\">let</span> time_diff <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>block_timestamp<span class=\"token punctuation\">,</span> reserve<span class=\"token punctuation\">.</span>last_update_timestamp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// (current_borrowing_rate * time_diff / SECONDS_PER_YEAR + 1) * accumulator</span>\n        <span class=\"token keyword\">let</span> temp_1 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>reserve<span class=\"token punctuation\">.</span>current_borrowing_rate<span class=\"token punctuation\">,</span> time_diff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> temp_2 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">div</span><span class=\"token punctuation\">(</span>temp_1<span class=\"token punctuation\">,</span> <span class=\"token constant\">SECONDS_PER_YEAR</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> temp_3 <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>temp_2<span class=\"token punctuation\">,</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token constant\">SCALE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> latest_accumulator <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>temp_3<span class=\"token punctuation\">,</span> reserve<span class=\"token punctuation\">.</span>debt_accumulator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        latest_accumulator\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We already discussed in depth what an accumulator is and why it needs to be used. They need to be updated every single time the corresponding interest rate needs to change.</p>\n<p>After updating the accumulators, <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/internal.cairo#L815\">amount_to_treasury</a> is calculated and that amount is sent to the treasury, in the form of zToken. Remember that zToken is redeemable at 1:1 rate with the underlying asset, so it’s the same as sending real token to the reasury.</p>\n<p>Next in <code class=\"language-text\">internal::deposit</code>, <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/internal.cairo#L81\">update_rates_and_raw_total_debt</a> is called. This function does two things as it name suggests; but it will only update the rate for <code class=\"language-text\">deposit</code> operation, as you can tell from the argument of <code class=\"language-text\">0</code> for <code class=\"language-text\">abs_delta_raw_total_debt</code>.</p>\n<p>However if <code class=\"language-text\">reserve.last_update_timestamp</code> is not the current block timestamp, the debt accumulator would still get updated and will affect the interest rate calculated inside <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/internal.cairo#L81\">update_rates_and_raw_total_debt</a>, because the ‘scaled’ debt (that is, principal value of debt multiplied by the latest debt accumulator) would be slightly larger than the one calculated at the previous block timestamp.</p>\n<p><a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/internal.cairo#L840\">Here is <code class=\"language-text\">update_rates_and_raw_total_debt</code></a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">update_rates_and_raw_total_debt</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span>\n    token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">,</span>\n    updated_debt_accumulator<span class=\"token punctuation\">:</span> felt252<span class=\"token punctuation\">,</span>\n    is_delta_reserve_balance_negative<span class=\"token punctuation\">:</span> <span class=\"token keyword\">bool</span><span class=\"token punctuation\">,</span>\n    abs_delta_reserve_balance<span class=\"token punctuation\">:</span> felt252<span class=\"token punctuation\">,</span>\n    is_delta_raw_total_debt_negative<span class=\"token punctuation\">:</span> <span class=\"token keyword\">bool</span><span class=\"token punctuation\">,</span>\n    abs_delta_raw_total_debt<span class=\"token punctuation\">:</span> felt252<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> this_address <span class=\"token operator\">=</span> <span class=\"token function\">get_contract_address</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> <span class=\"token class-name\">StorageBatch1</span><span class=\"token punctuation\">{</span>\n        interest_rate_model<span class=\"token punctuation\">,</span> raw_total_debt<span class=\"token punctuation\">:</span> raw_total_debt_before <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span>\n        <span class=\"token punctuation\">.</span>reserves\n        <span class=\"token punctuation\">.</span><span class=\"token function\">read_interest_rate_model_and_raw_total_debt</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Makes sure reserve exists</span>\n    <span class=\"token comment\">// (the caller must check it's enabled if needed since it's not validated here)</span>\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>interest_rate_model<span class=\"token punctuation\">.</span><span class=\"token function\">is_non_zero</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token namespace\">errors<span class=\"token punctuation\">::</span></span><span class=\"token constant\">RESERVE_NOT_FOUND</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> reserve_balance_before<span class=\"token punctuation\">:</span> felt252 <span class=\"token operator\">=</span> <span class=\"token class-name\">IERC20Dispatcher</span> <span class=\"token punctuation\">{</span>\n        contract_address<span class=\"token punctuation\">:</span> token\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">balanceOf</span><span class=\"token punctuation\">(</span>this_address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">try_into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token namespace\">errors<span class=\"token punctuation\">::</span></span><span class=\"token constant\">BALANCE_OVERFLOW</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> reserve_balance_after <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> is_delta_reserve_balance_negative <span class=\"token punctuation\">{</span>\n        <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>reserve_balance_before<span class=\"token punctuation\">,</span> abs_delta_reserve_balance<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>reserve_balance_before<span class=\"token punctuation\">,</span> abs_delta_reserve_balance<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> raw_total_debt_after <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> is_delta_raw_total_debt_negative <span class=\"token punctuation\">{</span>\n        <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>raw_total_debt_before<span class=\"token punctuation\">,</span> abs_delta_raw_total_debt<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>raw_total_debt_before<span class=\"token punctuation\">,</span> abs_delta_raw_total_debt<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> scaled_up_total_debt_after <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>\n        raw_total_debt_after<span class=\"token punctuation\">,</span> updated_debt_accumulator\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> <span class=\"token class-name\">ModelRates</span><span class=\"token punctuation\">{</span>lending_rate<span class=\"token punctuation\">:</span> new_lending_rate<span class=\"token punctuation\">,</span> borrowing_rate<span class=\"token punctuation\">:</span> new_borrowing_rate <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span>\n        <span class=\"token class-name\">IInterestRateModelDispatcher</span> <span class=\"token punctuation\">{</span>\n        contract_address<span class=\"token punctuation\">:</span> interest_rate_model\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">get_interest_rates</span><span class=\"token punctuation\">(</span>reserve_balance_after<span class=\"token punctuation\">,</span> scaled_up_total_debt_after<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Writes to storage</span>\n    <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>reserves<span class=\"token punctuation\">.</span><span class=\"token function\">write_rates</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> new_lending_rate<span class=\"token punctuation\">,</span> new_borrowing_rate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> raw_total_debt_before <span class=\"token operator\">!=</span> raw_total_debt_after <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>reserves<span class=\"token punctuation\">.</span><span class=\"token function\">write_raw_total_debt</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> raw_total_debt_after<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">self</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span>\n            <span class=\"token namespace\">contract<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Event</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">InterestRatesSync</span><span class=\"token punctuation\">(</span>\n                <span class=\"token namespace\">contract<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">InterestRatesSync</span> <span class=\"token punctuation\">{</span>\n                    token<span class=\"token punctuation\">,</span> lending_rate<span class=\"token punctuation\">:</span> new_lending_rate<span class=\"token punctuation\">,</span> borrowing_rate<span class=\"token punctuation\">:</span> new_borrowing_rate\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>It reads existing <code class=\"language-text\">interest_rate_model</code>, <code class=\"language-text\">raw_total_debt: raw_total_debt_before</code> from the storage. And then runs calculations to get parameters for <code class=\"language-text\">IInterestRateModelDispatcher.get_interest_rates</code>.</p>\n<p>After that, the newly calculated interest rates and debt are updated.</p>\n<p>Finally, <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/internal.cairo#L103\"><code class=\"language-text\">transferFrom</code> of the underlying ERC20 token is called</a> in <code class=\"language-text\">internal::deposit</code> function. This is where the actual transfer happens.</p>\n<p>Lastly, <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/internal.cairo#L107\">the interest bearing zToken of the exact same deposit amount for that specific ERC20 token is minted</a> back to the user, so they can track the sum of their principal and interest at any time.</p>\n<h2 id=\"withdraw\" style=\"position:relative;\">Withdraw<a href=\"#withdraw\" aria-label=\"withdraw permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Everything that is meant to be accessed on zklend frontend is defined in <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/external.cairo\"><code class=\"language-text\">src/market/external.cairo</code></a>, just like <code class=\"language-text\">deposit</code>. So is <code class=\"language-text\">withdraw</code>, and it again calls <code class=\"language-text\">internal::withdraw</code>.</p>\n<p><a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/internal.cairo#L110\"><code class=\"language-text\">withdraw</code> in <code class=\"language-text\">src/market/internal.cairo</code></a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">withdraw</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">:</span> felt252<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">.</span><span class=\"token function\">is_non_zero</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token namespace\">errors<span class=\"token punctuation\">::</span></span><span class=\"token constant\">ZERO_AMOUNT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> caller <span class=\"token operator\">=</span> <span class=\"token function\">get_caller_address</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">withdraw_internal</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> caller<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>So the real meat must be in <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/internal.cairo#L659\"><code class=\"language-text\">withdraw_internal</code></a>.</p>\n<p><a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/internal.cairo#L659\"><code class=\"language-text\">withdraw_internal</code> in <code class=\"language-text\">src/market/internal.cairo</code></a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">withdraw_internal</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">:</span> felt252\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> <span class=\"token class-name\">UpdatedAccumulators</span><span class=\"token punctuation\">{</span>debt_accumulator<span class=\"token punctuation\">:</span> updated_debt_accumulator<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">..</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">update_accumulators</span><span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">assert_reserve_enabled</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> z_token_address <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>reserves<span class=\"token punctuation\">.</span><span class=\"token function\">read_z_token_address</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// NOTE: it's fine to call out to external contract here before state update since it's trusted</span>\n    <span class=\"token keyword\">let</span> amount_burnt <span class=\"token operator\">=</span> <span class=\"token function\">burn_z_token_internal</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> z_token_address<span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Updates interest rate</span>\n    <span class=\"token function\">update_rates_and_raw_total_debt</span><span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span>\n        token<span class=\"token punctuation\">,</span> <span class=\"token comment\">// token</span>\n        updated_debt_accumulator<span class=\"token punctuation\">,</span> <span class=\"token comment\">// updated_debt_accumulator</span>\n        <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// is_delta_reserve_balance_negative</span>\n        amount_burnt<span class=\"token punctuation\">,</span> <span class=\"token comment\">// abs_delta_reserve_balance</span>\n        <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// is_delta_raw_total_debt_negative</span>\n        <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// abs_delta_raw_total_debt</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">self</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span>\n            <span class=\"token namespace\">contract<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Event</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Withdrawal</span><span class=\"token punctuation\">(</span>\n                <span class=\"token namespace\">contract<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Withdrawal</span> <span class=\"token punctuation\">{</span> user<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> face_amount<span class=\"token punctuation\">:</span> amount_burnt <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Gives underlying tokens to user</span>\n    <span class=\"token keyword\">let</span> amount_burnt<span class=\"token punctuation\">:</span> u256 <span class=\"token operator\">=</span> amount_burnt<span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> transfer_success <span class=\"token operator\">=</span> <span class=\"token class-name\">IERC20Dispatcher</span> <span class=\"token punctuation\">{</span>\n        contract_address<span class=\"token punctuation\">:</span> token\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> amount_burnt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>transfer_success<span class=\"token punctuation\">,</span> <span class=\"token namespace\">errors<span class=\"token punctuation\">::</span></span><span class=\"token constant\">TRANSFER_FAILED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// It's easier to post-check collateralization factor, at the cost of making failed</span>\n    <span class=\"token comment\">// transactions more expensive.</span>\n    <span class=\"token keyword\">let</span> is_asset_used_as_collateral <span class=\"token operator\">=</span> <span class=\"token function\">is_used_as_collateral</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// No need to check if the asset is not used as collateral at all</span>\n    <span class=\"token keyword\">if</span> is_asset_used_as_collateral <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">assert_not_undercollateralized</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Basically, the exact opposite of <code class=\"language-text\">internal::deposit</code>.</p>\n<p>The first bit is the same; It starts off by calling <code class=\"language-text\">update_accumulators</code> to get <code class=\"language-text\">updated_debt_accumulator</code> which will be used as an argument to <code class=\"language-text\">update_rates_and_raw_total_debt</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> <span class=\"token class-name\">UpdatedAccumulators</span><span class=\"token punctuation\">{</span>debt_accumulator<span class=\"token punctuation\">:</span> updated_debt_accumulator<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">..</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">update_accumulators</span><span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Then, the corresponding amount of zToken is burnt:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> z_token_address <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>reserves<span class=\"token punctuation\">.</span><span class=\"token function\">read_z_token_address</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// NOTE: it's fine to call out to external contract here before state update since it's trusted</span>\n<span class=\"token keyword\">let</span> amount_burnt <span class=\"token operator\">=</span> <span class=\"token function\">burn_z_token_internal</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> z_token_address<span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>If <code class=\"language-text\">amount</code> is not zero, zToken’s <code class=\"language-text\">external::burn</code> will be called:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">burn</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">:</span> felt252<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token namespace\">internal<span class=\"token punctuation\">::</span></span><span class=\"token function\">only_market</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> accumulator <span class=\"token operator\">=</span> <span class=\"token namespace\">internal<span class=\"token punctuation\">::</span></span><span class=\"token function\">get_accumulator</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> scaled_down_amount <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">div</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">,</span> accumulator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>scaled_down_amount<span class=\"token punctuation\">.</span><span class=\"token function\">is_non_zero</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token namespace\">errors<span class=\"token punctuation\">::</span></span><span class=\"token constant\">INVALID_BURN_AMOUNT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> raw_balance_before <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>raw_balances<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> raw_balance_after <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>raw_balance_before<span class=\"token punctuation\">,</span> scaled_down_amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>raw_balances<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> raw_balance_after<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> raw_supply_before <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>raw_total_supply<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> raw_supply_after <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>raw_supply_before<span class=\"token punctuation\">,</span> scaled_down_amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>raw_total_supply<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>raw_supply_after<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> amount<span class=\"token punctuation\">:</span> u256 <span class=\"token operator\">=</span> amount<span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">self</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span>\n            <span class=\"token namespace\">contract<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Event</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Transfer</span><span class=\"token punctuation\">(</span>\n                <span class=\"token namespace\">contract<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Transfer</span> <span class=\"token punctuation\">{</span> from<span class=\"token punctuation\">:</span> user<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">:</span> <span class=\"token function\">contract_address_const</span><span class=\"token punctuation\">::</span><span class=\"token operator\">&lt;</span><span class=\"token number\">0</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">:</span> amount <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">let accumulator = internal::get_accumulator(@self);</code> gets the current lending accumulator so it can be used for further calculations. Remember, zToken has a dynamic balance due to the accumulator.</p>\n<p>So why <code class=\"language-text\">let scaled_down_amount = safe_decimal_math::div(amount, accumulator);</code>? The reason is that the amount that the user requests to withdraw, passed down as <code class=\"language-text\">amount: felt252</code> argument, already assumes that the amount has the interest index (the accumulator) factored in.</p>\n<p>Let’s go back to the example presented before.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ac41ac3eb3ba82837e8a6dc41c669f61/3cb0f/aDai-balance-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 169.59459459459458%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAiCAYAAABfqvm9AAAACXBIWXMAABYlAAAWJQFJUiTwAAAFrElEQVRIx42WyW4cxxnH5ymMiOSwl6quXmemZ985G2cjOaTIWJYpWrZoxTIMQ17iRZGtXJwcnFNyCBAg5yDLA/iWg18ir5LrL6gaTmsoOUgOf1RVV33/+vbqnAoSXC9EeCFSxei1hvQT8irGdv0MrgyQfoy3OaNipKdlCnh+YsbcviNxPcXPdvO8sbOLI30cLyJNfJ72y6xO3+Rodcrq7gWH8yWlSg3pR1iuR7PTozsdmXlSKiNUQM71AvK2YCdvsWc5CBUi/IgojJjHFbqDCf3hhIPhhEq9RZCUjJb6XJiUiKplM/ejgrko50iFLTxsoXCEMqNeW47kjuOym99nN2+xu7dP3nKwHBfbFeac5UosW97MPTRXztUm3oLC8QKcqIIb13CT+tZYxUnqOFE5O78tr+c5reZthMi4ijt5hH36Jfbqc9zZB9jHn2CffEb+8nvcw0d4QczrshE547Mb6A/mJhVixQ2cYgen0MLWY7GNU+pipwOssJJppWW2OXJC6Q9RtlGq1IkKJar1BoVialCu1IgLRaI4oVAo0mx3Sat1iuUaOqhr2RsNt9XVmx9+9DEP37vm2fNv+fpX3/D8219z/fgJz56/4LNffsmzb17w7qPHfP7FV4wOZxlhZvKrhDo9JrMFB6ND+sMxi6MVo8mMeqtLfzA2SCt1huMpjXYXR/4E4dp/MTKITfgt4bNjS1q9ARf37nN+722myxPeurzCCxNsGdykSYAIiwgte5O/uU0whBAI1zWknqeQ+Tso5RMmKaHv4/u+SWqz5zp4WiMV4OXvIF3XkGnStcmej+xfICYPkdLDbs6xn/wZtzHDFRJn9A6ie4arBRszxOwxIkgQxSY77/8Ja/QAqRXyY00Y4ngh4fXvCZ7+1TSAnQe/I/wRrKvvzTr89O/4139YE/78OeHXP+CWOtiThxR/hJ0vfkDkd5C6Oehw+0GEai/wD87x/QCvNkRc/RavOjAae4N7yNYSKSWqMcEbPzCuCctNSu/9hnh0Yc4ZH+rI6nxqNpo06nWTh6VSymo2ppSuC7/TblGr1oxAtVrjoN8jTIp0ewcsJgOmhxP8qLhO7CzTvQDh+WuoCNd0lPWejrqzlcDaV1oRHel9sxduR3kdLRFXEIUGIq5mNb1pS61O32j+sipCklKFSq1JtdEmiApZ6eY2Hdgt97F75zjtY0SUZomuBXVydw9GmZa6htu9AYvjFSen57cuy7lRym6pjZ32sYpd8oUO++UBbtrNtFwn8ctGsLlszxLsWm7WD40Pg7DEuHdOUkxNSbU6PdJKDVeqW11om2wzr7c6xh1ptWFGFSbkBp1z/vHi3yyH77NYHfHOw2tTu1po09alIdrG2uzV2QX3L684Xt3lzfuX5knI+VHK3flTSmmferfH7PiU4XTJeH7M/OSMQqVhatfVZmqoCEet53uOx54tjLn6XVqbrHxce5dQStK4QBonFMOYQhBRDCOSICRWAbH/ClRAIQhNUZj6v+nguZES9HRqqICWJ2n76jV0trBZt3zFQOnzHs7m6dCEl9M2//rnd9w9mTA+OuOtq3exVcSuNkco9ly1Hm/meeGvv8mAwA9pKWXckBEeNcv87Y9POJ116A2nzJfHzBZrzJcnJgcn0wXT+ZLl8SmD0SGzxRHN7gGRt9bU3dawLiVvWL4pr2KlTlprUmm0qbW6VJsdM9+MGnpf78XlOpEKjAtuEfaVR8Vy6HoeDXufpmPRkYKOdDO0hUNbuAbZWgpGvqSqfBP1jDAIA776xZh+r8V0fkyne8C+LcxfhH709eOtu/NPYdMQTEVt3pRCEvCX7yYMOzGHyzPjH21ipz+k1uxQrrXM4XWXeR0vyW401BHasdYPjibQTWA8XXA4P2IwntLuHbxSguFruEWoJ14QZeW0KXQN8wMl/Yxsu5b/G3LZTf/j8P9Dpgn/A1IuI85xFf0uAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"aDai balance #1\"\n        title=\"aDai balance #1\"\n        src=\"/static/ac41ac3eb3ba82837e8a6dc41c669f61/fcda8/aDai-balance-1.png\"\n        srcset=\"/static/ac41ac3eb3ba82837e8a6dc41c669f61/12f09/aDai-balance-1.png 148w,\n/static/ac41ac3eb3ba82837e8a6dc41c669f61/e4a3f/aDai-balance-1.png 295w,\n/static/ac41ac3eb3ba82837e8a6dc41c669f61/fcda8/aDai-balance-1.png 590w,\n/static/ac41ac3eb3ba82837e8a6dc41c669f61/3cb0f/aDai-balance-1.png 708w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>If you see <code class=\"language-text\">aDAI</code> (just imagine it’s a zToken, it’s the same thing essentially anyways) balance of <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1011.413002069442100983</mn></mrow><annotation encoding=\"application/x-tex\">1011.413002069442100983</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">1</span><span class=\"mord\">1</span><span class=\"mord\">.</span><span class=\"mord\">4</span><span class=\"mord\">1</span><span class=\"mord\">3</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">2</span><span class=\"mord\">0</span><span class=\"mord\">6</span><span class=\"mord\">9</span><span class=\"mord\">4</span><span class=\"mord\">4</span><span class=\"mord\">2</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">9</span><span class=\"mord\">8</span><span class=\"mord\">3</span></span></span></span></span> and let’s say you want to withdraw everything that you have.</p>\n<p>Then you know that the amount that you are looking at on MetaMask is the principal amount multiplied by the lending accumulator.</p>\n<p>However, in <code class=\"language-text\">fn burn</code>, we want to subtract the <code class=\"language-text\">amount</code> from the principal (denoted as <code class=\"language-text\">raw_*</code> in the code) which does not have the accumulator factored in; it is literally the exact amount that the user had deposited before. To be able to do that, we need to convert <code class=\"language-text\">amount</code> into the same scale. This is because we only store the principal value on the blockchain instead of the principal multiplied by the accumulator.</p>\n<p>Now we understand why it has to be:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> raw_balance_after <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>raw_balance_before<span class=\"token punctuation\">,</span> scaled_down_amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>and</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> raw_supply_after <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>raw_supply_before<span class=\"token punctuation\">,</span> scaled_down_amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Lastly, <code class=\"language-text\">Transfer</code> event where the token is sent to the null address is emitted, and <code class=\"language-text\">burn</code> function exits.</p>\n<p>Next up is <code class=\"language-text\">update_rates_and_raw_total_debt</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token function\">update_rates_and_raw_total_debt</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span>\n    token<span class=\"token punctuation\">,</span> <span class=\"token comment\">// token</span>\n    updated_debt_accumulator<span class=\"token punctuation\">,</span> <span class=\"token comment\">// updated_debt_accumulator</span>\n    <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// is_delta_reserve_balance_negative</span>\n    amount_burnt<span class=\"token punctuation\">,</span> <span class=\"token comment\">// abs_delta_reserve_balance</span>\n    <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// is_delta_raw_total_debt_negative</span>\n    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// abs_delta_raw_total_debt</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Similar to <code class=\"language-text\">deposit</code> function, we are running this because we know that the supply of a token has changed, and this must affect the position on the interest rate curve as per the earlier discussion. Notice <code class=\"language-text\">true, // is_delta_reserve_balance_negative</code> because we know that the reserve balance (the supply of the token being withdrawn) has decreased.</p>\n<p>Calling <code class=\"language-text\">update_rates_and_raw_total_debt</code> will update borrowing and lending interest rates.</p>\n<p>Then, the corresponding amount of ERC20 token is <code class=\"language-text\">transfer</code>red to the user. Remember <code class=\"language-text\">amount_burnt</code> of zToken must be sent because a pair of zToken and ERC20 should be 1:1 in terms of their amounts.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token comment\">// Gives underlying tokens to user</span>\n<span class=\"token keyword\">let</span> amount_burnt<span class=\"token punctuation\">:</span> u256 <span class=\"token operator\">=</span> amount_burnt<span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> transfer_success <span class=\"token operator\">=</span> <span class=\"token class-name\">IERC20Dispatcher</span> <span class=\"token punctuation\">{</span>\n    contract_address<span class=\"token punctuation\">:</span> token\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> amount_burnt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>After that, collateralization checks are done. If the user withdraws too much that his borrowing is undercollateralized, the transaction would fail.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token comment\">// It's easier to post-check collateralization factor, at the cost of making failed</span>\n<span class=\"token comment\">// transactions more expensive.</span>\n<span class=\"token keyword\">let</span> is_asset_used_as_collateral <span class=\"token operator\">=</span> <span class=\"token function\">is_used_as_collateral</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// No need to check if the asset is not used as collateral at all</span>\n<span class=\"token keyword\">if</span> is_asset_used_as_collateral <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">assert_not_undercollateralized</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>It’s easier to check collateralization after all calculations regarding everything else are finished, because that way all variables such as the amount of token after withdrawal are already available for use. We will look at collateralization checks in more details in later sections.</p>\n<h2 id=\"borrow-1\" style=\"position:relative;\">Borrow<a href=\"#borrow-1\" aria-label=\"borrow 1 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>At this point, we know how <code class=\"language-text\">src/market/external.cairo</code> and <code class=\"language-text\">src/market/internal.cairo</code> work, so we will go straight into <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/internal.cairo#L122\">internal::borrow</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">borrow</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">:</span> felt252<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> caller <span class=\"token operator\">=</span> <span class=\"token function\">get_caller_address</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> <span class=\"token class-name\">UpdatedAccumulators</span><span class=\"token punctuation\">{</span>debt_accumulator<span class=\"token punctuation\">:</span> updated_debt_accumulator<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">..</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">update_accumulators</span><span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">assert_reserve_enabled</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> scaled_down_amount <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">div</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">,</span> updated_debt_accumulator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>scaled_down_amount<span class=\"token punctuation\">.</span><span class=\"token function\">is_non_zero</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token namespace\">errors<span class=\"token punctuation\">::</span></span><span class=\"token constant\">INVALID_AMOUNT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Updates user debt data</span>\n    <span class=\"token keyword\">let</span> raw_user_debt_before <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>raw_user_debts<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>caller<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> raw_user_debt_after <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>raw_user_debt_before<span class=\"token punctuation\">,</span> scaled_down_amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>raw_user_debts<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>caller<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> raw_user_debt_after<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">set_user_has_debt</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> caller<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> raw_user_debt_before<span class=\"token punctuation\">,</span> raw_user_debt_after<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Updates interest rate</span>\n    <span class=\"token function\">update_rates_and_raw_total_debt</span><span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span>\n        token<span class=\"token punctuation\">,</span> <span class=\"token comment\">// token</span>\n        updated_debt_accumulator<span class=\"token punctuation\">,</span> <span class=\"token comment\">// updated_debt_accumulator</span>\n        <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// is_delta_reserve_balance_negative</span>\n        amount<span class=\"token punctuation\">,</span> <span class=\"token comment\">// abs_delta_reserve_balance</span>\n        <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// is_delta_raw_total_debt_negative</span>\n        scaled_down_amount <span class=\"token comment\">// abs_delta_raw_total_debt</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Enforces token debt limit</span>\n    <span class=\"token function\">assert_debt_limit_satisfied</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">self</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span>\n            <span class=\"token namespace\">contract<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Event</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Borrowing</span><span class=\"token punctuation\">(</span>\n                <span class=\"token namespace\">contract<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Borrowing</span> <span class=\"token punctuation\">{</span>\n                    user<span class=\"token punctuation\">:</span> caller<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">:</span> token<span class=\"token punctuation\">,</span> raw_amount<span class=\"token punctuation\">:</span> scaled_down_amount<span class=\"token punctuation\">,</span> face_amount<span class=\"token punctuation\">:</span> amount\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// It's easier to post-check collateralization factor</span>\n    <span class=\"token function\">assert_not_undercollateralized</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> caller<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> amount_u256<span class=\"token punctuation\">:</span> u256 <span class=\"token operator\">=</span> amount<span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> transfer_success <span class=\"token operator\">=</span> <span class=\"token class-name\">IERC20Dispatcher</span> <span class=\"token punctuation\">{</span>\n        contract_address<span class=\"token punctuation\">:</span> token\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span>caller<span class=\"token punctuation\">,</span> amount_u256<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>transfer_success<span class=\"token punctuation\">,</span> <span class=\"token namespace\">errors<span class=\"token punctuation\">::</span></span><span class=\"token constant\">TRANSFER_FAILED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>First, we get the latest debt accumulator by running <code class=\"language-text\">update_accumulators</code>.</p>\n<p>Then again we need to ‘scale down’ the <code class=\"language-text\">amount</code> argument at <code class=\"language-text\">let scaled_down_amount = safe_decimal_math::div(amount, updated_debt_accumulator)</code>, because the amount that the user is requesting already has the borrowing accumulator factored in.</p>\n<p>The scaled down amount can now be used to subtract from or add to the principal of the user’s debt:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token comment\">// Updates user debt data</span>\n<span class=\"token keyword\">let</span> raw_user_debt_before <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>raw_user_debts<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>caller<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> raw_user_debt_after <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>raw_user_debt_before<span class=\"token punctuation\">,</span> scaled_down_amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>raw_user_debts<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>caller<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> raw_user_debt_after<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">set_user_has_debt</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> caller<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> raw_user_debt_before<span class=\"token punctuation\">,</span> raw_user_debt_after<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now we update the interest rate again by calling <code class=\"language-text\">update_rates_and_raw_total_debt</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token comment\">// Updates interest rate</span>\n<span class=\"token function\">update_rates_and_raw_total_debt</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span>\n    token<span class=\"token punctuation\">,</span> <span class=\"token comment\">// token</span>\n    updated_debt_accumulator<span class=\"token punctuation\">,</span> <span class=\"token comment\">// updated_debt_accumulator</span>\n    <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// is_delta_reserve_balance_negative</span>\n    amount<span class=\"token punctuation\">,</span> <span class=\"token comment\">// abs_delta_reserve_balance</span>\n    <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// is_delta_raw_total_debt_negative</span>\n    scaled_down_amount <span class=\"token comment\">// abs_delta_raw_total_debt</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Notice the difference in the parameters passed in compared to <code class=\"language-text\">deposit</code> or <code class=\"language-text\">withdraw</code>:</p>\n<p><code class=\"language-text\">true, // is_delta_reserve_balance_negative</code> because the contract is borrowing a portion of the reserve to the user;</p>\n<p><code class=\"language-text\">amount, // abs_delta_reserve_balance</code> because <code class=\"language-text\">amount</code> is the actual amount that the user will receive as a result of borrowing;</p>\n<p><code class=\"language-text\">false, // is_delta_raw_total_debt_negative</code> because the total debt increases as a result of borrowing;</p>\n<p><code class=\"language-text\">scaled_down_amount // abs_delta_raw_total_debt</code> because the absolute amount of the difference in total debt that does not consider the borrowing interest index is <code class=\"language-text\">scaled_down_amount</code>.</p>\n<p>Then, the <a href=\"https://zklend.gitbook.io/documentation/using-zklend/technical/asset-parameters#borrow-caps\">debt limit</a> is checked:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token comment\">// Enforces token debt limit</span>\n<span class=\"token function\">assert_debt_limit_satisfied</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>On <a href=\"https://zklend.gitbook.io/documentation/using-zklend/technical/asset-parameters#borrow-caps\">zklend documentation</a>, this is described as a “borrow cap”. The debt limit is not per individual user; It is imposed at the individual liquidity pool level:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6294a017cb32fa59ccc4399ecf13693d/31198/zklend-borrow-caps.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.91891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABS0lEQVQ4y5VUi47CIBD0///xLtGzl2orlFKg5TVmt9Jqz3hKsqGw7HSY2bADgJwzykg5I6WElNZ5O9b8GgVjNx/IqOoGX/sKShsYN2GwI6ybIPsB3/sKh6rmfN0I2NFzvpyjOW0BhdJoRQfjRi6w43QrdGiFglSag37olvwctF4Ylg8hO/Rao0hQ9ifvcTo3iDEtVy75bTwAWufQ6wExJU6m26EYI4yxnKO56PUvYKcU6lPDgt8bFWKE7BSO1S/q0/lWjHcAe7QXgRACFxQmPgQGpP3SBW8xHAbDOm4BQ4hQqof3HsXAtwCJxSx+fLiy94H3Dz8VBmM+MMU6NmbLgDQkIDKFWN4b9hKQrmus/cOAAJv2gv3h+BlD0lDKDqrXS+sUU6hd8gsznrvcKXZZCLnoyI09ec69YvYAuH0cynp+JNaD/Ajk53EPeAWWVU0kX6KnLAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"zklend borrow caps\"\n        title=\"zklend borrow caps\"\n        src=\"/static/6294a017cb32fa59ccc4399ecf13693d/fcda8/zklend-borrow-caps.png\"\n        srcset=\"/static/6294a017cb32fa59ccc4399ecf13693d/12f09/zklend-borrow-caps.png 148w,\n/static/6294a017cb32fa59ccc4399ecf13693d/e4a3f/zklend-borrow-caps.png 295w,\n/static/6294a017cb32fa59ccc4399ecf13693d/fcda8/zklend-borrow-caps.png 590w,\n/static/6294a017cb32fa59ccc4399ecf13693d/31198/zklend-borrow-caps.png 694w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>When the amount of total borrowing per token reaches the limit specified by the protocol, users won’t be able to borrow anymore until someone repays his debt.</p>\n<p>The debt limit can be checked at <a href=\"https://starkscan.co/contract/0x04c0a5193d58f74fbace4b74dcf65481e734ed1714121bdc571da345540efa05#read-write-contract\">https://starkscan.co/contract/0x04c0a5193d58f74fbace4b74dcf65481e734ed1714121bdc571da345540efa05#read-write-contract</a>. For example, for USDT of contract address <code class=\"language-text\">0x068f5c6a61780768455de69077e07e89787839bf8166decfbf92b645209c0fb8</code>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b4dbd892a0179c9bab5795bd1d089713/061c7/usdt_reserve_data.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.432432432432435%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB6ElEQVQoz22S+3KaUBDGfYVOJ2aqEYSIclUQ4YCKihTveNd4SdpM+v7P8HXOEW3S5I/f7O7s7rffGcjkSzb4kgeu5EOUXOSFKr4/aJ8paLjj9E9keQPfcjJUO4SgEWRyJRs50ULu0YIguxBVAkEhLIqql+YeirKLe76KLBXhjA9Q4R+iiXuxioxo+FDqAZR6B4YTour2USMRNLsLTm6AlxsoKi4EzUNespGX6l/yUG5cBHnVgWr5kE0PiuWjUiO3KBkOyoaDQrkGTnHBawS85v0HAa8SFHX/Kkivu2yBU8gNOvSeS/9rCrLDZphgqRZAd/swmwNYrQEMErG8YnUulzXvA6LuQzSa7/hXM0HJDNAdbxFOduiNt4xr3o6XiGZPiOfHW+xNdnB7U5AwAQlnaA9W8Ptz6CRCVjCQkawAo9UZ4/UzxqtnTNYv+Jkc2PJweUo5Y7A4oTvasEOd4RqteIl2vEIwWMMLE1BjTLBS72KyeUGye2VLVJTGKHnCdPPr0tu/Yrb9jXC6Z4eXhzesjn8w39OdI4aLE3Q3dVi2OulzDswJbVLB67Op09HyzGZoTd3THq3pbJwcmEuzOUyfbAboT/ds+LrUjBYsp8ukN0PNj9mHusZGZwI7GMHpTmG1hlAaPQjpb/MXhl9oQvkAdWoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"usdt reserve data.png\"\n        title=\"usdt reserve data.png\"\n        src=\"/static/b4dbd892a0179c9bab5795bd1d089713/fcda8/usdt_reserve_data.png\"\n        srcset=\"/static/b4dbd892a0179c9bab5795bd1d089713/12f09/usdt_reserve_data.png 148w,\n/static/b4dbd892a0179c9bab5795bd1d089713/e4a3f/usdt_reserve_data.png 295w,\n/static/b4dbd892a0179c9bab5795bd1d089713/fcda8/usdt_reserve_data.png 590w,\n/static/b4dbd892a0179c9bab5795bd1d089713/efc66/usdt_reserve_data.png 885w,\n/static/b4dbd892a0179c9bab5795bd1d089713/c83ae/usdt_reserve_data.png 1180w,\n/static/b4dbd892a0179c9bab5795bd1d089713/061c7/usdt_reserve_data.png 1216w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>The debt limit is <code class=\"language-text\">500000000000</code>. Because it has <code class=\"language-text\">6</code> decimal places, the actual debt limit is <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><mn>500000000000</mn><mrow><mn>1</mn><msup><mn>0</mn><mn>6</mn></msup></mrow></mfrac><mo>=</mo><mn>500</mn><mo separator=\"true\">,</mo><mn>000</mn></mrow><annotation encoding=\"application/x-tex\">\\frac{500000000000}{10^6}=500,000</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.190108em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span><span class=\"mord mtight\"><span class=\"mord mtight\">0</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7463142857142857em;\"><span style=\"top:-2.786em;margin-right:0.07142857142857144em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">6</span></span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">5</span><span class=\"mord mtight\">0</span><span class=\"mord mtight\">0</span><span class=\"mord mtight\">0</span><span class=\"mord mtight\">0</span><span class=\"mord mtight\">0</span><span class=\"mord mtight\">0</span><span class=\"mord mtight\">0</span><span class=\"mord mtight\">0</span><span class=\"mord mtight\">0</span><span class=\"mord mtight\">0</span><span class=\"mord mtight\">0</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8388800000000001em;vertical-align:-0.19444em;\"></span><span class=\"mord\">5</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span></span></span>, which is in line with zklend’s documentation.</p>\n<p>Then, the collateralization is checked by <code class=\"language-text\">assert_not_undercollateralized(@self, caller, true)</code> because users shouldn’t be able to borrow if they are not backed by enough collaterals.</p>\n<p>There is a new term that we need to know about regarding <code class=\"language-text\">assert_not_undercollateralized</code>: <strong>borrow factor</strong>. It is a variable used to deduce the risk-adjusted value of a liability of a certain asset. For example, <a href=\"https://zklend.gitbook.io/documentation/using-zklend/technical/asset-parameters#for-borrow-lend\">on zklend, the following is true</a>:</p>\n<table>\n<thead>\n<tr>\n<th>asset</th>\n<th>collateral factor</th>\n<th>borrow factor</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ETH</td>\n<td>80%</td>\n<td>100%</td>\n</tr>\n<tr>\n<td>USDT</td>\n<td>70%</td>\n<td>91%</td>\n</tr>\n</tbody>\n</table>\n<p>Let’s say you have deposited $1000 worth of ETH and want to borrow USDT. That means you can borrow <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1000</mn><mo>×</mo><mn>0.8</mn><mo>×</mo><mn>0.91</mn><mo>=</mo><mn>728</mn></mrow><annotation encoding=\"application/x-tex\">1000 \\times 0.8 \\times 0.91 = 728</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">8</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">9</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">7</span><span class=\"mord\">2</span><span class=\"mord\">8</span></span></span></span></span> dollars worth of USDT at max only. Essentially, borrow factor works to adjust the risk of the asset that is being borrowed, just like how collateral factor is used to adjust that of the asset being collateralized. So <code class=\"language-text\">assert_not_undercollateralized</code> takes this into account too.</p>\n<p>Finally, after all checks are done, the requested amount is <code class=\"language-text\">transfer</code>red to the user:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> amount_u256<span class=\"token punctuation\">:</span> u256 <span class=\"token operator\">=</span> amount<span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> transfer_success <span class=\"token operator\">=</span> <span class=\"token class-name\">IERC20Dispatcher</span> <span class=\"token punctuation\">{</span>\n    contract_address<span class=\"token punctuation\">:</span> token\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span>caller<span class=\"token punctuation\">,</span> amount_u256<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>transfer_success<span class=\"token punctuation\">,</span> <span class=\"token namespace\">errors<span class=\"token punctuation\">::</span></span><span class=\"token constant\">TRANSFER_FAILED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"repay-1\" style=\"position:relative;\">Repay<a href=\"#repay-1\" aria-label=\"repay 1 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Repayment takes three kinds: <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/internal.cairo#L174\">fn repay</a>, <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/internal.cairo#L192\">fn repay_for</a>, and <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/internal.cairo#L212\">fn repay_all</a>. All is the same, except that <code class=\"language-text\">repay_for</code> is used to repay for someone else’s debt, and <code class=\"language-text\">repay_all</code> is used to repay for all debt owed.</p>\n<p>So let’s look at <code class=\"language-text\">repay</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">repay</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">:</span> felt252<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">.</span><span class=\"token function\">is_non_zero</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token namespace\">errors<span class=\"token punctuation\">::</span></span><span class=\"token constant\">ZERO_AMOUNT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> caller <span class=\"token operator\">=</span> <span class=\"token function\">get_caller_address</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> <span class=\"token class-name\">DebtRepaid</span><span class=\"token punctuation\">{</span>raw_amount<span class=\"token punctuation\">,</span> face_amount <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">repay_debt_route_internal</span><span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> caller<span class=\"token punctuation\">,</span> caller<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> amount\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">self</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span>\n            <span class=\"token namespace\">contract<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Event</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Repayment</span><span class=\"token punctuation\">(</span>\n                <span class=\"token namespace\">contract<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Repayment</span> <span class=\"token punctuation\">{</span>\n                    repayer<span class=\"token punctuation\">:</span> caller<span class=\"token punctuation\">,</span> beneficiary<span class=\"token punctuation\">:</span> caller<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> raw_amount<span class=\"token punctuation\">,</span> face_amount\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>All business is done at <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/internal.cairo#L708C4-L708C4\">repay_debt_route_internal</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token comment\">/// `amount` with `0` means repaying all. Returns actual debt amounts repaid.</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">repay_debt_route_internal</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span>\n    repayer<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">,</span>\n    beneficiary<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">,</span>\n    token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">,</span>\n    amount<span class=\"token punctuation\">:</span> felt252\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">DebtRepaid</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">assert_reserve_enabled</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> updated_debt_accumulator <span class=\"token operator\">=</span> <span class=\"token namespace\">view<span class=\"token punctuation\">::</span></span><span class=\"token function\">get_debt_accumulator</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> amount<span class=\"token punctuation\">.</span><span class=\"token function\">is_zero</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> user_raw_debt <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>raw_user_debts<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>beneficiary<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>user_raw_debt<span class=\"token punctuation\">.</span><span class=\"token function\">is_non_zero</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token namespace\">errors<span class=\"token punctuation\">::</span></span><span class=\"token constant\">NO_DEBT_TO_REPAY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> repay_amount <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>user_raw_debt<span class=\"token punctuation\">,</span> updated_debt_accumulator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">repay_debt_internal</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> repayer<span class=\"token punctuation\">,</span> beneficiary<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> repay_amount<span class=\"token punctuation\">,</span> user_raw_debt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">DebtRepaid</span> <span class=\"token punctuation\">{</span> raw_amount<span class=\"token punctuation\">:</span> user_raw_debt<span class=\"token punctuation\">,</span> face_amount<span class=\"token punctuation\">:</span> repay_amount <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> raw_amount <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">div</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">,</span> updated_debt_accumulator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>raw_amount<span class=\"token punctuation\">.</span><span class=\"token function\">is_non_zero</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token namespace\">errors<span class=\"token punctuation\">::</span></span><span class=\"token constant\">INVALID_AMOUNT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">repay_debt_internal</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> repayer<span class=\"token punctuation\">,</span> beneficiary<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">,</span> raw_amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">DebtRepaid</span> <span class=\"token punctuation\">{</span> raw_amount<span class=\"token punctuation\">,</span> face_amount<span class=\"token punctuation\">:</span> amount <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This function is just a step before calling <code class=\"language-text\">repay_debt_internal</code>, and is designed to be called in all of the three repayment functions, and the code is pretty straightforward, given what we have been discussing so far.</p>\n<p>So let’s look at <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/internal.cairo#L740\">repay_debt_internal</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token comment\">/// ASSUMPTION: `repay_amount` = `raw_amount` * Debt Accumulator.</span>\n<span class=\"token comment\">/// ASSUMPTION: it's always called by `repay_debt_route_internal`.</span>\n<span class=\"token comment\">/// ASSUMPTION: raw_amount is non zero.</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">repay_debt_internal</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span>\n    repayer<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">,</span>\n    beneficiary<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">,</span>\n    token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">,</span>\n    repay_amount<span class=\"token punctuation\">:</span> felt252<span class=\"token punctuation\">,</span>\n    raw_amount<span class=\"token punctuation\">:</span> felt252\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> this_address <span class=\"token operator\">=</span> <span class=\"token function\">get_contract_address</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> <span class=\"token class-name\">UpdatedAccumulators</span><span class=\"token punctuation\">{</span>debt_accumulator<span class=\"token punctuation\">:</span> updated_debt_accumulator<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">..</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">update_accumulators</span><span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> token\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// No need to check if user is overpaying, as `safe_math::sub` below will fail anyways</span>\n    <span class=\"token comment\">// No need to check collateral value. Always allow repaying even if it's undercollateralized</span>\n\n    <span class=\"token comment\">// Updates user debt data</span>\n    <span class=\"token keyword\">let</span> raw_user_debt_before <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>raw_user_debts<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>beneficiary<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> raw_user_debt_after <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">sub</span><span class=\"token punctuation\">(</span>raw_user_debt_before<span class=\"token punctuation\">,</span> raw_amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>raw_user_debts<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>beneficiary<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> raw_user_debt_after<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">set_user_has_debt</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> beneficiary<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">,</span> raw_user_debt_before<span class=\"token punctuation\">,</span> raw_user_debt_after<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Updates interest rate</span>\n    <span class=\"token function\">update_rates_and_raw_total_debt</span><span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span>\n        token<span class=\"token punctuation\">,</span> <span class=\"token comment\">// token</span>\n        updated_debt_accumulator<span class=\"token punctuation\">,</span> <span class=\"token comment\">// updated_debt_accumulator</span>\n        <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// is_delta_reserve_balance_negative</span>\n        repay_amount<span class=\"token punctuation\">,</span> <span class=\"token comment\">// abs_delta_reserve_balance</span>\n        <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// is_delta_raw_total_debt_negative</span>\n        raw_amount <span class=\"token comment\">// abs_delta_raw_total_debt</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Takes token from user</span>\n    <span class=\"token keyword\">let</span> repay_amount<span class=\"token punctuation\">:</span> u256 <span class=\"token operator\">=</span> repay_amount<span class=\"token punctuation\">.</span><span class=\"token function\">into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> transfer_success <span class=\"token operator\">=</span> <span class=\"token class-name\">IERC20Dispatcher</span> <span class=\"token punctuation\">{</span>\n        contract_address<span class=\"token punctuation\">:</span> token\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">transferFrom</span><span class=\"token punctuation\">(</span>repayer<span class=\"token punctuation\">,</span> this_address<span class=\"token punctuation\">,</span> repay_amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>transfer_success<span class=\"token punctuation\">,</span> <span class=\"token namespace\">errors<span class=\"token punctuation\">::</span></span><span class=\"token constant\">TRANSFER_FAILED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"liquidate-1\" style=\"position:relative;\">Liquidate<a href=\"#liquidate-1\" aria-label=\"liquidate 1 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/src/market/external.cairo#L100\">internal::liquidate</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">liquidate</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractState</span><span class=\"token punctuation\">,</span>\n    user<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">,</span>\n    debt_token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span><span class=\"token punctuation\">,</span>\n    amount<span class=\"token punctuation\">:</span> felt252<span class=\"token punctuation\">,</span>\n    collateral_token<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ContractAddress</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> caller <span class=\"token operator\">=</span> <span class=\"token function\">get_caller_address</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Validates input</span>\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">.</span><span class=\"token function\">is_non_zero</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token namespace\">errors<span class=\"token punctuation\">::</span></span><span class=\"token constant\">ZERO_AMOUNT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">assert_reserve_enabled</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> debt_token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assert_reserve_enabled</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> collateral_token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> debt_reserve_decimals <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>reserves<span class=\"token punctuation\">.</span><span class=\"token function\">read_decimals</span><span class=\"token punctuation\">(</span>debt_token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> collateral_reserve <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>reserves<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>collateral_token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Liquidator repays debt for user</span>\n    <span class=\"token keyword\">let</span> <span class=\"token class-name\">DebtRepaid</span><span class=\"token punctuation\">{</span>raw_amount<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">..</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">repay_debt_route_internal</span><span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">ref</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> caller<span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">,</span> debt_token<span class=\"token punctuation\">,</span> amount\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Can only take from assets being used as collateral</span>\n    <span class=\"token keyword\">let</span> is_collateral <span class=\"token operator\">=</span> <span class=\"token function\">is_used_as_collateral</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">,</span> collateral_token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>is_collateral<span class=\"token punctuation\">,</span> <span class=\"token namespace\">errors<span class=\"token punctuation\">::</span></span><span class=\"token constant\">NONCOLLATERAL_TOKEN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Liquidator withdraws collateral from user</span>\n    <span class=\"token keyword\">let</span> oracle_addr <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>oracle<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> debt_token_price <span class=\"token operator\">=</span> <span class=\"token class-name\">IPriceOracleDispatcher</span> <span class=\"token punctuation\">{</span>\n        contract_address<span class=\"token punctuation\">:</span> oracle_addr\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">get_price</span><span class=\"token punctuation\">(</span>debt_token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> collateral_token_price <span class=\"token operator\">=</span> <span class=\"token class-name\">IPriceOracleDispatcher</span> <span class=\"token punctuation\">{</span>\n        contract_address<span class=\"token punctuation\">:</span> oracle_addr\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">get_price</span><span class=\"token punctuation\">(</span>collateral_token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> debt_value_repaid <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">mul_decimals</span><span class=\"token punctuation\">(</span>\n        debt_token_price<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">,</span> debt_reserve_decimals\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> equivalent_collateral_amount <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">div_decimals</span><span class=\"token punctuation\">(</span>\n        debt_value_repaid<span class=\"token punctuation\">,</span> collateral_token_price<span class=\"token punctuation\">,</span> collateral_reserve<span class=\"token punctuation\">.</span>decimals\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> one_plus_liquidation_bonus <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>\n        <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token constant\">SCALE</span><span class=\"token punctuation\">,</span> collateral_reserve<span class=\"token punctuation\">.</span>liquidation_bonus\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> collateral_amount_after_bonus <span class=\"token operator\">=</span> <span class=\"token namespace\">safe_decimal_math<span class=\"token punctuation\">::</span></span><span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>\n        equivalent_collateral_amount<span class=\"token punctuation\">,</span> one_plus_liquidation_bonus\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">IZTokenDispatcher</span> <span class=\"token punctuation\">{</span>\n        contract_address<span class=\"token punctuation\">:</span> collateral_reserve<span class=\"token punctuation\">.</span>z_token_address\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">move</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> caller<span class=\"token punctuation\">,</span> collateral_amount_after_bonus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Checks user collateralization factor after liquidation</span>\n    <span class=\"token function\">assert_not_overcollateralized</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">self</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span>\n            <span class=\"token namespace\">contract<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Event</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Liquidation</span><span class=\"token punctuation\">(</span>\n                <span class=\"token namespace\">contract<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Liquidation</span> <span class=\"token punctuation\">{</span>\n                    liquidator<span class=\"token punctuation\">:</span> caller<span class=\"token punctuation\">,</span>\n                    user<span class=\"token punctuation\">,</span>\n                    debt_token<span class=\"token punctuation\">,</span>\n                    debt_raw_amount<span class=\"token punctuation\">:</span> raw_amount<span class=\"token punctuation\">,</span>\n                    debt_face_amount<span class=\"token punctuation\">:</span> amount<span class=\"token punctuation\">,</span>\n                    collateral_token<span class=\"token punctuation\">,</span>\n                    collateral_amount<span class=\"token punctuation\">:</span> collateral_amount_after_bonus<span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This is a publicly visible function that can be called directly by any liquidators.</p>\n<p>The first step is the same as the <code class=\"language-text\">repay</code> function; The liquidator will repay for the undercollateralized asset for the debtor.</p>\n<p>The next step is to take the collateral away from the debtor as a liquidator.</p>\n<p>The amount that the liquidator is able to take away from the debtor is always <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>Amount of the collateral in USD equivalent to the amount being repaid by the liquidator</mtext><mo>×</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>+</mo><mtext>Liquidation bonus</mtext><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\text{Amount of the collateral in USD equivalent to the amount being repaid by the liquidator} \\times (1 + \\text{Liquidation bonus})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord text\"><span class=\"mord\">Amount of the collateral in USD equivalent to the amount being repaid by the liquidator</span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">Liquidation bonus</span></span><span class=\"mclose\">)</span></span></span></span></span>, where <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>Liquidation bonus</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{Liquidation bonus}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord text\"><span class=\"mord\">Liquidation bonus</span></span></span></span></span></span> varies from an asset to asset, and is decided by the protocol.</p>\n<p>Currently, zklend’s liquidation bonus ranges from 10% to 15%:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f04da6008e54897241ff975b10df44d2/63a68/liquidation-bonus.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 99.32432432432432%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAABtklEQVQ4y6VViW6jQAzN/39atdJW3XaPKps223CFe+5JGF41DlASEEFaJCNgPM/Pzx6zadsWa661fht/M8YgjGIUZYWyqhGEEeLkSFZWFZxzA+g96wAtXn79we5tj+efv/Hw7Tsen57x+OMFr9sdmqZZBLxiuCYV59rFlF3bUhbebwN4ZyAra7zu9gjiFFJbCGUG8+95xfB3f8D27QPb9wPePyJ6/xcmYEKRj7dNH6HmEnFaICvqCSBXBjVXtJ5kBQX1z2GSITrmYEIPvkPKUmkc0wzn83mUwsUa52CsRZoXVLQ5SXrfAdBvYJzTx1vR/QYfqGYcXMhLwO57r+9Q5R5Qa40gjAl0rqL2dELWMVxsmx7QWou8KKGUpiJR9BETz5B1DNt2tHZjXxpKhUMQUlqzDO2FYVWzxZ680tAzlErNa9g04FwMDO8C+lSjOAEXYsLAdQzTLEdZVis1PJ3o3GpjpoA9QyFImlWAQkrS6NJXbsKQ+jDLaYCsAvQbvEbjcfVfDL1jEMU0xgamV1UeM1xRZa0NNa0Qkox68eqkNKgZI5Z35+HcaJo6L63NMFwamrdAS7+AT0yZIZMlMQSIAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"liquidation bonus\"\n        title=\"liquidation bonus\"\n        src=\"/static/f04da6008e54897241ff975b10df44d2/fcda8/liquidation-bonus.png\"\n        srcset=\"/static/f04da6008e54897241ff975b10df44d2/12f09/liquidation-bonus.png 148w,\n/static/f04da6008e54897241ff975b10df44d2/e4a3f/liquidation-bonus.png 295w,\n/static/f04da6008e54897241ff975b10df44d2/fcda8/liquidation-bonus.png 590w,\n/static/f04da6008e54897241ff975b10df44d2/63a68/liquidation-bonus.png 629w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>After calculating the amount of collateral to be transferred to the liquidator, the function simply <code class=\"language-text\">move</code>s the zToken of the corresponding collateral from the debtor to the liquidator:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token class-name\">IZTokenDispatcher</span> <span class=\"token punctuation\">{</span>\n    contract_address<span class=\"token punctuation\">:</span> collateral_reserve<span class=\"token punctuation\">.</span>z_token_address\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">move</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> caller<span class=\"token punctuation\">,</span> collateral_amount_after_bonus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Lastly, since zklend only allows the liquidator to recover the debtor’s position back to the health factor of 1 at maximum, it checks if the debtor is overcollateralized:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token function\">assert_not_overcollateralized</span><span class=\"token punctuation\">(</span><span class=\"token operator\">@</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Here’s an example of liquidation that works, adopted from <a href=\"https://github.com/zkLend/zklend-v1-core/blob/10dfb3d1f01b1177744b038f8417a5a9c3e94185/tests/market.cairo#L998\">zklend’s test case</a>.</p>\n<p>The setup is the same as the example used in the interest rate calculation:</p>\n<table>\n<thead>\n<tr>\n<th>Token</th>\n<th>Oracle Price (USD)</th>\n<th>Collateral factor</th>\n<th><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>R</mi><mtext>slope1</mtext></msub></mrow><annotation encoding=\"application/x-tex\">R_{\\text{slope1}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">slope1</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span></th>\n<th><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>R</mi><mtext>slope2</mtext></msub></mrow><annotation encoding=\"application/x-tex\">R_{\\text{slope2}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">slope2</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span></th>\n<th><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>R</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">R_0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.30110799999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></span></th>\n<th><span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>U</mi><mtext>optimal</mtext></msub></mrow><annotation encoding=\"application/x-tex\">U_{\\text{optimal}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.969438em;vertical-align:-0.286108em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">U</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">optimal</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span></span></span></span></span></th>\n<th>Reserve factor</th>\n<th>Liquidation bonus</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>$SIS</td>\n<td>50</td>\n<td>50%</td>\n<td>0.1</td>\n<td>0.5</td>\n<td>1%</td>\n<td>60%</td>\n<td>10%</td>\n<td>20%</td>\n</tr>\n<tr>\n<td>$BRO</td>\n<td>100</td>\n<td>75%</td>\n<td>0.2</td>\n<td>0.3</td>\n<td>5%</td>\n<td>80%</td>\n<td>20%</td>\n<td>10%</td>\n</tr>\n</tbody>\n</table>\n<p>Bob deposits <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>10000</mn></mrow><annotation encoding=\"application/x-tex\">10000</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span></span></span> $BRO, Alice deposits <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>100</mn></mrow><annotation encoding=\"application/x-tex\">100</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span></span></span> $SIS.</p>\n<p>Alice borrows</p>\n<p>22.5 $BRO =</p>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mn>22.5</mn><mo>×</mo><mi mathvariant=\"normal\">$</mi><mn>100</mn><mo>=</mo><mi mathvariant=\"normal\">$</mi><mn>2250</mn><mo>&#x3C;</mo><mn>100</mn><mo>×</mo><mn>50</mn><mo>×</mo><mn>0.5</mn><mo>=</mo><mi mathvariant=\"normal\">$</mi><mn>2500</mn></mrow><annotation encoding=\"application/x-tex\">22.5 \\times \\$100 = \\$2250 &#x3C; 100 \\times 50 \\times 0.5 = \\$2500</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">2</span><span class=\"mord\">2</span><span class=\"mord\">.</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.80556em;vertical-align:-0.05556em;\"></span><span class=\"mord\">$</span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.80556em;vertical-align:-0.05556em;\"></span><span class=\"mord\">$</span><span class=\"mord\">2</span><span class=\"mord\">2</span><span class=\"mord\">5</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&#x3C;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">5</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.80556em;vertical-align:-0.05556em;\"></span><span class=\"mord\">$</span><span class=\"mord\">2</span><span class=\"mord\">5</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span></span></span></div>\n<p>So initially Alice is in a healthy position, because her health factor would be</p>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mo>=</mo><mfrac><mn>2500</mn><mn>2250</mn></mfrac><mo>></mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">= \\frac{2500}{2250} > 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.00744em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"mord\">2</span><span class=\"mord\">5</span><span class=\"mord\">0</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"mord\">5</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span></span></div>\n<p>Now, let’s suppose the price of $SIS declines to $40. Then Alice’s health factor will be:</p>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mfrac><mrow><mn>100</mn><mo>×</mo><mn>40</mn><mo>×</mo><mn>0.5</mn></mrow><mn>2250</mn></mfrac><mo>=</mo><mfrac><mn>2000</mn><mn>2250</mn></mfrac><mo>=</mo><mfrac><mn>8</mn><mn>9</mn></mfrac><mo>&#x3C;</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">\\frac{\n    100 \\times 40 \\times 0.5\n}{\n    2250\n} = \\frac{\n    2000\n}{\n    2250\n} = \\frac{\n    8\n}{9} &#x3C; 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:2.00744em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"mord\">2</span><span class=\"mord\">5</span><span class=\"mord\">0</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\">4</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">5</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.00744em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"mord\">2</span><span class=\"mord\">5</span><span class=\"mord\">0</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.00744em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">9</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">8</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&#x3C;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span></span></div>\n<p>This means <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mfrac><mn>1</mn><mn>9</mn></mfrac></mrow><annotation encoding=\"application/x-tex\">\\frac{1}{9}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.190108em;vertical-align:-0.345em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.845108em;\"><span style=\"top:-2.6550000000000002em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">9</span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.394em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.345em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span></span> of Alice’s liabilities = $250 worth of $BRO is now undercollateralized and can be readily liquidated by anyone.</p>\n<p>While monitoring the market, Bob notices Alice is in an undercollateralized position, so he calls <code class=\"language-text\">liquidate()</code> function, repaying 6.25 $BRO for Alice instead.</p>\n<p>Bob expects to receive:</p>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mo stretchy=\"false\">(</mo><mfrac><mrow><msub><mtext>Amount repaid</mtext><mtext>BRO</mtext></msub><mo>×</mo><msub><mtext>Price in USD</mtext><mtext>BRO</mtext></msub></mrow><msub><mtext>Price in USD</mtext><mtext>SIS</mtext></msub></mfrac><mo stretchy=\"false\">)</mo><mo>×</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>+</mo><msub><mtext>Liquidation bonus</mtext><mtext>SIS</mtext></msub><mo stretchy=\"false\">)</mo><mo>=</mo><mspace linebreak=\"newline\"></mspace><mo stretchy=\"false\">(</mo><mfrac><mrow><mn>6.25</mn><mo>×</mo><mn>100</mn></mrow><mn>40</mn></mfrac><mo stretchy=\"false\">)</mo><mo>×</mo><mo stretchy=\"false\">(</mo><mn>1</mn><mo>+</mo><mn>0.2</mn><mo stretchy=\"false\">)</mo><mo>=</mo><mspace linebreak=\"newline\"></mspace><mn>18.75</mn></mrow><annotation encoding=\"application/x-tex\">(\\frac{\n    \\text{Amount repaid}_\\text{BRO} \\times \\text{Price in USD}_\\text{BRO}\n}{\n    \\text{Price in USD}_\\text{SIS}\n}) \\times (1 + \\text{Liquidation bonus}_\\text{SIS}) = \\newline\n(\\frac{\n    6.25 \\times 100\n}{\n    40\n}) \\times (1 + 0.2) = \\newline\n18.75</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:2.20744em;vertical-align:-0.8360000000000001em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.37144em;\"><span style=\"top:-2.3139999999999996em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">Price in USD</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">SIS</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.6769999999999996em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">Amount repaid</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.23419099999999995em;\"><span style=\"top:-2.4558600000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">BRO</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.24414em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">Price in USD</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">BRO</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8360000000000001em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">Liquidation bonus</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.23419099999999995em;\"><span style=\"top:-2.4558600000000004em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord text mtight\"><span class=\"mord mtight\">SIS</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.24414em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span></span><span class=\"mspace newline\"></span><span class=\"base\"><span class=\"strut\" style=\"height:2.00744em;vertical-align:-0.686em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">4</span><span class=\"mord\">0</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">6</span><span class=\"mord\">.</span><span class=\"mord\">2</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">2</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span></span><span class=\"mspace newline\"></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">8</span><span class=\"mord\">.</span><span class=\"mord\">7</span><span class=\"mord\">5</span></span></span></span></span></div>\n<p>… 18.75 $SIS, which is worth <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>18.75</mn><mo>×</mo><mn>40</mn><mo>=</mo><mn>750</mn></mrow><annotation encoding=\"application/x-tex\">18.75 \\times 40 = 750</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">1</span><span class=\"mord\">8</span><span class=\"mord\">.</span><span class=\"mord\">7</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">4</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">7</span><span class=\"mord\">5</span><span class=\"mord\">0</span></span></span></span></span> dollars. He spent <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>6.25</mn><mo>×</mo><mn>100</mn><mo>=</mo><mn>625</mn></mrow><annotation encoding=\"application/x-tex\">6.25 \\times 100 = 625</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">6</span><span class=\"mord\">.</span><span class=\"mord\">2</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">6</span><span class=\"mord\">2</span><span class=\"mord\">5</span></span></span></span></span> dollars to repay, so as long as the gas fee is low enough, he’s made a profit of <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>750</mn><mo>−</mo><mn>625</mn><mo>−</mo><mtext>gas</mtext></mrow><annotation encoding=\"application/x-tex\">750 - 625 - \\text{gas}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">7</span><span class=\"mord\">5</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72777em;vertical-align:-0.08333em;\"></span><span class=\"mord\">6</span><span class=\"mord\">2</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord text\"><span class=\"mord\">gas</span></span></span></span></span></span> dollars.</p>\n<p>After liquidation, Alice’s health factor is:</p>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mfrac><mrow><mn>81.25</mn><mo>×</mo><mn>40</mn><mo>×</mo><mn>0.5</mn></mrow><mrow><mo stretchy=\"false\">(</mo><mn>22.5</mn><mo>−</mo><mn>6.25</mn><mo stretchy=\"false\">)</mo><mo>×</mo><mn>100</mn></mrow></mfrac><mo>=</mo><mspace linebreak=\"newline\"></mspace><mfrac><mn>1625</mn><mn>1625</mn></mfrac><mo>=</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">\\frac{\n    81.25 \\times 40 \\times 0.5\n}\n{\n    (22.5 - 6.25) \\times 100\n} = \\newline \n\\frac{\n    1625\n}\n{\n    1625\n} = 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:2.25744em;vertical-align:-0.936em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mopen\">(</span><span class=\"mord\">2</span><span class=\"mord\">2</span><span class=\"mord\">.</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\">6</span><span class=\"mord\">.</span><span class=\"mord\">2</span><span class=\"mord\">5</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord\">0</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">8</span><span class=\"mord\">1</span><span class=\"mord\">.</span><span class=\"mord\">2</span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\">4</span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\">0</span><span class=\"mord\">.</span><span class=\"mord\">5</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.936em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span></span><span class=\"mspace newline\"></span><span class=\"base\"><span class=\"strut\" style=\"height:2.00744em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.32144em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span><span class=\"mord\">6</span><span class=\"mord\">2</span><span class=\"mord\">5</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span><span class=\"mord\">6</span><span class=\"mord\">2</span><span class=\"mord\">5</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"></span><span class=\"mord\">1</span></span></span></span></span></div>\n<p>which means Alice is not overcollateralized, which if it was the case make the transaction rejected.</p>\n<p>Liquidation should only work for undercollateralized positions. Liquidators cannot liquidate healthy positions.</p>\n<!-- \n## Flash loan\n\nFlash loan does not exist in TradFi, so there really is no term to explain that. But essentially it is a transaction that borrows an asset from the protocol and makes use of it somehow and returns it back to the protocol with a fee at the end of the protocol.\n\nBecause the transaction would fail if the user does not return the borrowed asset at the end of the transaction anyway, there is no need to supply a collateral for the transaction to happen.\n\n## Storage\n\n## Precision\n\n## Oracle\n\n[Pragma Oracle](https://www.pragmaoracle.com/) is used for zklend protocol.  -->","frontmatter":{"title":"Technical intro to DeFi lending protocols with zkLend codebase as an example","date":"October 26, 2023","keywords":["zklend","cairo","defi","lending","code"]},"fields":{"readingTime":{"text":"36 min read"}}}},"pageContext":{"slug":"/2023-10-26-technical-intro-to-defi-lending-protocols-with-zklend-codebase-as-an-example/","previous":{"fields":{"slug":"/2023-01-01-Life-3-0-being-human-in-the-age-of-artificial-intelligence/","readingTime":{"text":"18 min read"}},"frontmatter":{"title":"Full summary of <Life 3.0: Being Human in the Age of Artificial Intelligence> (14 / 100)","tab":"post","tags":["books"],"keywords":["life 3.0","artificial intelligence","book"]}},"next":null}},"staticQueryHashes":["3128451518","426816048"]}