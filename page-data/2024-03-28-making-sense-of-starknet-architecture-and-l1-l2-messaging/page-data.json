{"componentChunkName":"component---src-templates-blog-post-js","path":"/2024-03-28-making-sense-of-starknet-architecture-and-l1-l2-messaging/","result":{"data":{"site":{"siteMetadata":{"title":"Joel's dev blog","author":"Joel Mun","siteUrl":"https://9oelm.github.io"}},"markdownRemark":{"id":"99e69e50-82e8-5b38-ba2b-35acedf85047","excerpt":"This article was originally posted at Lazer 1 Research, which is another blog that I maintain specifically for blockchain. With the introduction of the STRK…","html":"<p><em>This article was originally posted at <a href=\"https://research.lazer1.xyz/blog/making-sense-of-starknet-architecture-and-l1-l2-messaging/\">Lazer 1 Research</a>, which is another blog that I maintain specifically for blockchain.</em></p>\n<p>With the introduction of the STRK provisions program, Starknet has garnered significant public attention, sparking a growing curiosity regarding its technical intricacies. Particularly, there exists a notable gap in understanding the architecture of Starknet and the mechanics of L1-L2 messaging. Thus, the purpose of this writing is to provide a comprehensive elucidation of these two topics.</p>\n<h1 id=\"starknet-architecture\" style=\"position:relative;\">Starknet architecture<a href=\"#starknet-architecture\" aria-label=\"starknet architecture permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>Let us start by defining the architecture of Starknet. Starknet consists of several components:</p>\n<ul>\n<li>Mempool (Gateway)</li>\n<li>Sequencer</li>\n<li>Prover</li>\n<li>Full node</li>\n<li>Starknet core contract</li>\n<li>Verifier</li>\n<li>Starknet bridge contract</li>\n</ul>\n<h2 id=\"mempool-gateway\" style=\"position:relative;\">Mempool (Gateway)<a href=\"#mempool-gateway\" aria-label=\"mempool gateway permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>A mempool (memory pool) is a temporary storage for pending transactions that are not included in a block yet. When you submit a transaction, it doesn’t go straight into the network and make changes. It will have to wait in the mempool.</p>\n<p>The mempool performs a preliminary validation on the transaction, like checking the length of calldata.</p>\n<!-- Write more about mempool -->\n<h2 id=\"sequencer\" style=\"position:relative;\">Sequencer<a href=\"#sequencer\" aria-label=\"sequencer permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Sequencer retrieves transactions from mempool and puts them in a specific sequential order, and produces blocks containing them.</p>\n<p>In essence, a sequencer has two core tasks<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup>:</p>\n<ol>\n<li>sequencing (ordering): it orders transactions, determining the canonical sequence of blocks for a given chain fork. It then appends new blocks to this sequence.</li>\n<li>executing (validation): it executes these transactions, updating the system’s state based on a given function. The block produced by the sequencer is submitted to Ethereum as a single compact proof (aka “rollup”).</li>\n</ol>\n<p>Starknet has some open-source sequencers:</p>\n<ul>\n<li><a href=\"https://github.com/keep-starknet-strange/madara/\">Mandara</a></li>\n<li><a href=\"https://github.com/starkware-libs/blockifier\">Blockifier</a></li>\n<li><a href=\"https://github.com/lambdaclass/starknet_stack/tree/main/sequencer\">Kraken</a> (seemingly discontinued by Lambdaclass)</li>\n</ul>\n<p>A sequencer is needed in L2 blockchains for scalability and performance wins. By processing transactions off-chain in batches, it is able to achieve much faster speed.</p>\n<p>Blockchains may have a centralized sequencer, like Starknet. The centralized sequencer can function as perfectly as a decentralized one. But the primary drive for the decentralization comes from mitigating the risk of censorship, because transactions can be reordered, included, or excluded by a centralized party without no one noticing it. In light of this, <a href=\"https://starkware.co/resource/starknet-decentralization-a-roadmap-in-broad-strokes/\">Starknet is actively moving towards decentralization, as described by their blog post in Oct 2023</a>, although the sequencer is likely to be one of the last components in the stack to be decentralized.</p>\n<h2 id=\"full-node\" style=\"position:relative;\">Full node<a href=\"#full-node\" aria-label=\"full node permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Starknet has a few full node implementations:</p>\n<ul>\n<li><a href=\"https://github.com/eqlabs/pathfinder\">Pathfinder</a></li>\n<li><a href=\"https://github.com/NethermindEth/juno\">Juno</a></li>\n<li><a href=\"https://github.com/starkware-libs/papyrus\">Papyrus</a></li>\n</ul>\n<p>The full node is responsible for handling all <a href=\"https://github.com/starkware-libs/starknet-specs/blob/master/api/starknet_api_openrpc.json\">API requests specified per spec</a>.</p>\n<h2 id=\"prover\" style=\"position:relative;\">Prover<a href=\"#prover\" aria-label=\"prover permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>The prover generates proofs for the transactions in the blocks produced by the sequencer. <a href=\"https://github.com/lambdaclass/cairo-vm\">cairo-vm</a> is used as a prover. Another implementation is <a href=\"https://github.com/NethermindEth/cairo-vm-go\">cairo-vm-go</a>.</p>\n<p>The prover receives blocks from the sequencer, and processes each block to assert the correctness, and generates proof, and submits the proof to Ethereum.</p>\n<p>Starknet uses SHARP, which stands for a SHARed Prover. It is:</p>\n<blockquote>\n<p>a powerful system designed to generate STARK proofs for aggregated Cairo programs. Cairo, being a general computation programming language, allows for <em>the accommodation of various code logics in one single proof</em>.</p>\n</blockquote>\n<blockquote>\n<p>SHARP processes batches of transactions off-chain, and validates the proof for their computation on-chain, amortizing the cost of all transactions across a single proof. The generated unified STARK proof is validated through an on-chain Solidity verifier contract, enabling SHARP to enhance throughput, reduce gas fees, and minimize latency.<sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup></p>\n</blockquote>\n<p>In other words, different Cairo programs are run together and a single proof for all of those programs are generated. <a href=\"https://book.starknet.io/ch03-03-provers.html\">Here’s a good read on on SHARP</a>.</p>\n<h2 id=\"verifier\" style=\"position:relative;\">Verifier<a href=\"#verifier\" aria-label=\"verifier permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Starknet manages a verifier smart contract on Ethereum responsible for verifying the proof generated from the Cairo VM. If the proof is valid, Starknet’s state root is updated to the newest one. The verification and state transition can be seen at <a href=\"https://github.com/starkware-libs/cairo-lang/blob/efa9648f57568aad8f8a13fbf027d2de7c63c2c0/src/starkware/starknet/solidity/Starknet.sol#L286\">https://github.com/starkware-libs/cairo-lang/blob/efa9648f57568aad8f8a13fbf027d2de7c63c2c0/src/starkware/starknet/solidity/Starknet.sol#L286</a>.</p>\n<h2 id=\"starknet-core-contract\" style=\"position:relative;\">Starknet core contract<a href=\"#starknet-core-contract\" aria-label=\"starknet core contract permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>The Starknet core contract is an Ethereum contract deployed at <a href=\"https://etherscan.io/address/0xc662c410C0ECf747543f5bA90660f6ABeBD9C8c4#code\"><code class=\"language-text\">0xc662c410C0ECf747543f5bA90660f6ABeBD9C8c4</code></a> at time of writing. The source code can be viewed at <a href=\"https://github.com/starkware-libs/cairo-lang/blob/efa9648f57568aad8f8a13fbf027d2de7c63c2c0/src/starkware/starknet/solidity/Starknet.sol\">Starknet.sol</a>.</p>\n<p>The core contract:</p>\n<ul>\n<li>stores the list of verifier contracts</li>\n<li>manages L1-L2 messaging</li>\n<li>oversees state commitment and update between L1 and L2</li>\n</ul>\n<h2 id=\"starknet-bridge-contract\" style=\"position:relative;\">Starknet bridge contract<a href=\"#starknet-bridge-contract\" aria-label=\"starknet bridge contract permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>When we say ‘Starknet bridge contract’, it means multiple contracts that work together to enable bridging. Bridging mean not only the transfer of a token, but also any arbitrary messages between Ethereum and Starknet.</p>\n<p>The bridge contracts can be located at:</p>\n<ul>\n<li><a href=\"https://github.com/starknet-io/starkgate-contracts/blob/cairo-1/src/solidity/LegacyBridge.sol\">LegacyBridge.sol</a>: the old bridge contract that used to be deployed per token. Still in use by most prominent tokens on Starknet, like wBTC, USDC, USDT, and more.</li>\n<li><a href=\"https://github.com/starknet-io/starkgate-contracts/blob/cairo-1/src/solidity/StarknetTokenBridge.sol\">StarknetTokenBridge.sol</a>: the new bridge contract that is used to bridge multiple tokens with just one contract. Adding a token is permissionless.</li>\n<li><a href=\"https://github.com/starknet-io/starkgate-contracts/blob/cairo-1/src/solidity/StarkgateManager.sol\">StarkgateManager.sol</a>: manager contract that oversees tokens bridged by <code class=\"language-text\">StarknetTokenBridge.sol</code>. Can deactivate or block a token, enroll a new token, etc.</li>\n<li><a href=\"https://github.com/starknet-io/starkgate-contracts/blob/cairo-1/src/solidity/StarkgateRegistry.sol\">StarkgateRegistry.sol</a>: maintains the list of bridged tokens.</li>\n<li><a href=\"https://github.com/starknet-io/starkgate-contracts/blob/5a10fd263d29cd032b7229691d043520edae0737/src/cairo/token_bridge.cairo\">token_bridge.cairo</a>: the bridge contract on L2 that is compatible with both <code class=\"language-text\">LegacyBridge.sol</code> and <code class=\"language-text\">StarknetTokenBridge.sol</code>. Users submit withdraw requests from here. L1 bridges use this L2 contract to deposit tokens into L2. More on this later.</li>\n</ul>\n<h2 id=\"architecture-diagram\" style=\"position:relative;\">Architecture diagram<a href=\"#architecture-diagram\" aria-label=\"architecture diagram permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><a href=\"https://drive.google.com/file/d/1DL62Put2DFxHyqYq5jIXcleDs4sEyTPP/view?usp=sharing\">Below diagram</a> helps understand how these components work together.</p>\n<iframe frameborder=\"0\" style=\"width:100%;height:613px;\" src=\"https://viewer.diagrams.net/?tags=%7B%7D&highlight=0000ff&edit=_blank&layers=1&nav=1&title=Starknet%20architecture%20diagram.drawio#Uhttps%3A%2F%2Fdrive.google.com%2Fuc%3Fid%3D1DL62Put2DFxHyqYq5jIXcleDs4sEyTPP%26export%3Ddownload\"></iframe>\n<p>First, the user creates and submits a transaction to the mempool. Ths sequencer picks up the transactions from the mempool, orders, validates and executes them using Cairo VM. The Cairo program execution yields an execution trace, aggregating all the transactions appearing in that block to it. The execution trace, along with the previous state root, is fed into the prover.</p>\n<p>The prover, again using Cairo VM, generates a new state root and proof based on the data received from the sequencer. Then it passes those to the verifier contract. The Starknet core contract verifies the validity of the state update, and if it is valid, it updates the state. Then the user’s transaction is successfully accepted on L1.</p>\n<p>Now that we know how Starknet works, we are ready to talk about L1-L2 messaging. The Starknet bridge contract in the diagram deliberately has not been elaborated in this section for that reason.</p>\n<h1 id=\"l1-l2-messaging\" style=\"position:relative;\">L1-L2 messaging<a href=\"#l1-l2-messaging\" aria-label=\"l1 l2 messaging permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<h2 id=\"overview\" style=\"position:relative;\">Overview<a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Here’s an overview of L1-L2 messaging on Starknet. Here’s <a href=\"https://docs.starknet.io/documentation/architecture_and_concepts/Network_Architecture/messaging-mechanism/\">a diagram from Starknet’s official documentation</a>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c2fd7b020e22af1c9a18084d4048b8a9/db3a5/l2_l1_messaging_mechanism.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.86486486486486%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAACSUlEQVQoz03N646bMBAFYN7/mVrtVt10mwSMMTa2wRduuWwSLjHYOLv5UUVppUqfRkczGp1Aq0POG632IMzDLQdRDsI82vLthnFW9921u4yX8/+Gp/NpCMp2YOVY1FcsujS/IH7GxeUZqOp5OTDdy9bIdhKtEa1Ru0ntJrmb6oMJxN5uhNvkBlVLUvuk9qF0QC9AL5H2r7D7Hp5C4bbCRtKB0kdqiUsfak9rG6ijewGnb++11ieuD1h8hMX8OxveSY9oR4oGkoKU40/U/UAXgM/rrN/k11DMrLGB2M3rfNrwa1LfYOWBckDZSM6hmBM1J2qE4pLWLizmLR1jMW/YuMLdmhvW2kAd3Bse3uAHyw+o2NFqjLVLqiUpF1gusPKxXla4XyWn1baNlIPaPQq0+9v8Ci8v4IT1GNM2q00kXaQegHKx9kD7TTGvuXlnJhQ2qW5Q2ri80cYFur2G2RnwHinDdp7UljaWPqbLqhEVO1S0TJywmrCeeGtQ3iSQpXmj99dgbA9eKqf0lAsn5KL0IvUi1SLVLOUBp0ecTpzbQjmhjC4bznIIG0aHdh8YVd8JmRHuwvhGqUuQI8RlmUtJH8I+TEaAZoS/KP3M6C2jI8Q9SD2hs9BBL6sZpQtlMyY3xjqY7oU8CtmB9GMDm1/RYR0/TpQ5kpkEG4SvCfaEPJ5HVQ1b4DDxJLtl2Sdld87vjBmILMIWYZdiT7IvSj0hJkZ3Sj8p/cTEChkM7fGM+THNTaGsLq3UT06XVpdOl06V9p/H8pmlvtb7Pzxlq3jcnDtHAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"L2→L1 message mechanism\"\n        title=\"L2→L1 message mechanism\"\n        src=\"/static/c2fd7b020e22af1c9a18084d4048b8a9/fcda8/l2_l1_messaging_mechanism.png\"\n        srcset=\"/static/c2fd7b020e22af1c9a18084d4048b8a9/12f09/l2_l1_messaging_mechanism.png 148w,\n/static/c2fd7b020e22af1c9a18084d4048b8a9/e4a3f/l2_l1_messaging_mechanism.png 295w,\n/static/c2fd7b020e22af1c9a18084d4048b8a9/fcda8/l2_l1_messaging_mechanism.png 590w,\n/static/c2fd7b020e22af1c9a18084d4048b8a9/efc66/l2_l1_messaging_mechanism.png 885w,\n/static/c2fd7b020e22af1c9a18084d4048b8a9/db3a5/l2_l1_messaging_mechanism.png 1087w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Keep this in mind, as we are going to go through each step in detail in words. Then you can fully grasp the concept by coming back to this diagram later.</p>\n<h2 id=\"legacybridge-legacybridgesol\" style=\"position:relative;\">LegacyBridge (<a href=\"(https://github.com/starknet-io/starkgate-contracts/blob/cairo-1/src/solidity/LegacyBridge.sol)\"><code class=\"language-text\">LegacyBridge.sol</code></a>)<a href=\"#legacybridge-legacybridgesol\" aria-label=\"legacybridge legacybridgesol permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Starknet used to have a bridge per token. This means that for every single token that was meant to be bridged, the same bridge has to be deployed again. This bridge is still live in production and still serves most of the bridge tokens to this date. The list of tokens that make use of <code class=\"language-text\">LegacyBridge</code> can be discovered at <a href=\"https://github.com/starknet-io/starknet-addresses/blob/master/bridged_tokens/mainnet.json\">https://github.com/starknet-io/starknet-addresses/blob/master/bridged_tokens/mainnet.json</a>.</p>\n<p>Some of them are:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/202e9aa7f2a2fcb2021a8ca9d013a602/4c42d/bridged_tokens.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 101.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC9ElEQVQ4y42U2XLaQBBFeYyxkUBotDEabaANhDBgFjuxHWfxQxJX8v8fc1PdEovLcVUebnUPJTWaPn270xcj6MKFZrroWz4GTgDDCXA1sHE1cNr4/+p0ewLWOIJa5ohmW8SzPTTTw4eegYvesJVxpubc1Ux0ddGozS/7FjpdTcCMAoTbEmpZwsnGsIMUcbVDWN5AFSv+I1JQrBGUa4TTDSyVNjeyFQw3RN9W7RdqAobvw1/mTdFVhqC8xvzTD5S7b5jdPnO+fPqD+v4npvtnLB5fkNS38JIZ3HgGmS44180ROtrQhW57/JUiCWAoCcNV/KAbT1lOVBxfot+9cQUvnsEOcpalMlhBBo0KDiwJXXgtFMUiGJfcE9FGq+1Rk5+ixdc85NzDi54JO434unG1RVjcoKubp6Zrh9w85YfzUYIjF7zULQwDxT2UdQY7jeHGJZL6jqEQHKZf7bhv8XzPkaAYTgjDjZpRc8PXUKgYFR3NJ/CzOab77yi3X1FsvnBebL8yEIr55gnRbIPRZA6Z1g2YSQ1dtFD6tgdrHMIpYpixz1BoROghP7tugVR8VvkSblTy2QkL2GF+hEfzy1CooG55GFgBhl6CvpCvB1c/z8VxiP+lFkqMaDdFOFsjLDegr+6e0eX8jHr3HR2hUA+9agK3HEPEAc8dOeTgCoLDkKY3jVuKFUw5PrrkoCOUgZQMRa0KjKoJZFoxjGz9yG6Z3j7zOV09cCQReRpq6mUz8G0PGYozasZlmsBOQwiVNN4t14iqHcb1HVM99zXBYce0xQicLiQ6AyHRd0cYuBJDl4D43I8LbdgO8fAsN0/5GzDiBIXWV7AuEJRLOGHJL7xH8a3EKys2UKQPp0hgT2KIKIKlJtz8AwSKBIdyuirNI0GgZUArjK5KQ31yipQINiWSjxXUOofKa15R9f0v1uLh5bjOaIVdf/7NPaUe+umCqZNriEdHH3owRhJ2FsMtxrwoCMrhy6KzRUuuoUi+pkIHxxAUigTlL4e7GTtjcxRnAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Bridged assets\"\n        title=\"Bridged assets\"\n        src=\"/static/202e9aa7f2a2fcb2021a8ca9d013a602/fcda8/bridged_tokens.png\"\n        srcset=\"/static/202e9aa7f2a2fcb2021a8ca9d013a602/12f09/bridged_tokens.png 148w,\n/static/202e9aa7f2a2fcb2021a8ca9d013a602/e4a3f/bridged_tokens.png 295w,\n/static/202e9aa7f2a2fcb2021a8ca9d013a602/fcda8/bridged_tokens.png 590w,\n/static/202e9aa7f2a2fcb2021a8ca9d013a602/efc66/bridged_tokens.png 885w,\n/static/202e9aa7f2a2fcb2021a8ca9d013a602/4c42d/bridged_tokens.png 896w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>You can see that each token’s bridge address is different from one another, which means that <code class=\"language-text\">LegacyBridge</code> is only limited to one deployment per token.</p>\n<h2 id=\"multibridge-starknettokenbridgesol\" style=\"position:relative;\">MultiBridge (<a href=\"(https://github.com/starknet-io/starkgate-contracts/blob/cairo-1/src/solidity/StarknetTokenBridge.sol)\"><code class=\"language-text\">StarknetTokenBridge.sol</code></a>)<a href=\"#multibridge-starknettokenbridgesol\" aria-label=\"multibridge starknettokenbridgesol permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>But deploying a bridge per token is quite troublesome, isn’t it? Ideally, it would be nice if a single bridge can handle multiple number of tokens, which means you don’t need to deploy a bridge every single time you want to bridge a new token.</p>\n<p>This bridge is the latest standard on Starknet for any newer tokens on Starknet. Any new tokens looking for being bridged should use this contract instead.</p>\n<p>The deployment of this bridge is managed by the StarkWare team themselves, so all you need to do is to enroll a token and use this bridge.</p>\n<h2 id=\"enroll-a-token-bridge\" style=\"position:relative;\">Enroll a token bridge<a href=\"#enroll-a-token-bridge\" aria-label=\"enroll a token bridge permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>The first thing to be done is to create an ERC20 token on Ethereum. The reason we don’t do it on Starknet is that Starknet bridge contract is going to create an ERC20 contract on Starknet for us automatically once we enroll a token bridge.</p>\n<p>Once you have your Ethereum ERC20 token address ready, you can use it to call <code class=\"language-text\">enrollTokenBridge</code>. Enrolling a new token bridge is permissionless. This means anyone can submit a transaction to enroll a new token bridge for any token with a small gas fee:</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:226px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarknet-io%2Fstarkgate-contracts%2Fblob%2F53c4939f05b3d122e4c904533f5fdb27457abcde%2Fsrc%2Fsolidity%2FStarkgateManager.sol%23L132-L138&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p>This relates to a few other contracts, namely <code class=\"language-text\">StarkgateRegistry.sol</code> and <code class=\"language-text\">StarkgateBridge.sol</code> (which is in fact inherited by Starknet core contract, <code class=\"language-text\">Starknet.sol</code>).</p>\n<p>Let us look at the implementation of <code class=\"language-text\">registryContract.enlistToken(token, bridge())</code>:</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:415px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarknet-io%2Fstarkgate-contracts%2Fblob%2F53c4939f05b3d122e4c904533f5fdb27457abcde%2Fsrc%2Fsolidity%2FStarkgateRegistry.sol%23L84-L99&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p>It checks if there is an existing bridge for a token, or a blocked token. If it passes that check, the <code class=\"language-text\">bridge</code> address is assigned to the corresponding <code class=\"language-text\">token</code> key in the <code class=\"language-text\">tokenToBridge</code> mapping. This way, the registry contract maintains a mapping of <code class=\"language-text\">token</code> to <code class=\"language-text\">bridge</code> mapping.</p>\n<p>Then, it calls <code class=\"language-text\">enrollToken</code>:</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:415px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarknet-io%2Fstarkgate-contracts%2Fblob%2F53c4939f05b3d122e4c904533f5fdb27457abcde%2Fsrc%2Fsolidity%2FStarkgateRegistry.sol%23L84-L99&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p>In <code class=\"language-text\">sendDeployMessage</code>, <code class=\"language-text\">sendMessageL2</code> is called, and the sequencer will pick up <code class=\"language-text\">deployMessagePayload(token)</code> and send it to the relevant <code class=\"language-text\">l1_handler</code> represented by <code class=\"language-text\">HANDLE_TOKEN_DEPLOYMENT_SELECTOR</code> at the contract address of <code class=\"language-text\">l2TokenBridge()</code> on L2:</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:310px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarknet-io%2Fstarkgate-contracts%2Fblob%2F53c4939f05b3d122e4c904533f5fdb27457abcde%2Fsrc%2Fsolidity%2FStarknetTokenBridge.sol%23L431-L441&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:1087px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarknet-io%2Fstarkgate-contracts%2Fblob%2F53c4939f05b3d122e4c904533f5fdb27457abcde%2Fsrc%2Fcairo%2Ftoken_bridge.cairo%23L1066-L1113&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p>The only important line is <code class=\"language-text\">deploy_syscall(class_hash, l1_token.into(), calldata.span(), false).unwrap_syscall();</code>. You are deploying a new ERC20 contract, which has initially been triggered by your call to <code class=\"language-text\">enrollTokenBridge</code>.</p>\n<p>Once this is complete, you will have an ERC20 contract on Starknet that corresponds to yours on Ethereum, joined together by Starknet bridge contract.</p>\n<h2 id=\"transfer-a-token-from-l1-to-l2-deposit\" style=\"position:relative;\">Transfer a token from L1 to L2 (deposit)<a href=\"#transfer-a-token-from-l1-to-l2-deposit\" aria-label=\"transfer a token from l1 to l2 deposit permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>For a token using the <em>legacy</em> bridge, either call <a href=\"https://github.com/starknet-io/starkgate-contracts/blob/5a10fd263d29cd032b7229691d043520edae0737/src/solidity/LegacyBridge.sol#L61\"><code class=\"language-text\">function deposit(uint256 amount, uint256 l2Recipient)</code></a> or <a href=\"https://github.com/starknet-io/starkgate-contracts/blob/5a10fd263d29cd032b7229691d043520edae0737/src/solidity/StarknetTokenBridge.sol#L285\"><code class=\"language-text\">deposit(address token, uint256 amount, uint256 l2Recipient)</code></a>. The legacy bridge is designed to support the legacy function with only two parameters for backward compatibility as well as the newest function signature with three parameters:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 471px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/00ea06cfd1bf134d1ee896238a35588c/1f09d/legacy_bridge_deposit_functions.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 154.72972972972974%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAfCAYAAADnTu3OAAAACXBIWXMAAAsTAAALEwEAmpwYAAACfklEQVRIx52Vy27bMBBF9QctUkd8U6Kett6PJLbbIkFboAa6KFA0X9FF/393C1KOE6Abi4tDQqAwmsuZuQqojMBMDRZX/+8eBFQXSNsn9IcTuv0J06cf2D/9hC6PeM873KgBN/J6ApthVo3YtjO4KR3CbEF1jlBlICsJKGeo6wpd14BxBsIICCWgjHoRMCFwSyhUpBEb48jy3MGkBBPrCKgQ2NUVmrbBMI0otiUIY6Cce+EyzIsCu6pC07UuoG+wS0CbkZUstUJsYkil3OEiWazCBYyMgUkTJFmGrChgsgxCay/pgV3q8/0N44BpnlBst5BaL1kKAbqCpcqUQigJIeUiXSmElC5ftS/y6wnskuY58rJcJOe5ezZpBi6ln+SqbXD3cI+269APPdq+Q5oXfgHdHdEQRgskiXEFStIEOoq8Ku1Gj9czxPwIqiKwl0L49iGlBPrLL2S//yCMUzBGzofMi6WxucQttWVXIFy5nQoNJtcTMJWiaB8xHU5o528Y998x7U/I6s94Rxt8ED1urC9eScCEQlK2yHc90rJFtu1Q1iO4ThHyCETEIPx6XFGm+wc8HD9imO8w7w/u2c71iy+SFbg+tH03jKObjk1IsAnDZY7fTsma0bPEie2/1BmsSSyJV/u4gEIpRHG8YF07SaDOjb1kuNZtmgb9MLy6za6CjCI/+3IZauXkWqlpliIytmL8Mk6r7cuagK2qtS2lF+fmSl2CrZxl7sz1cDygt5LvZoyTNdmdu9u1si8ZWoexuGqfZduCeP1TmFKQsYGOI+fYdhcvP6rVkimB/PoM8/wXG52AkBAhZU6qD4H1P55XkPUIpvT5S29M1RrsCv4BgmU+8Go1+8cAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Legacy bridge lagacy and new deposit functions\"\n        title=\"Legacy bridge lagacy and new deposit functions\"\n        src=\"/static/00ea06cfd1bf134d1ee896238a35588c/1f09d/legacy_bridge_deposit_functions.png\"\n        srcset=\"/static/00ea06cfd1bf134d1ee896238a35588c/12f09/legacy_bridge_deposit_functions.png 148w,\n/static/00ea06cfd1bf134d1ee896238a35588c/e4a3f/legacy_bridge_deposit_functions.png 295w,\n/static/00ea06cfd1bf134d1ee896238a35588c/1f09d/legacy_bridge_deposit_functions.png 471w\"\n        sizes=\"(max-width: 471px) 100vw, 471px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Here’s <a href=\"https://etherscan.io/tx/0x909c08e23c32f75e2c2a6195fcb73cf8984d5226642c10cc8bb56fbbb7100668\">an example transaction that deposits 69915.000000 USDC</a>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dd36336196463d5edbb4ec039b63d5c1/8bb81/deposit_usdc.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 17.567567567567565%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAsElEQVQY012PWxKDIAxF3ZCVp4BgAUGl+tP9b+Z2xL4/zhwyCTeTRmmNjlAQyqplr3DbdqxlQ5oXTHnGshbElOvMpSOV159/Gsr4TyBlEtdQoEyE1AE+FoS8w/oV0kT0wwRlE4QOaDuFlug3F2rQfG863xLaJji/QChfw2PesZQ7nF8xhlJ9YFzCMM4w9jQVI5pP0GkuJKaUMVgHQjmOC06L2mP8QFQfNRc92NOEcTwAXaqD5KcN108AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"deposit_usdc.png\"\n        title=\"deposit_usdc.png\"\n        src=\"/static/dd36336196463d5edbb4ec039b63d5c1/fcda8/deposit_usdc.png\"\n        srcset=\"/static/dd36336196463d5edbb4ec039b63d5c1/12f09/deposit_usdc.png 148w,\n/static/dd36336196463d5edbb4ec039b63d5c1/e4a3f/deposit_usdc.png 295w,\n/static/dd36336196463d5edbb4ec039b63d5c1/fcda8/deposit_usdc.png 590w,\n/static/dd36336196463d5edbb4ec039b63d5c1/efc66/deposit_usdc.png 885w,\n/static/dd36336196463d5edbb4ec039b63d5c1/c83ae/deposit_usdc.png 1180w,\n/static/dd36336196463d5edbb4ec039b63d5c1/8bb81/deposit_usdc.png 1602w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>For a token that uses the new bridge, call <a href=\"https://github.com/starknet-io/starkgate-contracts/blob/5a10fd263d29cd032b7229691d043520edae0737/src/solidity/StarknetTokenBridge.sol#L285\"><code class=\"language-text\">deposit(address token,uint256 amount,uint256 l2Recipient)</code></a>. The new bridge, also called MultiBridge, is capable of handling multiple tokens with just one bridge, unlike the legacy bridge. It is deployed at <a href=\"https://etherscan.io/address/0xF5b6Ee2CAEb6769659f6C091D209DfdCaF3F69Eb#writeProxyContract\"><code class=\"language-text\">0xF5b6Ee2CAEb6769659f6C091D209DfdCaF3F69Eb</code></a> on Ethereum.</p>\n<p><a href=\"https://etherscan.io/tx/0xa032e66a591fb08cb3b1e2329fe495d922d7369243f3876fd9a43c865cfbfd56\">Here’s an example transaction that deposits 1,277.777777777777777776 ZEND</a>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ef96998f39776d48a7a03b89413b3133/705cc/deposit_zend.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 116.21621621621622%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsTAAALEwEAmpwYAAADiklEQVQ4y4VUyY7jRgz1N/R0W1KpdklVWrxIlmz3lp7BZJDLAHMJgvz/l7yAlGR3DkEOD6yVxXp85EZ9/IJ9+YG2bVDVDeq2RRkj0lwiW5D+BzKpIJSCkAq5NlDGYiPbE0xzhPcFlHEQysD7EiFElIQqoIr1DYFsmMfkYH5YMcjpxlmLsiiQK4M0V9h+2SL99grx6w9Y42GLEtaX/BhBW3+DyBWSLGdsUwGpLTauqFCGgFRIJJlEkgrY/QH1dMV4ecH71+9slbaQSjNyqZkKckT35rv57FC7kr/l/Bwlhe5cgRgbxLpF3bQIdYN2f0QZ6hmx5ajprJCaQWPJHFoP4zw7lPRtISG14TXrChhXwPoCod3DFAG2auBjB+0rZOLO33zPYsOHYw1tHb9EUTK0vY+Vue2JxcEa3e2M1MzxxhHpzvMLGZMs4OsdmvEFsT+jJgyEC+LhxJFTdo31kM4jk/rGI0dIXmmyTZdsZTmsMWjqGrE7oGwPiP2EeJwQ9gO6fkSz71GFCF0FpORwyTQ7JI6KsppRBSgpIU8fKH78hfbQc0Kk8VDW85doLM1Cz4I1MbS+Ia/iEx/bJEV1PKP79hPt6YrmMMCWkZNhQwsXGsjhJ+T5T6jr3xDNG7ZJwj9jYavltVSoW/rLsporo9mxgGdJuBtyU0GYAGEDhPafIrTY+KJEjDWTnTGXgrM+nEZMl2fEpkPVdLy+VgUlLmVks12EzRGSQEnYXEpyFnZRRXT7Awu77XbYsajDTVp07o47h4tsKnagF9IJNA91C1cGTgbtGV9Cu+Jftcx3VhjP+4uwI+jrFME2zWaH3FUi642++5RkeNqmeHxK8LhN2NLa5+ZASeUvrxe1cbxZhYD+NGG6vqAfz9gfBwzjhOMw8pjsYRg5orVBzBwuOqRq8QuyXKOua4yXZ4zXV5wuzziezujHEf04YZguNxAt1HVypbnJfqrlyM1hDZ26yen8iu44odkd0ex6dIcR0lZ4eMzwuBX4shV4SiUSYWZkeo5wbpqOX5hLMIMpDyjad8hiQnf6jmr4Ha77gNt9QNVvjMSNeBA7PIj9YncQusKGWv5TsmpsdpjbBtXuDa6+IOxeUR/e0Q1f0Rx/g6+vKJrn2bbPKAndC89J8Jtc2VunEUvnoCz3pxHOV6B9rhA9Y5WRMnfJrHOuZU2NlLv1XHZULbl2MGXkJrq2pv/FkuV/AOtYgMjL6eHQAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"deposit_usdc.png\"\n        title=\"deposit_usdc.png\"\n        src=\"/static/ef96998f39776d48a7a03b89413b3133/fcda8/deposit_zend.png\"\n        srcset=\"/static/ef96998f39776d48a7a03b89413b3133/12f09/deposit_zend.png 148w,\n/static/ef96998f39776d48a7a03b89413b3133/e4a3f/deposit_zend.png 295w,\n/static/ef96998f39776d48a7a03b89413b3133/fcda8/deposit_zend.png 590w,\n/static/ef96998f39776d48a7a03b89413b3133/efc66/deposit_zend.png 885w,\n/static/ef96998f39776d48a7a03b89413b3133/705cc/deposit_zend.png 1071w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Do note that <code class=\"language-text\">l2recipient</code> is a <code class=\"language-text\">uint256</code> variable because <code class=\"language-text\">felt252</code> needs to fit in the variable. <code class=\"language-text\">address</code> won’t do it because it’s only 20 bytes, whereas <code class=\"language-text\">felt252</code> will need 31 bytes. <code class=\"language-text\">uint256</code> containing 32 bytes is deemed to be a suitable choice to contain <code class=\"language-text\">felt252</code> variable. For those who are new with Starknet, <code class=\"language-text\">felt252</code> is a variable type that can be declared in Cairo that is used to represent many things on Starknet.</p>\n<h3 id=\"deposit-code-examination\" style=\"position:relative;\">Deposit code examination<a href=\"#deposit-code-examination\" aria-label=\"deposit code examination permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Now, let’s examine the <code class=\"language-text\">deposit</code> function. The legacy and new ones essentially function in the same way, so we will only look into the new function.</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:667px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarknet-io%2Fstarkgate-contracts%2Fblob%2F5a10fd263d29cd032b7229691d043520edae0737%2Fsrc%2Fsolidity%2FStarknetTokenBridge.sol%23L285-L312&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p>First, notice that the function is <code class=\"language-text\">payable</code>, although we are depositing an ERC20 token. This is because we need to use Ether as a fee for deposit. The fee will be used by the sequencer to send the message to L2. The gas used in the deposit transaction cannot be directly used as a fee for depositing into L2. <sup id=\"fnref-3\"><a href=\"#fn-3\" class=\"footnote-ref\">3</a></sup></p>\n<p>Then, <code class=\"language-text\">acceptDeposit</code> checks if the fee is enough and transfers the specified amount of token into the contract:</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:226px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarknet-io%2Fstarkgate-contracts%2Fblob%2F5a10fd263d29cd032b7229691d043520edae0737%2Fsrc%2Fsolidity%2FStarknetTokenBridge.sol%23L152-L158&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p>The allowed range of fee is in fact hardcoded into <a href=\"https://github.com/starknet-io/starkgate-contracts/blob/5a10fd263d29cd032b7229691d043520edae0737/src/solidity/Fees.sol#L1-L29\"><code class=\"language-text\">Fee</code> contract</a>.</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:688px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarknet-io%2Fstarkgate-contracts%2Fblob%2F5a10fd263d29cd032b7229691d043520edae0737%2Fsrc%2Fsolidity%2FFees.sol%23L1-L29&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p>This implies that it’s not actually an estimation, but just a hardcoded value. So you don’t need to call <a href=\"https://github.com/starknet-io/starkgate-contracts/blob/5a10fd263d29cd032b7229691d043520edae0737/src/solidity/StarknetTokenBridge.sol#L143\"><code class=\"language-text\">estimateDepositFee</code></a> to ‘estimate’ it. You can just hardcode your fee at some small amount of Ether that falls within <code class=\"language-text\">MIN_FEE</code> and <code class=\"language-text\">MAX_FEE</code>.</p>\n<p>After checking the fee, we call <code class=\"language-text\">sendDepositMessage</code>:</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:562px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarknet-io%2Fstarkgate-contracts%2Fblob%2F5a10fd263d29cd032b7229691d043520edae0737%2Fsrc%2Fsolidity%2FStarknetTokenBridge.sol%23L443-L465&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p><code class=\"language-text\">require(l2TokenBridge() != 0, \"L2_BRIDGE_NOT_SET\");</code> checks whether the L2 bridge address is set. In the case of MultiBridge, this will be the corresponding MultiBridge contract (<a href=\"https://github.com/starknet-io/starkgate-contracts/blob/5a10fd263d29cd032b7229691d043520edae0737/src/cairo/token_bridge.cairo\">token_bridge.cairo</a>) on Starknet, currently deployed at <a href=\"https://starkscan.co/contract/0x0616757a151c21f9be8775098d591c2807316d992bbc3bb1a5c1821630589256\">0x0616757a151c21f9be8775098d591c2807316d992bbc3bb1a5c1821630589256</a>.</p>\n<p>Then, we make sure the amount is non-zero by writing <code class=\"language-text\">require(amount > 0, \"ZERO_DEPOSIT\")</code>.</p>\n<p>The next line is possible due to <code class=\"language-text\">using UintFelt252 for uint256;</code> directive at the top of the contract code. <code class=\"language-text\">UintFelt252</code> is a small library to manage <code class=\"language-text\">Felt252</code> data type. So we just make sure that <code class=\"language-text\">l2Recipient</code> is a valid L2 address by writing <code class=\"language-text\">require(l2Recipient.isValidL2Address(), \"L2_ADDRESS_OUT_OF_RANGE\");</code>.</p>\n<p>If you have been following well, you should notice that <code class=\"language-text\">bool isWithMsg = selector == HANDLE_DEPOSIT_WITH_MESSAGE_SELECTOR;</code> should be <code class=\"language-text\">false</code>, because the <code class=\"language-text\">selector</code> that is being passed down is <code class=\"language-text\">HANDLE_TOKEN_DEPOSIT_SELECTOR</code> which is not <code class=\"language-text\">HANDLE_DEPOSIT_WITH_MESSAGE_SELECTOR</code> because we don’t have any <code class=\"language-text\">message</code> - it is an empty array.</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:604px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarknet-io%2Fstarkgate-contracts%2Fblob%2F5a10fd263d29cd032b7229691d043520edae0737%2Fsrc%2Fsolidity%2FStarknetTokenBridge.sol%23L389-L413&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p>We create a payload using <code class=\"language-text\">depositMessagePayload</code> function. Everything that is relevant to the transaction (in this case, deposit) that the user is making needs to be included in the payload, because it will be an input to generate a hash that represents L1 to L2 message hash.</p>\n<p>Failure to include all relevant information in the payload will result in a message hash from which certain information cannot be confirmed. For example, if you deposited 500 USDC but if the amount of 500 USDC is not reflected in the hash, there is no proof on blockchain that you deposited 500 USDC anymore.</p>\n<p>When <code class=\"language-text\">withMessage == false</code>, the <code class=\"language-text\">payload</code> would be <code class=\"language-text\">[token, msg.sender, l2Recipient, amountLow, amountHigh]</code>. The reason we encode the amount into low and high variables is that the amount is a variable of type <code class=\"language-text\">uint256</code>, which means it cannot be represented by <code class=\"language-text\">felt252</code> which is only 31 bytes. To be able to represent that information on Starknet, we divide it into two variables, which would have been fine if we were to only care about Ethereum.</p>\n<p>If <code class=\"language-text\">withMessage == true</code>, the <code class=\"language-text\">payload</code> would contain <code class=\"language-text\">[token, msg.sender, l2Recipient, amountLow, amountHigh, message.length, message[0], message[1], ..., message[message.length - 2], message[message.length - 1]]</code>. As such, a user can send an arbitrary length of message along with the token.</p>\n<p>Finally, we call <code class=\"language-text\">sendMessageToL2</code> from the Starknet core contract. Let’s look at how <code class=\"language-text\">sendMessageToL2</code> is implemented in that contract:</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:415px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarkware-libs%2Fcairo-lang%2Fblob%2Fefa9648f57568aad8f8a13fbf027d2de7c63c2c0%2Fsrc%2Fstarkware%2Fstarknet%2Fsolidity%2FStarknetMessaging.sol%23L110-L125&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p>The function first increments the <code class=\"language-text\">nonce</code>. The <code class=\"language-text\">nonce</code> is very important in this context, because it prevents the transactions of the same payload to be differentiated from one another. Remember that the <code class=\"language-text\">payload</code> can contain <code class=\"language-text\">[token, msg.sender, l2Recipient, amountLow, amountHigh]</code> in its simplest form. Then, if the <code class=\"language-text\">msg.sender</code> sends the same <code class=\"language-text\">amount</code> of a <code class=\"language-text\">token</code> to the same <code class=\"language-text\">l2Recipient</code> more than once, the same message hash will be produced if a unique nonce is not included in the hash.</p>\n<p>After incrementing the nonce, the hash is derived by using <code class=\"language-text\">getL1ToL2MsgHash</code>:</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:457px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarkware-libs%2Fcairo-lang%2Fblob%2Fefa9648f57568aad8f8a13fbf027d2de7c63c2c0%2Fsrc%2Fstarkware%2Fstarknet%2Fsolidity%2FStarknetMessaging.sol%23L88-L105&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p>Notice that everything related to the current transaction is included in the hash to avoid any hash collisions.</p>\n<p>Once Starknet sequencer detects the transaction by waiting for enough L1 confirmations for it, it initiates the desired L2 transaction by invoking the relevant function in <code class=\"language-text\">token_bridge.cairo</code> marked with <code class=\"language-text\">#[l1_handler]</code>.</p>\n<p>Depending on the existence of the message, the sequencer will pick up the transaction and call <code class=\"language-text\">handle_deposit</code> or <code class=\"language-text\">handle_deposit_with_message</code>:</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:436px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarknet-io%2Fstarkgate-contracts%2Fblob%2F5a10fd263d29cd032b7229691d043520edae0737%2Fsrc%2Fcairo%2Ftoken_bridge.cairo%23L1009-L1025&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:877px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarknet-io%2Fstarkgate-contracts%2Fblob%2F5a10fd263d29cd032b7229691d043520edae0737%2Fsrc%2Fcairo%2Ftoken_bridge.cairo%23L1027-L1064&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p>The first thing to note is that <code class=\"language-text\">only_from_l1_bridge</code> asserts that the deposit is always from the L1 bridge. <code class=\"language-text\">l1_handler</code>’s first parameter is always the address of the L1 contract that initiated the transaction, which is being used to validate <code class=\"language-text\">only_from_l1_bridge</code>. Failure to do so will directly result in a security vulnerability, because anyone can forge a deposit payload and call <code class=\"language-text\">sendMessageToL2</code> in the Starknet core contract with it. That means anyone might be able to mint a token to L2 without having to prove that they have a token on L1.</p>\n<p>The only authoritative deposit is from the L1 bridge, which is a separate contract from the core contract. The L1 bridge could be any of the addresses specified as <code class=\"language-text\">l1_bridge_address</code> at <a href=\"https://github.com/starknet-io/starknet-addresses/blob/master/bridged_tokens/mainnet.json\">https://github.com/starknet-io/starknet-addresses/blob/master/bridged_tokens/mainnet.json</a>.</p>\n<p>In case of <code class=\"language-text\">handle_token_deposit</code>, we just need to increase the token balance of the <code class=\"language-text\">l2_recipient</code>. This is done by <code class=\"language-text\">handle_deposit_common</code>:</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:331px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarknet-io%2Fstarkgate-contracts%2Fblob%2F5a10fd263d29cd032b7229691d043520edae0737%2Fsrc%2Fcairo%2Ftoken_bridge.cairo%23L362-L373&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p><code class=\"language-text\">permissioned_mint</code> is a function that is present in the ERC20 contract deployed by Starknet core contract. We will cover this later on. For now, it’s enough to know that it mints a token to <code class=\"language-text\">l2_recipient</code>.</p>\n<p>If a deposit contains a message, <code class=\"language-text\">handle_deposit_with_message</code> will be invoked instead. After calling <code class=\"language-text\">handle_deposit_common</code>, the next procedure is just invoking <code class=\"language-text\">on_receive</code> of <code class=\"language-text\">l2_recipient</code> with the calldata containing the information about the deposit, which is <code class=\"language-text\">[l2_token, amount, depositor, message]</code>.</p>\n<p><a href=\"https://docs.starknet.io/documentation/tools/starkgate-automated_actions_with_bridging/\">This feature is called ‘smart deposit’</a>, where the deposit moves funds from L1 to L2 and then triggers subsequent actions. If <code class=\"language-text\">on_receive</code> isn’t implemented or fails to return <code class=\"language-text\">true</code>, <code class=\"language-text\">handle_deposit_with_message</code> will not succeed, and the fund will have to be recovered with <a href=\"https://github.com/starknet-io/starkgate-contracts/blob/5a10fd263d29cd032b7229691d043520edae0737/src/solidity/StarknetTokenBridge.sol#L535\"><code class=\"language-text\">depositWithMessageCancelRequest</code></a> because there is no way it can be received by <code class=\"language-text\">l2_recipient</code> anymore.</p>\n<p>Once one of these <code class=\"language-text\">l1_handler</code>s successfully run, the <code class=\"language-text\">l2_recipient</code> should be able to see the increase in the amount of the token on its wallet.</p>\n<p>Later on, <code class=\"language-text\">l1ToL2Messages</code> are processed altogether at the same time at the Starknet core contract, when the state is being updated to reflect the relevant transaction that just happened on L2:</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:226px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarkware-libs%2Fcairo-lang%2Fblob%2Fefa9648f57568aad8f8a13fbf027d2de7c63c2c0%2Fsrc%2Fstarkware%2Fstarknet%2Fsolidity%2FStarknet.sol%23L234-L240&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p>The <code class=\"language-text\">programOutput</code> is the execution result of StarkNet OS program that encompasses multiple Cairo programs that were processed at a time.</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:1864px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarkware-libs%2Fcairo-lang%2Fblob%2Fefa9648f57568aad8f8a13fbf027d2de7c63c2c0%2Fsrc%2Fstarkware%2Fstarknet%2Fsolidity%2FOutput.sol%23L76-L160&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p><code class=\"language-text\">processMessages</code> will enter the <code class=\"language-text\">else</code> branch at line 116. Then, <code class=\"language-text\">msgFeePlusOne</code> for each message will be accessed to add to <code class=\"language-text\">totalMsgFees</code>. Right after that, <code class=\"language-text\">messages[messageHash] = 0</code> to specify that the corresponding message has been consumed to L2.</p>\n<h2 id=\"transfer-a-token-from-l2-to-l1-withdraw\" style=\"position:relative;\">Transfer a token from L2 to L1 (withdraw)<a href=\"#transfer-a-token-from-l2-to-l1-withdraw\" aria-label=\"transfer a token from l2 to l1 withdraw permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>The withdrawal begins by calling either <code class=\"language-text\">initiate_withdraw</code> or <code class=\"language-text\">initiate_token_withdraw</code> in <code class=\"language-text\">token_bridge.cairo</code>:</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:1234px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarknet-io%2Fstarkgate-contracts%2Fblob%2F5a10fd263d29cd032b7229691d043520edae0737%2Fsrc%2Fcairo%2Ftoken_bridge.cairo%23L478-L532&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p><a href=\"https://starkscan.co/tx/0x03a968865e46941194dd7236f3f663aafc9e8468f6e9b83b5d8729404ac9f71c\">Here’s a transaction that calls <code class=\"language-text\">initiate_withdraw</code> for 207.59 USDC</a>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/628c029ce2f79a5d3af2fbf44e888df4/d2a60/initiate_withdraw_usdc.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 115.54054054054055%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsTAAALEwEAmpwYAAADeUlEQVQ4y41Uy47kNBTNEiFEdXee5Twd5+k4jlOpV3ePZjHDNGLBYjQCFmgWwIp/Yc8fwb/wEwfZqadKLc3i6KZc8fW555zYSpoJRb9HWCo4KYebdab6eQ8mH8H6PWi3QdZtTlUjF1tkfINlMcCl/Yy0g0UKBT+XuI8a2AmHnbR4iDlsxnFXUNw1Jdy2hy8VPDEg3axBV2vcLyvchxUeSImFk+IuoGa/5SR8ZpZ2M7IObtLCqRTYy+/I+PdYhAx2VMKJKoQ5R1wNcAoFt93DV29Rf/wM9uZn08eKqhFpuzbdH+IWdtKZUx35Bp//An787R8sxISiW4EVNb6yCb4uJOzdB7jvfgL5+Ac+/Qfs/v4Xd34OS2unm16ydNIWAZswPP6J6vlXBPIZfjXBpRJOJuAyBbcY4dVbeGxA9P4Twg+/wElaWJpdpZ7g0/5kiqsr7WEzYda8fITHRgTVGkE1YalrOWFZTgjyHrZPDfReK2lWKOUeXiZuXI6bCaTozQRRpQyDGxwOP7kc13NDbf9VQzqgki8oxDvEjUJSj4a5EzcGZpKsO5t5gBm5Vk8gumHCDxrODZvxB5T9C0j+DC9X8JkC4Xv4/Ok6GZcNNTNSKuOwfskxWZyZRrWcxy3eIuV7JHyLaPUdyPj+MDK/gRXXI0r5aL4C92LkJesRtTu41R7LeoWw2SKod8j5hKTZGFNOub2ApT+9ZnyeP73k7LJHJUirm23nZrlOQfeqdqeRtcvVcKHhiaGE/u8cpS+DYZh326vFY2wKuTeH6RQk7RZRO48dsOF1U9JGazKdjDi73IP1O5TDo2mY8fXrzC5kMCNf6XfQUGumx/aogE+FqVf6HZ4N04PDp2Dr0+3kHBnzbJjOG05rR6TH3x1IreArZe5INxOwvKRFlEn4pEcQChBSgpACASmxpAIhFVh4FN+6t1i4FPdLhm+CFLkm1qxgOXELN2rg6Rq3pmr4uiYc/hcgZBJhI7GkvWbIQTKOKBfwsgF2KuFqxlrHrDcvXUKvBZk4PAsQKpHyCVE/wk/1yJlA1q6N8NoMfQloMwiT0AnQwntHU1KOqF6ZmAV03rfU5uUSIRvgaw21M6wekTJpRM4aCVKI+fpSawT9iECoGb0CEfOBXtZdpcA3E3awvLRDcrjLdMO47JBW3DgWdApuLuDEt5fA8SK5rDo2/wP/uYyzxrw3egAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Initiate withdraw USDC\"\n        title=\"Initiate withdraw USDC\"\n        src=\"/static/628c029ce2f79a5d3af2fbf44e888df4/fcda8/initiate_withdraw_usdc.png\"\n        srcset=\"/static/628c029ce2f79a5d3af2fbf44e888df4/12f09/initiate_withdraw_usdc.png 148w,\n/static/628c029ce2f79a5d3af2fbf44e888df4/e4a3f/initiate_withdraw_usdc.png 295w,\n/static/628c029ce2f79a5d3af2fbf44e888df4/fcda8/initiate_withdraw_usdc.png 590w,\n/static/628c029ce2f79a5d3af2fbf44e888df4/d2a60/initiate_withdraw_usdc.png 807w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Do note that this is from some time ago, on Feb 9, 2023, which is the reason that the transaction is a call to the legacy function <code class=\"language-text\">initiate_withdraw</code>. But the upgraded legacy bridges also now support <code class=\"language-text\">initiate_token_withdraw</code>, which has the exact same functionality. Although the legacy function still works, it is left there for backward compatibility. Any new applications should strive to use <code class=\"language-text\">initiate_token_withdraw</code> wherever possible.</p>\n<p><a href=\"https://starkscan.co/tx/0x032867dac0df25cca3f17c1008727abded40b4316c12e63e8a2342306c7d6d42\">So here’s a transaction that calls <code class=\"language-text\">initiate_token_withdraw</code> on 54230 USDC</a>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 587px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d221783fa1aaa9e17f467c2605620592/d72eb/initiate_token_withdraw_usdc.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 142.56756756756758%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAdCAYAAACqhkzFAAAACXBIWXMAAAsTAAALEwEAmpwYAAAErElEQVRIx3VWyY4cRRCtEwJZ9nimu/Y1a8+tlunqZWbaDCBkYwEWAokDHODKh3DiEzggfoLfeyijqntmDD48ZVZ2ZmREvBeRbTGxR7f9HKXcIiw7RFWPqOqQ1AP05gg9vYIY76CWuYGcjuh2nxKa/nA+Y2ClzTWqwy2CfsA6FrAziXUiYOcSgRrh6wGBGBCpEVE3ItY7xPUGXq7h5R1cpuCmCk4qsU4lrFXMscoF1sVsyCzOBhVe5g0uihoXrIEne+j7I9ppDzuVuIwarFOBq5Tjo6TCJ0lN61ZY9kiaa/pwshlurvHCzfH125/xx+9/4Zs3P4E/b7G7mhC5GlGxRZpv8dIV8FYSP2av8SY8YhVxWGE1IOUT3XaCwxSeORm+e/cL/v7zH3z/7a/IL1twZwPf75E3tyibW6z9HsyZ8Fv2Dj8EX+Iy4LByMaEZbpacqPPolz18cYDb7uDxPcL+FfzuDrE2OCKSt0j7e8Ryh49ZjWeshZ9rWLncQu/uEVb9HK5JMlOU8FjcwC962kgXMYPTpXrexxTCXCNg87eVywn8+u6Rh/Mmv+hQ9we04w34eIe6vzkberL3PVhRNdDmpDXECPLSJnIUcvkaufyK1ldxi3XCsTZj3BKJdvZfWGl7jULvzwyfmWYadXdEpY/Imi+QiAMhG+6RbN+QEpzl4sfnZtm0G2LWXhbtJZcp3yBuNwjLHRK+QyL2SNQtIv2KDJ6k9sRDJiZ0+8+IaZfJmQCT6LID07fw5RGZOiAWB0R8j7rbIZN7hFQt/5NDE3I73sHokTxkSwhMIzBy4XtEzUSXPeT3w7CiekDVHUg2FMJi0DCZNONMRMKJGCLthA8ZNCEbD8+6ymcd+oWmi05gco9E7BCKG4T8gLAez/s99gASdrmwfDLmLuLl16ZN3UNsjjSP6hFe0cMrB3jFg7Ddxzks5JbYdJcwvYWUoOyQ8Q2RE5Q9jBrmCyU8wkM0bqboPFWKOWQ8tDPxhH6SEVPUzmzqdUveTI4XmH1xPSIcR7BxT3PLSTjifIAbanhRBz/SCMMaXlAhDCsEQQU34UjrAauwxnM7wwuHnXHplXgR5lhFNeRwB2ttGmXYwA5b2JGBmddwogZuzOHGLZyYwzMexpz2OHF7Hs35IDMkSqTN4mGYCcS5Ca/DOjVdpycDQd6R0H3WUZ58pgmnuZcpAmsnJOMGgXlTzFswd2yBqBrh5T3WiXwCOxFI6hF+3lHtpu1ErczkLDCsk3FNv1uGHa53CJhCqTdo+wGFkCilQqUUGq0QFAqF2lI1mcOMT+R5aggpeoRFR4VhYJkHaRW1WMWCJGGnLZyMP4Fh2GcKda4Q7CY4w4h1pbGqFNa1JlwmHObBs0wZzVqSpDmHSTL8FAqmRE2+SMR1B6/p4LX9GU4+l6xlcpcWHdK8Q9polFISqmWstSQGo7JHVmj4eiQD9qLPGeLcyijklzHHVcJJrBchx0UocBkJXMVm5FglhnENlkr4wzW86w0c2cORAxzRE1bmxUzETAqreiqlrO1QiJmMuFbn4jf5i8UIT49zmSVyKbdHWHoA5TBkmv5KmIMRhWfmktZOMB3aq2bZPF5/H/8CQ3c7Nr0Gmd4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Initiate withdraw USDC\"\n        title=\"Initiate withdraw USDC\"\n        src=\"/static/d221783fa1aaa9e17f467c2605620592/d72eb/initiate_token_withdraw_usdc.png\"\n        srcset=\"/static/d221783fa1aaa9e17f467c2605620592/12f09/initiate_token_withdraw_usdc.png 148w,\n/static/d221783fa1aaa9e17f467c2605620592/e4a3f/initiate_token_withdraw_usdc.png 295w,\n/static/d221783fa1aaa9e17f467c2605620592/d72eb/initiate_token_withdraw_usdc.png 587w\"\n        sizes=\"(max-width: 587px) 100vw, 587px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Mainly, two things are happening:</p>\n<ol>\n<li>The L2 token is being burnt by <code class=\"language-text\">permissioned_burn</code>.</li>\n<li>A message is being sent to L1 by <code class=\"language-text\">send_message_to_l1_syscall</code>. The message payload always contains <code class=\"language-text\">[0, l1_recipient, l1_token, amount]</code>. <code class=\"language-text\">0</code> is used to mean a ‘transfer from Starknet’.</li>\n</ol>\n<p>Once the message arrives at L1, its hash will be stored in <a href=\"https://github.com/starkware-libs/cairo-lang/blob/efa9648f57568aad8f8a13fbf027d2de7c63c2c0/src/starkware/starknet/solidity/StarknetMessaging.sol#L43-L45\"><code class=\"language-text\">l2ToL1Messages</code></a> (which in the body of <code class=\"language-text\">function processMessages</code> below, is supplied as a parameter called <code class=\"language-text\">messages</code>):</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:394px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarkware-libs%2Fcairo-lang%2Fblob%2Fefa9648f57568aad8f8a13fbf027d2de7c63c2c0%2Fsrc%2Fstarkware%2Fstarknet%2Fsolidity%2FOutput.sol%23L102-L116&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p>Starknet core contract will iterate through every message from L2 to L1 and store each in its <code class=\"language-text\">messageHash</code>. We observe that <code class=\"language-text\">messages[messageHash] += 1;</code> because we want to signify that the message has been received. It is possible that <code class=\"language-text\">messages[messageHash] > 1</code> in case of the same withdrawal request. Also, note that we do not have a <code class=\"language-text\">nonce</code> here unlike deposit. The reason is that we don’t need to differentiate one withdrawal from another if they are of the same <code class=\"language-text\">l1_recipient</code>, <code class=\"language-text\">l1_token</code> and <code class=\"language-text\">amount</code>.</p>\n<p>As for deposit, <code class=\"language-text\">nonce</code> makes each instance of deposit unique. For example, if you deposited 500 USDC at 3PM and another 500 USDC at 4PM with the exact same <code class=\"language-text\">l2_recipient</code>, somehow the deposit at 4PM might have worked and 3PM might have not. In that case, the two deposits are not the ‘same’ anymore, and the distinct instance of deposit at 3PM needs to be cancelled. As per the dev’s comment:</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:121px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarkware-libs%2Fcairo-lang%2Fblob%2Fefa9648f57568aad8f8a13fbf027d2de7c63c2c0%2Fsrc%2Fstarkware%2Fstarknet%2Fsolidity%2FStarknetMessaging.sol%23L121-L122&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p>On the other hand, withdrawal cannot be cancelled, so there is no reason to keep track of <code class=\"language-text\">nonce</code> for it.</p>\n<p>Once <code class=\"language-text\">processMessages</code> is triggered by the sequencer to update the state, the withdrawal request should now be placed in <a href=\"https://github.com/starkware-libs/cairo-lang/blob/efa9648f57568aad8f8a13fbf027d2de7c63c2c0/src/starkware/starknet/solidity/StarknetMessaging.sol#L43-L45\"><code class=\"language-text\">l2ToL1Messages</code></a>. If so, <code class=\"language-text\">recipient</code> at L1 can now call <code class=\"language-text\">withdraw</code> to claim the bridged token:</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:478px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarknet-io%2Fstarkgate-contracts%2Fblob%2F5a10fd263d29cd032b7229691d043520edae0737%2Fsrc%2Fsolidity%2FStarknetTokenBridge.sol%23L482-L500&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p>We can see that <code class=\"language-text\">consumeMessage</code> just creates the payload that we saw in <code class=\"language-text\">initiate_token_withdraw</code> already and calls <code class=\"language-text\">consumeMessageFromL2</code>. <code class=\"language-text\">TRANSFER_FROM_STARKNET</code> is set to <code class=\"language-text\">0</code>, which is in line with what we have done on L2:</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:373px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarknet-io%2Fstarkgate-contracts%2Fblob%2F5a10fd263d29cd032b7229691d043520edae0737%2Fsrc%2Fsolidity%2FStarknetTokenBridge.sol%23L467-L480&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p>Finally, <code class=\"language-text\">consumeMessageFromL2</code> at Starknet core contract derives the hash with <code class=\"language-text\">keccak256(abi.encodePacked(fromAddress, uint256(uint160(msg.sender)), payload.length, payload))</code>. If the hash exists, we subtract 1 away from <code class=\"language-text\">l2ToL1messages[msgHash]</code> to tell that this <code class=\"language-text\">msgHash</code> has been fully consumed.</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:478px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarkware-libs%2Fcairo-lang%2Fblob%2Fefa9648f57568aad8f8a13fbf027d2de7c63c2c0%2Fsrc%2Fstarkware%2Fstarknet%2Fsolidity%2FStarknetMessaging.sol%23L127-L145&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<!-- TODO: figure how?? -->\n<!-- You might be wondering then, how is ['one-click withdrawal'](https://www.starknet.io/en/content/simple-guide-on-starkgate-1click-withdraw) implemented if you would need to include `msg.sender` as an input to the hash? One-click withdrawal is a feature offered by SpaceShard team, where once you `initiate_token_withdraw` from L2, you don't need to submit another `withdraw` transaction on L1, given you pay a small amount of service fee to their relayer.   -->\n<p>Once the message is consumed, the fund is transferred to the <code class=\"language-text\">recipient</code> suing <code class=\"language-text\">transferOutFunds</code>. At this point the <code class=\"language-text\">recipient</code> should be able to see a change in the balance on its wallet.</p>\n<h3 id=\"indexing-withdrawal-initiations\" style=\"position:relative;\">Indexing withdrawal initiations<a href=\"#indexing-withdrawal-initiations\" aria-label=\"indexing withdrawal initiations permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Now, if you are an dApp builder who wants to provide withdrawal functionality to users, you would need to track the calls to <code class=\"language-text\">initiate_token_withdraw</code> at L2 because users will need to use the parameters of <code class=\"language-text\">initiate_token_withdraw</code> as an input to generate message hash to access <code class=\"language-text\">l2ToL1messages</code> later on L1.</p>\n<p>This means you would need some off-chain indexer that does this. You can simply keep track of the event emitted from <code class=\"language-text\">initiate_token_withdraw</code>, which is:</p>\n<iframe frameborder=\"0\" scrolling=\"no\" style=\"width:100%; height:310px;\" allow=\"clipboard-write\" src=\"https://emgithub.com/iframe.html?target=https%3A%2F%2Fgithub.com%2Fstarknet-io%2Fstarkgate-contracts%2Fblob%2F5a10fd263d29cd032b7229691d043520edae0737%2Fsrc%2Fcairo%2Ftoken_bridge.cairo%23L199-L209&style=atom-one-dark&type=code&showBorder=on&showLineNumbers=on&showFileMeta=on&showFullPath=on&showCopy=on\"></iframe>\n<p>Then, the indexer would at times query <code class=\"language-text\">l2ToL1messages[msgHash]</code> to see if the message is ready for consumption at L1 by constructing <code class=\"language-text\">msgHash</code> from the information given from <code class=\"language-text\">WithdrawInitiated</code> events. If <code class=\"language-text\">l2ToL1messages[msgHash] > 0</code>, the frontend can display an option to submit a transaction for <code class=\"language-text\">withdraw</code> at L2.</p>\n<p>In fact, this is the current implementation of <a href=\"https://starkgate.starknet.io/\">Starkgate</a>, a full-stack bridge software maintained by StarkWare. It constantly checks if you have a pending withdrawal by querying an off-chain indexer hosted at <code class=\"language-text\">starkgate.starknet.io/transfer-log/api/*</code> once you enter the website and connect your wallets:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/40da3801ba3d2b2805d90c46e4d216e9/b2cef/starkgate_withdraw_indexer.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.027027027027025%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA9UlEQVQY012O6U6EQBCEeZTlHs5ZQG4GZoCFXQkmGqPv/yRlaGLc+ONLdSrVXa29JCViPwWzQ9i6B0tnMC8uPCfCMt6xP97RNwqikeiqHqIe0JaC5kPbakBXD8h4gZTn0FQl8Pn2jY/9C/dpx6I20q6UWMcNbSnhuzECxmmpzBrkSYU8qYkiPTm8Q7U0TNAWAk1xtA6kopbIeI44uCJgERyTgdk+xmHGNMyQncIsb3+ohfxDNdNwYBsuLMMhjtm82HToplYoMcF3Q2ISE3iYnHn9zP5H+21/xrU8+u512bCMKzwnIH/qZyopswrZNUfkcco+7/4A0MCgnDIbiqkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Starkgate withdrawal indexer\"\n        title=\"Starkgate withdrawal indexer\"\n        src=\"/static/40da3801ba3d2b2805d90c46e4d216e9/fcda8/starkgate_withdraw_indexer.png\"\n        srcset=\"/static/40da3801ba3d2b2805d90c46e4d216e9/12f09/starkgate_withdraw_indexer.png 148w,\n/static/40da3801ba3d2b2805d90c46e4d216e9/e4a3f/starkgate_withdraw_indexer.png 295w,\n/static/40da3801ba3d2b2805d90c46e4d216e9/fcda8/starkgate_withdraw_indexer.png 590w,\n/static/40da3801ba3d2b2805d90c46e4d216e9/b2cef/starkgate_withdraw_indexer.png 847w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Once it detects that you have a pending withdrawal, you will have a little toast that tells you to submit a transaction to complete the withdrawal of your fund on L1.</p>\n<h3 id=\"withdrawal-limit\" style=\"position:relative;\">Withdrawal limit<a href=\"#withdrawal-limit\" aria-label=\"withdrawal limit permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>The Starknet bridge contract implements something called <a href=\"https://docs.starknet.io/documentation/tools/starkgate_architecture/#stark_gate_withdrawal_limit\">‘withdrawal limit’ or ‘withdrawal quota’</a>. So far we have seen a few lines of code where it enforces some rule related to it, but didn’t bother to explain there.</p>\n<p>The withdrawal limit can be enabled by a designated security agent only. This means even ERC20 token contract owners cannot enforce a withdrawal limit. It is only enabled when the security determines that there is a serious security issue that may bring about withdrawals of unsual amount.</p>\n<!-- ## Send a message\n\n## Cancel a message -->\n<h1 id=\"references\" style=\"position:relative;\">References<a href=\"#references\" aria-label=\"references permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<ul>\n<li><a href=\"https://book.starknet.io/title-page.html\">The Starknet Book</a></li>\n<li><a href=\"https://github.com/keep-starknet-strange/madara/blob/main/docs/architecture.md\">Mandara architecture</a></li>\n<li><a href=\"https://starkware.co/resource/joining-forces-sharp/\">Joining Forces: SHARP - Save Costs and Enhance Ethereum’s Scalability: If it’s Written in Cairo, SHARP Can Prove it</a></li>\n<li><a href=\"https://www.youtube.com/watch?v=VMNreeZkAgI\">Starknet Community Call #35 | SHARP - the backbone of Starknet</a></li>\n<li><a href=\"https://www.starknet.io/en/content/sharp-starkwares-shared-prover-video\">SHARP: StarkWare’s Shared Prover | Kineret Segal</a></li>\n<li><a href=\"https://www.starknet.io/en/learn/glossary\">Starknet Glossary</a></li>\n<li><a href=\"https://docs.starknet.io/documentation/architecture_and_concepts/Network_Architecture/transaction-life-cycle/\">Transaction lifecycle</a></li>\n<li><a href=\"https://david-barreto.com/starknets-architecture-review/\">Starknet architecture review</a></li>\n<li><a href=\"https://book.starknet.io/ch03-00-architecture.html\">Starknet architecture</a></li>\n</ul>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\"><a href=\"https://book.starknet.io/ch03-02-sequencers.html\">https://book.starknet.io/ch03-02-sequencers.html</a><a href=\"#fnref-1\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-2\"><a href=\"https://starkware.co/resource/joining-forces-sharp/\">https://starkware.co/resource/joining-forces-sharp/</a><a href=\"#fnref-2\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-3\"><a href=\"https://docs.starknet.io/documentation/architecture_and_concepts/Network_Architecture/messaging-mechanism/#l1-l2-message-fees\">https://docs.starknet.io/documentation/architecture_and_concepts/Network_Architecture/messaging-mechanism/#l1-l2-message-fees</a><a href=\"#fnref-3\" class=\"footnote-backref\">↩</a></li>\n</ol>\n</div>","frontmatter":{"title":"Making sense of Starknet architecture and L1-L2 Messaging","date":"March 28, 2024","keywords":["starknet","architecture","messaging","bridge"]},"fields":{"readingTime":{"text":"20 min read"}}}},"pageContext":{"slug":"/2024-03-28-making-sense-of-starknet-architecture-and-l1-l2-messaging/","previous":{"fields":{"slug":"/2024-01-26-decoding-calldata-of-transactions-on-starknet/","readingTime":{"text":"3 min read"}},"frontmatter":{"title":"Decoding calldata on Starknet","tab":"post","tags":["blockchain","dev"],"keywords":["starknet","calldata","transaction","decode","rust"]}},"next":{"fields":{"slug":"/2024-08-29-common-stocks-and-uncommon-profits/","readingTime":{"text":"0 min read"}},"frontmatter":{"title":"Common stocks and uncommon profits (16 / 100)","tab":"post","tags":["books"],"keywords":["stocks","finance"]}}}},"staticQueryHashes":["3128451518","426816048"]}