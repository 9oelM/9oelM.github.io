{"componentChunkName":"component---src-templates-blog-post-js","path":"/2021-03-13-complete-end-to-end-guide-for-developing-dockerized-lambda-with-typescript-terraform-and-SAM-cli/","result":{"data":{"site":{"siteMetadata":{"title":"Joel's dev blog","author":"Joel Mun","siteUrl":"https://9oelm.github.io"}},"markdownRemark":{"id":"9ccee504-5242-541e-a514-4fe2e12f0e13","excerpt":"This is a full guide to locally develop and deploy a backend app with a recently released container image feature for lambda on AWS.  Needless to say, if you…","html":"<p>This is a full guide to locally develop and deploy a backend app with <a href=\"https://aws.amazon.com/blogs/aws/new-for-aws-lambda-container-image-support/\">a recently released container image feature for lambda on AWS</a>. </p>\n<p>Needless to say, if you are a great fan of Docker, you would know how amazing it is. What you test on local is what you get when you deploy it, at least at the container level.</p>\n<p>Since this feature is quite new, there have been <strong>lots of rabbit holes</strong> I fell into, and I’m sure others will too, so I will break every piece of rabbit hole down so that nobody gets trapped into it. This guide starts from the real basics like making a user or setting up terraform, so feel free to skip to the section you need.</p>\n<h1 id=\"reason-to-use-terraform-and-sam-cli-together\" style=\"position:relative;\">Reason to use Terraform and SAM CLI together<a href=\"#reason-to-use-terraform-and-sam-cli-together\" aria-label=\"reason to use terraform and sam cli together permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>Well, it seems that Terraform supports building a Docker image and deploying it to ECR out of the box, but after lots of digging, I noticed that things would get simpler if I just build docker image in another pipeline and deploy it with a few lines of shell script. So Terraform will used to define resources excluding the build and deployment process. There’s no problem with that.</p>\n<p>And, what SAM CLI? Terraform cannot replace SAM CLI and vice versa. SAM cli is useful in developing local lambdas because it automatically configures endpoints for each lambda and greatly removes barriers to the initial setup. Since lambda functions are ‘special’ in the way that they only get ‘booted up and called’ when they are invoked (unlike EC2 or Fargate), just doing <code class=\"language-text\">ts-node my-lambda.ts</code> would not make it work. Of course there are many other solutions to this matter (such as <code class=\"language-text\">sls</code>) but in this guide I will just use SAM CLI. But for many reasons SAM makes me want to use other better solutions if any… The reason follows right below.</p>\n<p><em>Disclaimer for the people who are looking for how to ’<strong>hot-reload</strong>’ Dockerfile for typescript or javascript based lambda</em>: it won’t work smoothly as of now. The best bet is to use <code class=\"language-text\">nodemon</code> to watch a certain directory to trigger <code class=\"language-text\">sam build</code> every single time, and in another shell launch <code class=\"language-text\">sam local start-api</code>. It works as expected, but the current problem I see from here is that every single time it <code class=\"language-text\">sam build</code>s, it would make another Docker image and another and so on, so there will be many useless dangling images stacked up in your drive, which you will need to delete manually because SAM CLI does not support passing in a argument that’s equivalent to <code class=\"language-text\">docker run --rm</code>. Anyways that’s the story, so this is the reason I might want to try some other solutions. <a href=\"https://github.com/aws/aws-sam-cli/issues/921\">More on this on the relevant issue on Github</a>. Please let me know if any of you had a good experience with <code class=\"language-text\">sls</code> because I haven’t used it much yet.</p>\n<p>Ok. Now let’s write some code.</p>\n<h1 id=\"setup-aws-for-terraform\" style=\"position:relative;\">Setup AWS for Terraform<a href=\"#setup-aws-for-terraform\" aria-label=\"setup aws for terraform permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>First, make sure that you’ve installed and authorized on your AWS CLI. Installing AWS CLI is kind of out of scope here, so <a href=\"https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-mac.html\">please follow the guide on AWS</a>.</p>\n<p>After successful installation, run:</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">aws configure</code></pre></div>\n<p>You will be prompted to enter Access Key ID and Secret Access Key. Depending on your situation, there are different ways of how you can handle this, but for the sake of simplicity we can make one user (from AWS console. You will probably only use it for\n‘Programmatic access’) that would have these policies for applying Terraform codes.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f21ee54b7fcfb2dc2afad6aea390e8c2/44a54/add-user.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.02702702702703%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABcElEQVQoz4WS626DMAyFeYit5AaBBMJ1a7vStVXf/7nObNNOSJ20Hx84iXLs4zirYot+nNF2A4zzsGX9P66ETgtsnFGUFZwPAp9lvNGmDrFpYWyB91xjpwyhJX7CaybXFrlS2MU9VNXRHUuFlIIyDllsEw7HL5yWMz73B1R1RCDx0CTwGdNQQh87uNhDU1JlCmitobQRkS0Zf57qdWwwTjNiN6FuB1gf4eqWSDBVgiZUEYgI5aoXMRFkC6tFI3a0IQthhJ8vKPqjCOS2JLwgQgxVKva1e/xXstLX9CD9ao/7SNWKONli1kR/Ycmyfa2wDg2m+QPDOGF/OBIHefFhHGWPW8AJuY/Sz7YjErWkh2tGaJqMlx4ynNHXAYkuF1XAcv7G7XbD5XqVPZ6EfhhFkONA4xYpZkf5o1KxvPXP9t52SsbntCy43+84k/CRpoDFSkrEcGL/+BtX/Aq+VLgtnV987WuSMeJ1FaLA8ZNthcwPhQQRTMJstgwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"./add-user.png\"\n        title=\"./add-user.png\"\n        src=\"/static/f21ee54b7fcfb2dc2afad6aea390e8c2/fcda8/add-user.png\"\n        srcset=\"/static/f21ee54b7fcfb2dc2afad6aea390e8c2/12f09/add-user.png 148w,\n/static/f21ee54b7fcfb2dc2afad6aea390e8c2/e4a3f/add-user.png 295w,\n/static/f21ee54b7fcfb2dc2afad6aea390e8c2/fcda8/add-user.png 590w,\n/static/f21ee54b7fcfb2dc2afad6aea390e8c2/efc66/add-user.png 885w,\n/static/f21ee54b7fcfb2dc2afad6aea390e8c2/44a54/add-user.png 1017w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>This one for setting S3 bucket as a backend:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"s3:ListBucket\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Resource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"arn:aws:s3:::tf-backend\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"s3:GetObject\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"s3:PutObject\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Resource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"arn:aws:s3:::tf-backend/path/to/my/key\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And this one for locking the state:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"dynamodb:GetItem\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"dynamodb:PutItem\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"dynamodb:DeleteItem\"</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Resource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"arn:aws:dynamodb:*:*:table/tf-state-locks\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And the next one is quite tricky; because we will temporarily enable permissions related to managing IAM because we will first need to make a role from which we could <code class=\"language-text\">assumeRole</code> whenever we try to plan and apply our IaC.</p>\n<p>For now we can just go onto AWS console and make this policy:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Sid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"VisualEditor0\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string\">\"iam:*\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"sts:*\"</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Resource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"*\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Make sure you will need to narrow down to specific actions and resources used after everything is done.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/267a0e31db57acc8353881b42ea8f7d0/e8e04/create-policy.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAACEElEQVQ4y52UaZLaMBCFOUQGtFubbdnGZpiapSqpXCT3v8dLS7YnQCgG5scrtbD98VrdrU1II9rxBWl8RVXvoXwPV3fwTV8UioYSG9eUZzp0EDbBthPC+AGfDoj9EY72m6cdh7EWXdeh6+mjykEoA0kSn9Lzb7r6fKb0vLL2HUJbMCGxZQKbHZfQBKlTh6aJqOuIygVYvyrvfYkdxevvLkTaUxxbqNiDqwqMWJtMNdZjGCf4WMOQC8kVuFDIf1Z0Gl9IGA8VEkQVyn4GkqMm9Ti+vqFLA6IkqNSUhvpSBUwMtvxxAea0XGwo5YSfVKBJR2hp8LS42C4r4/87vYQXoAs1VbKFpcP9FQa8mwaHDBV0+ELD0CppvQSskKvAtusRCRrIpaWULTnMMgTytDePAuu2Q+oHHA5H9NKhU76AJb34g4uS9j3nOQPj7LBuE/qBGl1RG0lbHAaC5vO8VenV5XnKVOXscDw8YzABgw5otaMCBeyriKAs+FJ5fuGMS1rlCdBSk2ZYbvBpP6GuqLfIFVtenD/SX+os5YYmhdMovY3PiNSs26VN2I00b6acJ0UZS03uIbK7pVHZAzqblFC3Zbiz1nFjV5r3rrbJs5yVY/YNV1cd5htmBe7uPLd/OgGu15cmh7s7mve6lirny+H7kNPbhmO73VFMF6wgcr5AK3KoK/twurnVRPsC9/sPeJjwF7niFxNB/yrTAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"create-policy\"\n        title=\"create-policy\"\n        src=\"/static/267a0e31db57acc8353881b42ea8f7d0/fcda8/create-policy.png\"\n        srcset=\"/static/267a0e31db57acc8353881b42ea8f7d0/12f09/create-policy.png 148w,\n/static/267a0e31db57acc8353881b42ea8f7d0/e4a3f/create-policy.png 295w,\n/static/267a0e31db57acc8353881b42ea8f7d0/fcda8/create-policy.png 590w,\n/static/267a0e31db57acc8353881b42ea8f7d0/efc66/create-policy.png 885w,\n/static/267a0e31db57acc8353881b42ea8f7d0/c83ae/create-policy.png 1180w,\n/static/267a0e31db57acc8353881b42ea8f7d0/e8e04/create-policy.png 1270w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Now, now that you’ve made three distinct policies (or all in one, depending on your preferences), attach them to the user that you’ve just crated for running <code class=\"language-text\">aws configure</code>.</p>\n<h1 id=\"setup-terraform\" style=\"position:relative;\">Setup Terraform<a href=\"#setup-terraform\" aria-label=\"setup terraform permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>If you haven’t already, <a href=\"https://learn.hashicorp.com/tutorials/terraform/install-cli\">install terraform by following an instruction from the official website</a>. Just download the binary and move it to the <code class=\"language-text\">bin</code> folder.</p>\n<p>Now verify version of terraform</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">➜  test terraform --version\nTerraform v0.14.5\n\nYour version of Terraform is out of date! The latest version\nis 0.14.8. You can update by downloading from https://www.terraform.io/downloads.html</code></pre></div>\n<p>And then make <code class=\"language-text\">main.tf</code> file in your project directory (I personally put it into <code class=\"language-text\">IaC</code> folder because there will another folder for the ‘real’ <code class=\"language-text\">.ts</code> codes for the backend):</p>\n<h2 id=\"maintf\" style=\"position:relative;\"><code class=\"language-text\">main.tf</code><a href=\"#maintf\" aria-label=\"maintf permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">terraform {\n  required_providers {\n    aws = {\n      source  = &quot;hashicorp/aws&quot;\n      version = &quot;~&gt; 3.27&quot;\n    }\n  }\n}\n\nprovider &quot;aws&quot; {\n  profile = &quot;default&quot;\n  region  = &quot;us-west-2&quot; # you will need to change this to your region\n}</code></pre></div>\n<p>Now, run <code class=\"language-text\">terraform init</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">➜  test terraform init\n\nInitializing the backend...\n\nInitializing provider plugins...\n- Finding hashicorp/aws versions matching &quot;~&gt; 3.27&quot;...\n- Installing hashicorp/aws v3.32.0...\n- Installed hashicorp/aws v3.32.0 (signed by HashiCorp)\n\nTerraform has created a lock file .terraform.lock.hcl to record the provider\nselections it made above. Include this file in your version control repository\nso that Terraform can guarantee to make the same selections by default when\nyou run &quot;terraform init&quot; in the future.\n\nTerraform has been successfully initialized!\n\nYou may now begin working with Terraform. Try running &quot;terraform plan&quot; to see\nany changes that are required for your infrastructure. All Terraform commands\nshould now work.\n\nIf you ever set or change modules or backend configuration for Terraform,\nrerun this command to reinitialize your working directory. If you forget, other\ncommands will detect it and remind you to do so if necessary.</code></pre></div>\n<p>Then, we will need to add s3 backend and state locking. But before then, make a table on Dynamodb and also a bucket on S3, each for hosting IaC backend and locking the state.</p>\n<p>Now we will need to add more to the policy on DynamoDB we created because we want to create a table:</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">  &quot;dynamodb:CreateTable&quot;,\n  &quot;dynamodb:DescribeTable&quot;,\n  &quot;dynamodb:Scan&quot;,\n  &quot;dynamodb:Query&quot;,</code></pre></div>\n<p>Then you could write this code (by the way, it may be a good idea to put this below IaC in a different general-purpose repository because the current repository is meant to be only used for lambda-related resouces. But for the sake of this article I will just write it away here):</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">resource &quot;aws_dynamodb_table&quot; &quot;terraform_state_lock&quot; {\n  name           = &quot;tf-state-locks&quot;\n  read_capacity  = 5\n  write_capacity = 5\n  hash_key       = &quot;LockID&quot;\n  attribute {\n    name = &quot;LockID&quot;\n    type = &quot;S&quot;\n  }\n}</code></pre></div>\n<p>And then, also add S3 backend (you will need to add relevant IAM policies too here, but since we know how to do it, I will cut the explanation):</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">resource &quot;aws_s3_bucket&quot; &quot;b&quot; {\n  bucket = &quot;tf-backend&quot;\n  acl    = &quot;private&quot;\n\n  versioning {\n    enabled = true\n  }\n}</code></pre></div>\n<p>Now, run <code class=\"language-text\">terraform apply</code>, verify the changes, and enter <code class=\"language-text\">yes</code>. DynamoDB table and S3 Bucket should have been created. Here’s the code so far:</p>\n<h2 id=\"maintf-1\" style=\"position:relative;\"><code class=\"language-text\">main.tf</code><a href=\"#maintf-1\" aria-label=\"maintf 1 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">terraform {\n  required_providers {\n    aws = {\n      source  = &quot;hashicorp/aws&quot;\n      version = &quot;~&gt; 3.27&quot;\n    }\n  }\n}\n\nprovider &quot;aws&quot; {\n  profile = &quot;default&quot;\n  region  = &quot;us-west-2&quot; # you will need to change this to your region\n}\n\n+ resource &quot;aws_dynamodb_table&quot; &quot;terraform_state_lock&quot; {\n+   name           = &quot;tf-state-locks&quot;\n+   read_capacity  = 5\n+   write_capacity = 5\n+   hash_key       = &quot;LockID&quot;\n+   attribute {\n+     name = &quot;LockID&quot;\n+     type = &quot;S&quot;\n+   }\n+ }\n\n+  resource &quot;aws_s3_bucket&quot; &quot;terraform_backend&quot; {\n+    bucket = &quot;tf-backend&quot;\n+    acl    = &quot;private&quot;\n\n+    versioning {\n+      enabled = true\n+   }\n+  }</code></pre></div>\n<p>Now, add s3 backend and state lock:</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">terraform {\n  required_providers {\n    aws = {\n      source  = &quot;hashicorp/aws&quot;\n      version = &quot;~&gt; 3.27&quot;\n    }\n  }\n+ backend &quot;s3&quot; {\n+   profile = &quot;localtf&quot;\n+   bucket  = &quot;my-iac&quot; # change the bucket name to yours\n+   key            = &quot;your-stack-name&quot;\n+   region         = &quot;us-west-2&quot; # change to your region\n+   dynamodb_table = &quot;terraform-lock&quot;\n+ }\n}\n\nprovider &quot;aws&quot; {\n  profile = &quot;default&quot;\n  region  = &quot;us-west-2&quot; # you will need to change this to your region\n}\n\nresource &quot;aws_dynamodb_table&quot; &quot;terraform_state_lock&quot; {\n  name           = &quot;tf-state-locks&quot;\n  read_capacity  = 5\n  write_capacity = 5\n  hash_key       = &quot;LockID&quot;\n  attribute {\n    name = &quot;LockID&quot;\n    type = &quot;S&quot;\n  }\n}\n\n resource &quot;aws_s3_bucket&quot; &quot;terraform_backend&quot; {\n   bucket = &quot;tf-backend&quot;\n   acl    = &quot;private&quot;\n\n   versioning {\n     enabled = true\n  }\n }</code></pre></div>\n<p>We are also going to use Docker provider, so add that too:</p>\n<h2 id=\"maintf-2\" style=\"position:relative;\"><code class=\"language-text\">main.tf</code><a href=\"#maintf-2\" aria-label=\"maintf 2 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">terraform {\n  required_providers {\n    aws = {\n      source  = &quot;hashicorp/aws&quot;\n      version = &quot;~&gt; 3.27&quot;\n    }\n +  docker = {\n +    source  = &quot;kreuzwerker/docker&quot;\n +    version = &quot;&gt;= 2.8.0&quot;\n +  }\n  }\n  backend &quot;s3&quot; {\n    profile = &quot;localtf&quot;\n    bucket  = &quot;my-iac&quot; # change the bucket name to yours\n    key            = &quot;your-stack-name&quot;\n    region         = &quot;us-west-2&quot; # change to your region\n    dynamodb_table = &quot;terraform-lock&quot;\n  }\n}\n\n\nprovider &quot;aws&quot; {\n  profile = &quot;default&quot;\n  region  = &quot;us-west-2&quot; # you will need to change this to your region\n}\n\nresource &quot;aws_dynamodb_table&quot; &quot;terraform_state_lock&quot; {\n  name           = &quot;tf-state-locks&quot;\n  read_capacity  = 5\n  write_capacity = 5\n  hash_key       = &quot;LockID&quot;\n  attribute {\n    name = &quot;LockID&quot;\n    type = &quot;S&quot;\n  }\n}\n\n resource &quot;aws_s3_bucket&quot; &quot;terraform_backend&quot; {\n   bucket = &quot;tf-backend&quot;\n   acl    = &quot;private&quot;\n\n   versioning {\n     enabled = true\n  }\n }</code></pre></div>\n<p>Now because you’ve added a backend and another provider, we will need to run <code class=\"language-text\">terraform init</code> again, and then <code class=\"language-text\">terraform apply</code>. Run it.</p>\n<h1 id=\"setting-up-lambda\" style=\"position:relative;\">Setting up lambda<a href=\"#setting-up-lambda\" aria-label=\"setting up lambda permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>Now we will need to develop lambda on the local machine. Install SAM CLI:</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">brew tap aws/tap\n\nbrew install aws-sam-cli</code></pre></div>\n<p>Note that the outdated versions would not support running Docker containers, so make sure that your version is the latest.</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">test:(dev) sam --version\nSAM CLI, version 1.20.0</code></pre></div>\n<p>Now, we won’t run <code class=\"language-text\">sam --init</code>, because it will make it difficult to make the server into a monorepo structure. The reason that we will want to make it into a monorepo is that it will make it much easier to propery dockerize every single lambda and deploy it with dependencies that each of them only require to have. Instead we will use <em>lerna</em> to initialize the server folder.</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">mkdir server</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">|\n- IaC\n- server</code></pre></div>\n<p>And as usual:</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">cd server\n\nnpm i -g lerna\n\nlerna init</code></pre></div>\n<p>Then it will give you this layout:</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">➜  test git:(master) ✗ tree\n.\n├── IaC\n│   └── main.tf\n└── server\n    ├── lerna.json\n    ├── package.json\n    └── packages</code></pre></div>\n<p>Then, add your first function package. For the sake of this example, let’s assume that we want to make a REST API, composed of many lambdas, each returning ‘hello’ as a response in different languages (which is totally useless in reality, but at least useful here). Our first lambda will be an English one.</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">➜  server git:(master) ✗ lerna create hello\nlerna notice cli v3.18.1\nlerna WARN ENOREMOTE No git remote found, skipping repository property\npackage name: (hello) ls\nversion: (0.0.0)\ndescription:\nkeywords:\nhomepage:\nlicense: (ISC)\nentry point: (lib/hello.js)\ngit repository:\nAbout to write to /Users/jm/Desktop/test/test/server/packages/hello/package.json:\n\n{\n  &quot;name&quot;: &quot;ls&quot;,\n  &quot;version&quot;: &quot;0.0.0&quot;,\n  &quot;description&quot;: &quot;&gt; TODO: description&quot;,\n  &quot;author&quot;: &quot;9oelM&quot;,\n  &quot;homepage&quot;: &quot;&quot;,\n  &quot;license&quot;: &quot;ISC&quot;,\n  &quot;main&quot;: &quot;lib/hello.js&quot;,\n  &quot;directories&quot;: {\n    &quot;lib&quot;: &quot;lib&quot;,\n    &quot;test&quot;: &quot;__tests__&quot;\n  },\n  &quot;files&quot;: [\n    &quot;lib&quot;\n  ],\n  &quot;scripts&quot;: {\n    &quot;test&quot;: &quot;echo \\&quot;Error: run tests from root\\&quot; &amp;&amp; exit 1&quot;\n  }\n}\n\n\nIs this OK? (yes)\nlerna success create New package ls created at ./packages/hello</code></pre></div>\n<p>Now the directory structure will look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">➜  test git:(master) ✗ tree -I node_modules\n.\n├── IaC\n│   └── main.tf\n└── server\n    ├── lerna.json\n    ├── package.json\n    └── packages\n        └── hello\n            ├── README.md\n            ├── __tests__\n            │   └── hello.test.js\n            ├── lib\n            │   └── hello.js\n            └── package.json\n\n6 directories, 7 files</code></pre></div>\n<p>Now, under <code class=\"language-text\">server</code>, we will need to add some utils to build and invoke the function locally. Add modify the <code class=\"language-text\">server/package.json</code> as follows and of course, run <code class=\"language-text\">npm i</code> again:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"devDependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"@types/node\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^14.14.32\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"concurrently\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^6.0.0\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"lerna\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^4.0.0\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"nodemon\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^2.0.7\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"concurrently \\\"npm run watch\\\" \\\"npm run api\\\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"watch\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"nodemon\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"api\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sam local start-api\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"server\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>To add some explanatioon to what we are trying to do: these <code class=\"language-text\">devDependencies</code> are going to be package-wide dependencies. These are not specific to any one of the functions that we are going to build; They will help in tooling general stuffs. That’s what we put them here.</p>\n<p>Dependencies:</p>\n<ul>\n<li><code class=\"language-text\">@types/node</code>: we will need this to give proper type definitions for ‘built-in node’ modules like <code class=\"language-text\">fs</code> or <code class=\"language-text\">path</code>.</li>\n<li><code class=\"language-text\">concurrently</code>: just a script runner.</li>\n<li><code class=\"language-text\">lerna</code>: you know it.</li>\n<li><code class=\"language-text\">nodemon</code>: this will help us watch a directory and build Docker image again.</li>\n</ul>\n<p>Scripts:</p>\n<ul>\n<li><code class=\"language-text\">start</code>, <code class=\"language-text\">watch</code>, <code class=\"language-text\">api</code>: we will need these to launch our lambda function locally and invoke it.</li>\n</ul>\n<p>Now, you need to create <code class=\"language-text\">template.yml</code> for SAM cli to consume and run what we want to run.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">AWSTemplateFormatVersion</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'2010-09-09'</span>\n<span class=\"token key atrule\">Transform</span><span class=\"token punctuation\">:</span> AWS<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Serverless<span class=\"token punctuation\">-</span><span class=\"token datetime number\">2016-10-31</span>\n<span class=\"token key atrule\">Description</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">></span><span class=\"token scalar string\">\n  hello api</span>\n  \n<span class=\"token key atrule\">Globals</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">Function</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">Timeout</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n\n<span class=\"token key atrule\">Resources</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">helloRoomFunction</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> AWS<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Serverless<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Function\n    <span class=\"token key atrule\">Metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">DockerTag</span><span class=\"token punctuation\">:</span> nodejs14.x<span class=\"token punctuation\">-</span>v1\n      <span class=\"token key atrule\">DockerContext</span><span class=\"token punctuation\">:</span> ./packages/hello\n      <span class=\"token key atrule\">Dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile\n    <span class=\"token key atrule\">Properties</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># will automatically use local one if testing on local</span>\n      <span class=\"token key atrule\">ImageUri</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>your<span class=\"token punctuation\">-</span>aws<span class=\"token punctuation\">-</span>account<span class=\"token punctuation\">-</span>id<span class=\"token punctuation\">}</span>.dkr.ecr.<span class=\"token punctuation\">{</span>your<span class=\"token punctuation\">-</span>aws<span class=\"token punctuation\">-</span>region<span class=\"token punctuation\">}</span>.amazonaws.com/dev<span class=\"token punctuation\">-</span>hello\n      <span class=\"token comment\"># Note: If the PackageType property is set to Image, then either ImageUri is required, </span>\n      <span class=\"token comment\"># or you must or you must build your application with necessary Metadata entries in the AWS SAM template file. </span>\n      <span class=\"token comment\"># For more information, see Building applications.</span>\n      <span class=\"token key atrule\">PackageType</span><span class=\"token punctuation\">:</span> Image\n      <span class=\"token key atrule\">FunctionName</span><span class=\"token punctuation\">:</span> HelloInEngFunction\n      <span class=\"token key atrule\">Events</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">helloRoom</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> Api\n          <span class=\"token key atrule\">Properties</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">Path</span><span class=\"token punctuation\">:</span> /hello\n            <span class=\"token key atrule\">Method</span><span class=\"token punctuation\">:</span> get</code></pre></div>\n<p>We won’t be able to run <code class=\"language-text\">sam build</code> or <code class=\"language-text\">sam local start-api</code> yet, because we still need to setup <code class=\"language-text\">Dockerfile</code> and ECR repository.</p>\n<p>So far we have added <code class=\"language-text\">template.yml</code> for running SAM CLI:</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">➜  server git:(master) ✗ tree -I node_modules\n.\n├── lerna.json\n├── package.json\n├── packages\n│   └── hello\n│       ├── README.md\n│       ├── __tests__\n│       │   └── hello.test.js\n│       ├── lib\n│       │   └── hello.js\n│       └── package.json\n└── template.yml</code></pre></div>\n<p>Now we will add <code class=\"language-text\">Dockerfile</code> in <code class=\"language-text\">packages/hello/</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">cd packages/hello\n\ntouch Dockerfile</code></pre></div>\n<p>This will be the content for Dockerfile:</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token keyword\">FROM</span> amazon/aws<span class=\"token punctuation\">-</span>lambda<span class=\"token punctuation\">-</span>nodejs<span class=\"token punctuation\">:</span>14 AS builder\n<span class=\"token keyword\">WORKDIR</span> /usr/app\n\n<span class=\"token keyword\">COPY</span> package*.json tsconfig.json ./\n<span class=\"token keyword\">RUN</span> npm install\n\n<span class=\"token keyword\">COPY</span> ./lib ./lib/\n<span class=\"token keyword\">RUN</span> npm run build\n\n<span class=\"token keyword\">RUN</span> ls <span class=\"token punctuation\">-</span>la <span class=\"token comment\"># for debugging</span>\n\n<span class=\"token keyword\">FROM</span> amazon/aws<span class=\"token punctuation\">-</span>lambda<span class=\"token punctuation\">-</span>nodejs<span class=\"token punctuation\">:</span>14\n<span class=\"token comment\"># CMD [\"path-to-file.function-name\"]</span>\n<span class=\"token keyword\">WORKDIR</span> /usr/app\n\n<span class=\"token keyword\">COPY</span> package*.json ./\n<span class=\"token keyword\">RUN</span> npm install <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>only=prod\n<span class=\"token keyword\">COPY</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>from=builder /usr/app/lib /usr/app/lib\n<span class=\"token keyword\">CMD</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"/usr/app/lib/index.handler\"</span> <span class=\"token punctuation\">]</span></code></pre></div>\n<p>To go through it line by line:</p>\n<ul>\n<li><code class=\"language-text\">amazon/aws-lambda-nodejs:14</code> is the official amazon image for lambda. Current LTS of nodejs is 14, so we are using this. <code class=\"language-text\">AS builder</code> is related to multi-stage builds in Docker; it helps reduce the final Docker image size. Basically in this <code class=\"language-text\">builder</code> stage, we will only build the output to be included in the final image, and any dependencies installed in this step won’t be included in the final output image.</li>\n<li><code class=\"language-text\">WORKDIR /usr/app</code>: inside the docker image, set the working directory as <code class=\"language-text\">/usr/app</code>. There isn’t any <code class=\"language-text\">app</code> folder in a normal docker image, so it will make <code class=\"language-text\">app</code> directory. We will put the compiled js code there.</li>\n<li><code class=\"language-text\">COPY package*.json tsconfig.json ./</code>: we need these files for compiling typescript into javascriptt files.</li>\n<li><code class=\"language-text\">npm install</code>: it will install dependencies.</li>\n<li><code class=\"language-text\">npm run build</code>: it will compile typescript code into js.</li>\n<li><code class=\"language-text\">RUN ls -la # for debugging</code>: it is merely for debugging. While building, docker will output what’s inside there at that time, for you to verify if you are doing what you intended to do.</li>\n<li><code class=\"language-text\">FROM amazon/aws-lambda-nodejs:14</code>: this is the second build stage in Docker. All outputs from the previous stage will be discarded in this stage unless explicitly specified to be included.</li>\n<li><code class=\"language-text\">RUN npm install --only=prod</code>: it will only install <code class=\"language-text\">dependencies</code> but <code class=\"language-text\">devDepdencies</code>.</li>\n<li><code class=\"language-text\">COPY --from=builder /usr/app/lib /usr/app/lib</code>: it explicitly refers to the previous <code class=\"language-text\">builder</code> stage to copy whatever that was inside <code class=\"language-text\">/usr/app/lib</code> to the current <code class=\"language-text\">/usr/app/lib</code>. In this case, it will copy all compiled javascript code.</li>\n<li><code class=\"language-text\">CMD [ &quot;/usr/app/lib/index.handler&quot; ]</code>: the command should be <code class=\"language-text\">path-to-lambda-handler-without-extension.handler</code>. That’s just how it works.</li>\n</ul>\n<p>Now we’ve added a Dockerfile. Now let’s setup basic environment for lambda:</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">cd packages/hello\n\n➜  hello git:(master) ✗ tsc --init\nmessage TS6071: Successfully created a tsconfig.json file.</code></pre></div>\n<p>You will need to modify <code class=\"language-text\">tsconfig</code> to use modern javascript features; Most prominently, add the following. This will allow you to use <code class=\"language-text\">Promise</code> API. I recommend turning other options too, especially those related to strict-type checking:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"compilerOptions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* Basic Options */</span>\n    <span class=\"token comment\">// \"incremental\": true,                   /* Enable incremental compilation */</span>\n    <span class=\"token property\">\"target\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"es5\"</span><span class=\"token punctuation\">,</span>                          <span class=\"token comment\">/* Specify ECMAScript target version: 'ES3' (default), 'ES5', 'ES2015', 'ES2016', 'ES2017', 'ES2018', 'ES2019' or 'ESNEXT'. */</span>\n    <span class=\"token property\">\"module\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"commonjs\"</span><span class=\"token punctuation\">,</span>                     <span class=\"token comment\">/* Specify module code generation: 'none', 'commonjs', 'amd', 'system', 'umd', 'es2015', or 'ESNext'. */</span>\n-    <span class=\"token property\">\"lib\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>                             <span class=\"token comment\">/* Specify library files to be included in the compilation. */</span>\n+    <span class=\"token property\">\"lib\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"ES2015\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>                             <span class=\"token comment\">/* Specify library files to be included in the compilation. */</span>\n    <span class=\"token comment\">// \"allowJs\": true,                       /* Allow javascript files to be compiled. */</span>\n    <span class=\"token comment\">// \"checkJs\": true,                       /* Report errors in .js files. */</span>\n    <span class=\"token comment\">// \"jsx\": \"preserve\",                     /* Specify JSX code generation: 'preserve', 'react-native', or 'react'. */</span>\n    <span class=\"token comment\">// \"declaration\": true,                   /* Generates corresponding '.d.ts' file. */</span>\n    <span class=\"token comment\">// \"declarationMap\": true,                /* Generates a sourcemap for each corresponding '.d.ts' file. */</span>\n    <span class=\"token comment\">// \"sourceMap\": true,                     /* Generates corresponding '.map' file. */</span>\n    <span class=\"token comment\">// \"outFile\": \"./\",                       /* Concatenate and emit output to single file. */</span>\n    <span class=\"token comment\">// \"outDir\": \"./\",                        /* Redirect output structure to the directory. */</span>\n    <span class=\"token comment\">// \"rootDir\": \"./\",                       /* Specify the root directory of input files. Use to control the output directory structure with --outDir. */</span>\n    <span class=\"token comment\">// \"composite\": true,                     /* Enable project compilation */</span>\n    <span class=\"token comment\">// \"tsBuildInfoFile\": \"./\",               /* Specify file to store incremental compilation information */</span>\n    <span class=\"token comment\">// \"removeComments\": true,                /* Do not emit comments to output. */</span>\n    <span class=\"token comment\">// \"noEmit\": true,                        /* Do not emit outputs. */</span>\n    <span class=\"token comment\">// \"importHelpers\": true,                 /* Import emit helpers from 'tslib'. */</span>\n-    <span class=\"token comment\">// \"downlevelIteration\": true,            /* Provide full support for iterables in 'for-of', spread, and destructuring when targeting 'ES5' or 'ES3'. */</span>\n+    <span class=\"token property\">\"downlevelIteration\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>            <span class=\"token comment\">/* Provide full support for iterables in 'for-of', spread, and destructuring when targeting 'ES5' or 'ES3'. */</span>\n    <span class=\"token comment\">// \"isolatedModules\": true,               /* Transpile each file as a separate module (similar to 'ts.transpileModule'). */</span>\n\n    <span class=\"token comment\">/* Strict Type-Checking Options */</span>\n    <span class=\"token property\">\"strict\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>                           <span class=\"token comment\">/* Enable all strict type-checking options. */</span>\n    <span class=\"token comment\">// \"noImplicitAny\": true,                 /* Raise error on expressions and declarations with an implied 'any' type. */</span>\n    <span class=\"token comment\">// \"strictNullChecks\": true,              /* Enable strict null checks. */</span>\n    <span class=\"token comment\">// \"strictFunctionTypes\": true,           /* Enable strict checking of function types. */</span>\n    <span class=\"token comment\">// \"strictBindCallApply\": true,           /* Enable strict 'bind', 'call', and 'apply' methods on functions. */</span>\n    <span class=\"token comment\">// \"strictPropertyInitialization\": true,  /* Enable strict checking of property initialization in classes. */</span>\n    <span class=\"token comment\">// \"noImplicitThis\": true,                /* Raise error on 'this' expressions with an implied 'any' type. */</span>\n    <span class=\"token comment\">// \"alwaysStrict\": true,                  /* Parse in strict mode and emit \"use strict\" for each source file. */</span>\n\n    <span class=\"token comment\">/* Additional Checks */</span>\n    <span class=\"token comment\">// \"noUnusedLocals\": true,                /* Report errors on unused locals. */</span>\n    <span class=\"token comment\">// \"noUnusedParameters\": true,            /* Report errors on unused parameters. */</span>\n    <span class=\"token comment\">// \"noImplicitReturns\": true,             /* Report error when not all code paths in function return a value. */</span>\n    <span class=\"token comment\">// \"noFallthroughCasesInSwitch\": true,    /* Report errors for fallthrough cases in switch statement. */</span>\n\n    <span class=\"token comment\">/* Module Resolution Options */</span>\n    <span class=\"token comment\">// \"moduleResolution\": \"node\",            /* Specify module resolution strategy: 'node' (Node.js) or 'classic' (TypeScript pre-1.6). */</span>\n    <span class=\"token comment\">// \"baseUrl\": \"./\",                       /* Base directory to resolve non-absolute module names. */</span>\n    <span class=\"token comment\">// \"paths\": {},                           /* A series of entries which re-map imports to lookup locations relative to the 'baseUrl'. */</span>\n    <span class=\"token comment\">// \"rootDirs\": [],                        /* List of root folders whose combined content represents the structure of the project at runtime. */</span>\n    <span class=\"token comment\">// \"typeRoots\": [],                       /* List of folders to include type definitions from. */</span>\n    <span class=\"token comment\">// \"types\": [],                           /* Type declaration files to be included in compilation. */</span>\n    <span class=\"token comment\">// \"allowSyntheticDefaultImports\": true,  /* Allow default imports from modules with no default export. This does not affect code emit, just typechecking. */</span>\n    <span class=\"token property\">\"esModuleInterop\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>                   <span class=\"token comment\">/* Enables emit interoperability between CommonJS and ES Modules via creation of namespace objects for all imports. Implies 'allowSyntheticDefaultImports'. */</span>\n    <span class=\"token comment\">// \"preserveSymlinks\": true,              /* Do not resolve the real path of symlinks. */</span>\n    <span class=\"token comment\">// \"allowUmdGlobalAccess\": true,          /* Allow accessing UMD globals from modules. */</span>\n\n    <span class=\"token comment\">/* Source Map Options */</span>\n    <span class=\"token comment\">// \"sourceRoot\": \"\",                      /* Specify the location where debugger should locate TypeScript files instead of source locations. */</span>\n    <span class=\"token comment\">// \"mapRoot\": \"\",                         /* Specify the location where debugger should locate map files instead of generated locations. */</span>\n    <span class=\"token comment\">// \"inlineSourceMap\": true,               /* Emit a single file with source maps instead of having a separate file. */</span>\n    <span class=\"token comment\">// \"inlineSources\": true,                 /* Emit the source alongside the sourcemaps within a single file; requires '--inlineSourceMap' or '--sourceMap' to be set. */</span>\n\n    <span class=\"token comment\">/* Experimental Options */</span>\n    <span class=\"token comment\">// \"experimentalDecorators\": true,        /* Enables experimental support for ES7 decorators. */</span>\n    <span class=\"token comment\">// \"emitDecoratorMetadata\": true,         /* Enables experimental support for emitting type metadata for decorators. */</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Modify <code class=\"language-text\">packages/hello/package.json</code> too. Be noted that any dependencies you add to be included in the final, compiled output code (javascript) will need to be added to <code class=\"language-text\">dependencies</code>, not <code class=\"language-text\">devDependencies</code>:</p>\n<h2 id=\"packageshellopackagejson\" style=\"position:relative;\"><code class=\"language-text\">packages/hello/package.json</code><a href=\"#packageshellopackagejson\" aria-label=\"packageshellopackagejson permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1.0.0\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"main\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"index.js\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"license\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"MIT\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"tsc --project ./tsconfig.json\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"devDependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"@types/aws-lambda\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^8.10.72\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"typescript\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^4.2.3\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now, add a really simple lambda:</p>\n<h2 id=\"packageshellolibindexts\" style=\"position:relative;\"><code class=\"language-text\">packages/hello/lib/index.ts</code><a href=\"#packageshellolibindexts\" aria-label=\"packageshellolibindexts permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  APIGatewayProxyEvent<span class=\"token punctuation\">,</span>\n  APIGatewayProxyResult\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"aws-lambda\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> handler <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>\n  event<span class=\"token operator\">:</span> APIGatewayProxyEvent\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>APIGatewayProxyResult<span class=\"token operator\">></span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    statusCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n    body<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">hello</span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>So far, we have created these:</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">➜  server git:(master) ✗ tree -I node_modules\n.\n├── lerna.json\n├── package.json\n├── packages\n│   └── hello\n│       ├── Dockerfile\n│       ├── README.md\n│       ├── __tests__\n│       │   └── hello.test.js\n│       ├── lib\n│       │   ├── hello.js\n│       │   └── index.ts\n│       ├── package.json\n│       └── tsconfig.json\n└── template.yml</code></pre></div>\n<p>Now, create <code class=\"language-text\">nodemon.json</code> under <code class=\"language-text\">server/</code> to watch and build files:</p>\n<h2 id=\"nodemonjson\" style=\"position:relative;\"><code class=\"language-text\">nodemon.json</code><a href=\"#nodemonjson\" aria-label=\"nodemonjson permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"watch\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"packages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"ext\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ts,json,js\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"ignore\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"src/**/*.spec.ts\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"./**/node_modules\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"node_modules\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\".aws-sam\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"exec\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sam build --template-file ./template.yml\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>After creating <code class=\"language-text\">nodemon.json</code>, you can start running <code class=\"language-text\">npm run watch</code> or <code class=\"language-text\">npm start</code>. It would do two things: build Dockerfile as you make any changes under <code class=\"language-text\">packages/</code> directory, and host a local endpoint for the lambda. It will be similar to hot-reload although it seems more like a hack; you won’t need to cancel and run <code class=\"language-text\">sam local start-api</code> again once you make a change. If it does not work, try again after creating ECR first.</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">➜  server git:(master) ✗ npm run watch\n\n&gt; server@ watch ~/example-lambda/server\n&gt; nodemon\n\n[nodemon] 2.0.7\n[nodemon] to restart at any time, enter `rs`\n[nodemon] watching path(s): packages/**/*\n[nodemon] watching extensions: ts,json,js\n[nodemon] starting `sam build --template-file ./template.yml`\n\n...</code></pre></div>\n<p>Oh, and you can delete <code class=\"language-text\">__tests__</code> and <code class=\"language-text\">lib/hello.js</code> because we are not using them. Anyways, now we are kind of ready to build this function into a docker image. Let’s try it:</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">➜  packages git:(master) ✗ cd hello\n➜  hello git:(master) ✗ pwd\n/Users/jm/Desktop/test/test/server/packages/hello\n➜  hello git:(master) ✗ docker build -t hello .\n[+] Building 2.3s (15/15) FINISHED\n =&gt; [internal] load build definition from Dockerfile                                                                                             0.0s\n =&gt; =&gt; transferring dockerfile: 445B                                                                                                             0.0s\n =&gt; [internal] load .dockerignore                                                                                                                0.0s\n =&gt; =&gt; transferring context: 2B                                                                                                                  0.0s\n =&gt; [internal] load metadata for docker.io/amazon/aws-lambda-nodejs:14                                                                           0.0s\n =&gt; [internal] load build context                                                                                                                0.0s\n =&gt; =&gt; transferring context: 438B                                                                                                                0.0s\n =&gt; [builder 1/7] FROM docker.io/amazon/aws-lambda-nodejs:14                                                                                     0.0s\n =&gt; CACHED [builder 2/7] WORKDIR /usr/app                                                                                                        0.0s\n =&gt; CACHED [stage-1 3/5] COPY package*.json ./                                                                                                   0.0s\n =&gt; CACHED [stage-1 4/5] RUN npm install --only=prod                                                                                             0.0s\n =&gt; CACHED [builder 3/7] COPY package*.json tsconfig.json ./                                                                                     0.0s\n =&gt; CACHED [builder 4/7] RUN npm install                                                                                                         0.0s\n =&gt; [builder 5/7] COPY ./lib ./lib/                                                                                                              0.0s\n =&gt; [builder 6/7] RUN npm run build                                                                                                              1.6s\n =&gt; [builder 7/7] RUN ls -la # for debugging                                                                                                     0.3s\n =&gt; [stage-1 5/5] COPY --from=builder /usr/app/lib /usr/app/lib                                                                                  0.1s\n =&gt; exporting to image                                                                                                                           0.1s\n =&gt; =&gt; exporting layers                                                                                                                          0.0s\n =&gt; =&gt; writing image sha256:f2d79403b039ee76e286564e93382d3e1268024fd053f2f8e0e8c6f5d73b1403                                                     0.0s\n =&gt; =&gt; naming to docker.io/library/hello                                                                                                         0.0s</code></pre></div>\n<p>Everything’s cool, docker build succeeded. You can try running the image and test the request:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/969ef03f010526f8c9d2cf4f67fcbbd7/a2b91/docker-first-test.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.972972972972975%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAtElEQVQY042P2w6DIBBEUSKwXvAGmgZttZeXtv//e1Og8aFNm/gw2SFhz86wx/2JozuACgWlFLTWyPMcUkoIIZBlGYgUTsuC2+WK0bSodAUlhf8vUPg9Ihl9EBvHEcYa2MHCWov4NgZ936PrOtR1jbIskSSJVwrO0+gZY7+1+MvzPGNdz15r9G3bommamHZL+hfwLeccpmmKsDDDgWEYYsJQPcCIaD9wM1uNd7XkoxbnfDfwBZZQbm3Ce6ZjAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"docker first test\"\n        title=\"docker first test\"\n        src=\"/static/969ef03f010526f8c9d2cf4f67fcbbd7/fcda8/docker-first-test.png\"\n        srcset=\"/static/969ef03f010526f8c9d2cf4f67fcbbd7/12f09/docker-first-test.png 148w,\n/static/969ef03f010526f8c9d2cf4f67fcbbd7/e4a3f/docker-first-test.png 295w,\n/static/969ef03f010526f8c9d2cf4f67fcbbd7/fcda8/docker-first-test.png 590w,\n/static/969ef03f010526f8c9d2cf4f67fcbbd7/efc66/docker-first-test.png 885w,\n/static/969ef03f010526f8c9d2cf4f67fcbbd7/c83ae/docker-first-test.png 1180w,\n/static/969ef03f010526f8c9d2cf4f67fcbbd7/a2b91/docker-first-test.png 3360w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>This is where SAM CLI should start to come in. But before then, we will need to make a ECR repository with terraform. Let’s go back to terraform for a while.</p>\n<h1 id=\"back-to-terraform-assume-role-and-ecr\" style=\"position:relative;\">Back to terraform: assume role and ECR<a href=\"#back-to-terraform-assume-role-and-ecr\" aria-label=\"back to terraform assume role and ecr permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>Now, we will need to create a role first because we will relay on that role to get required permissions to create whatever resource we want to. This is called ‘assuming a role’, and the reason why it’s deemed to be a good practice is that you won’t have to create multiple credentials (probably multiple users) to do certain thing that requires permissions. Instead, you <em>borrow</em> the permission for the period of time when you plan and apply the changes in the resources.</p>\n<p>So how do we do it? First, let’s create <code class=\"language-text\">hello_role.tf</code>:</p>\n<h2 id=\"hello_roletf\" style=\"position:relative;\"><code class=\"language-text\">hello_role.tf</code><a href=\"#hello_roletf\" aria-label=\"hello_roletf permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">resource &quot;aws_iam_role&quot; &quot;hello&quot; {\n  name = &quot;hello_role&quot;\n  assume_role_policy = jsonencode({\n    &quot;Version&quot; : &quot;2012-10-17&quot;,\n    &quot;Statement&quot; : [\n      {\n        &quot;Effect&quot; : &quot;Allow&quot;,\n        &quot;Principal&quot; : {\n          # this should be set as the &#39;default&#39; user on your AWS cli.\n          # get &#39;localtf&#39; user&#39;s ARN from AWS IAM console\n          # it should look like: arn:aws:iam::{aws-account-id}:user/localtf\n          # example: arn:aws:iam::123456789:user/localtf\n          &quot;AWS&quot; : &quot;arn:aws:iam::123456789:user/localtf&quot;\n          &quot;Service&quot; : [\n            &quot;lambda.amazonaws.com&quot;\n          ]\n        },\n        &quot;Action&quot; : &quot;sts:AssumeRole&quot;\n      }\n    ]\n  })\n}\n\nresource &quot;aws_iam_policy&quot; &quot;hello&quot; {\n  name        = &quot;hello_policy&quot;\n  description = &quot;policy needed to run hello server stack&quot;\n\n  policy = jsonencode({\n    &quot;Version&quot; : &quot;2012-10-17&quot;,\n    &quot;Statement&quot; : [\n      {\n        &quot;Action&quot; : [\n          &quot;lambda:*&quot;,\n          &quot;iam:*&quot;,\n          &quot;ecr:*&quot;,\n          &quot;cloudformation:*&quot;,\n          &quot;apigateway:*&quot;,\n          &quot;logs:*&quot;,\n          &quot;route53:*&quot;,\n          &quot;acm:*&quot;,\n          &quot;cloudfront:*&quot;,\n          &quot;ec2:*&quot;\n        ],\n        &quot;Effect&quot; : &quot;Allow&quot;,\n        &quot;Resource&quot; : &quot;*&quot;\n      }\n    ]\n  })\n}\n\nresource &quot;aws_iam_role_policy_attachment&quot; &quot;hello&quot; {\n  role       = aws_iam_role.hello.name\n  policy_arn = aws_iam_policy.hello.arn\n}</code></pre></div>\n<p>For the sake of this article, we won’t be diving deep into specific policies, so we will just allow almost all resources without specifying them in detail. For real-world usage, you will have to define exact statements giving just the right permissions.</p>\n<p>What we are doing here, essentially, is that we are allowing <code class=\"language-text\">localtf</code> user to assume the role of <code class=\"language-text\">hello_role</code> that possesses all policies to run the hello server stack. This is called ‘creating a trust relationship’ (you will see this if you do this process on AWS). This way, <code class=\"language-text\">localtf</code> won’t always have to hold all permissions it needs. It only acquires them only when needed (i.e. deploying)</p>\n<p>Once you are done writing <code class=\"language-text\">hello_role.tf</code>, run <code class=\"language-text\">terraform apply</code> to make changes.</p>\n<p>Now, go back to <code class=\"language-text\">main.tf</code> and add:</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">terraform {\n  required_providers {\n    aws = {\n      source  = &quot;hashicorp/aws&quot;\n      version = &quot;~&gt; 3.27&quot;\n    }\n   docker = {\n     source  = &quot;kreuzwerker/docker&quot;\n     version = &quot;&gt;= 2.8.0&quot;\n   }\n  }\n  backend &quot;s3&quot; {\n    profile = &quot;localtf&quot;\n    bucket  = &quot;my-iac&quot; # change the bucket name to yours\n    key            = &quot;your-stack-name&quot;\n    region         = &quot;us-west-2&quot; # change to your region\n    dynamodb_table = &quot;terraform-lock&quot;\n  }\n}\n\nprovider &quot;aws&quot; {\n  profile = &quot;default&quot;\n  region  = &quot;us-west-2&quot; # you will need to change this to your region\n+ assume_role {\n+   role_arn     = &quot;arn:aws:iam::{your-account-id}:role/hello_role&quot;\n+   session_name = &quot;terraform&quot;\n+ }\n}\n\n# you can create this resource in other repository because it&#39;s not specific to this project\n# resource &quot;aws_dynamodb_table&quot; &quot;terraform_state_lock&quot; {\n#   name           = &quot;tf-state-locks&quot;\n#   read_capacity  = 5\n#   write_capacity = 5\n#   hash_key       = &quot;LockID&quot;\n#   attribute {\n#     name = &quot;LockID&quot;\n#     type = &quot;S&quot;\n#   }\n# }\n\n# you can create this resource in other repository because it&#39;s not specific to this project\n# resource &quot;aws_s3_bucket&quot; &quot;terraform_backend&quot; {\n#   bucket = &quot;tf-backend&quot;\n#   acl    = &quot;private&quot;\n\n#   versioning {\n#     enabled = true\n#   }\n# }</code></pre></div>\n<p>Once you add <code class=\"language-text\">assume_role</code>, now you can create any resources you want, using the permissions given by that role. Let’s now make an ECR repository. Make <code class=\"language-text\">ecr.tf</code>:</p>\n<h2 id=\"ecrtf\" style=\"position:relative;\"><code class=\"language-text\">ecr.tf</code><a href=\"#ecrtf\" aria-label=\"ecrtf permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">resource &quot;aws_ecr_repository&quot; &quot;hello&quot; {\n  name                 = &quot;${terraform.workspace}-hello&quot;\n  image_tag_mutability = &quot;MUTABLE&quot; # you are going to be overwriting &#39;latest&#39; tagged image.\n\n  image_scanning_configuration {\n    scan_on_push = true\n  }\n\n  depends_on = [aws_iam_role_policy_attachment.hello]\n}\n\ndata &quot;aws_ecr_image&quot; &quot;latest&quot; {\n  repository_name = aws_ecr_repository.hello.name # from hello_role.tf\n  image_tag       = &quot;latest&quot;\n}</code></pre></div>\n<p>Run <code class=\"language-text\">apply</code> and terraform will soon make ECR.</p>\n<h1 id=\"building-and-pushing-the-image-to-ecr\" style=\"position:relative;\">Building and pushing the image to ECR<a href=\"#building-and-pushing-the-image-to-ecr\" aria-label=\"building and pushing the image to ecr permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>Now that we’ve made an ECR, we can go back to our server and write a little script to login, build and push the image of the lambda we are writing.</p>\n<p>It’s pretty much straightforward; just get your AWS cli ready for using; and authenticate to be able to use ECR from Docker CLI:</p>\n<h2 id=\"login-dockersh\" style=\"position:relative;\"><code class=\"language-text\">login-docker.sh</code><a href=\"#login-dockersh\" aria-label=\"login dockersh permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">aws ecr get-login-password --region {your-region} | docker login --username AWS --password-stdin {your-account-id}.dkr.ecr.{your-region}.amazonaws.com</code></pre></div>\n<p>Next, tag your Docker image as <code class=\"language-text\">latest</code> and separate timestamnp at the time of the build, so that latest tag will always be the latest built image, and then another image will remain for the record, which you can use later to revert back or do other things in some cases.</p>\n<h2 id=\"build-and-push-docker-imagesh\" style=\"position:relative;\"><code class=\"language-text\">build-and-push-docker-image.sh</code><a href=\"#build-and-push-docker-imagesh\" aria-label=\"build and push docker imagesh permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">DEV_HELLO_REPO_URI=&quot;{your-account-id}.dkr.ecr.{your-region}.amazonaws.com/dev-hello&quot;\n\n# change to your region for the ease of finding Docker images later\ntimestamp=$(TZ=&quot;:Asia/Seoul&quot; date +%Y%m%d%H%M%S)\n\ndocker build -t &quot;${DEV_HELLO_REPO_URI}:latest&quot; -t &quot;${DEV_HELLO_REPO_URI}:${timestamp}&quot; ./packages/hello\n\ndocker push &quot;${DEV_HELLO_REPO_URI}:latest&quot;\ndocker push &quot;${DEV_HELLO_REPO_URI}:${timestamp}&quot;</code></pre></div>\n<p>Now, you can test it out yourself as such:</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\"># get AWS CLI logged in and ready before as previously explained\ncd server\n\nchmod u+x login-docker.sh\nchmod u+x build-and-push-docker-image.sh\n\n./login-docker.sh\n./build-and-push-docker-image.sh</code></pre></div>\n<p>After this, you will be able to see on AWS ECR:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aef06a2d7371ccea10c3eeedf942bd09/30f63/aws-ecr.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.54054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABm0lEQVQoz3WPsW7UQBRFLcUrojRslk1s72Ztj9fjmbHHY4+z9u7mF5DoQk1BBQ09Jb9BzSdQ8R8IIVHS8QEoIjfPk1VEkCiO7hv56bxrL0o0nvJ3mPL38JtfOGr/YKJ/4Jh/wgn7gNNnARH+l+kswGweYXGRYrli8FhuMM/fYJq9xSx7RbzGPHmOIDhFEJ4hiGKcE//m34TLFLkoIZWGl+YCOY/pwhldCB3RxRKLuMAiKRDF6wcWY67GzB5DzWLGkXE5NlTIpcGKqYNEYO3eAsuEg3GFZC1dxlmBdC0Oe7SfSJol0rx2OxnteKWuodoOwlhwWSIvBLRpHKrSqGoDoUqY1tK7gbUS581HTMxPHDdf8cR8x0n7Dax6gbor4Jmmhd7uoTZbFFI6Wtth0/dorKWZRGWFYbtF3XS42muEwxd4FvA74GiEZla/hL0iYUOXq4GE/Q5cCEI6UT8MLsfv8pGwRth/dsKJ/U2yW/iUTF/fC11DkqnLwbUTUjnR5WZDv9k6oaoqd2AU7ncawUHodzeuoW9vqOE12l2BOwaZ9+Rw2ZCGAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"aws ecr\"\n        title=\"aws ecr\"\n        src=\"/static/aef06a2d7371ccea10c3eeedf942bd09/fcda8/aws-ecr.png\"\n        srcset=\"/static/aef06a2d7371ccea10c3eeedf942bd09/12f09/aws-ecr.png 148w,\n/static/aef06a2d7371ccea10c3eeedf942bd09/e4a3f/aws-ecr.png 295w,\n/static/aef06a2d7371ccea10c3eeedf942bd09/fcda8/aws-ecr.png 590w,\n/static/aef06a2d7371ccea10c3eeedf942bd09/efc66/aws-ecr.png 885w,\n/static/aef06a2d7371ccea10c3eeedf942bd09/c83ae/aws-ecr.png 1180w,\n/static/aef06a2d7371ccea10c3eeedf942bd09/30f63/aws-ecr.png 2816w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>as you can see, the images are going to be tagged by timestamp, and the latest built image will be always tagged as <code class=\"language-text\">latest</code>, and you are going to reference this tag in Terraform to apply newly built Docker image to lambda.</p>\n<p>So far, we’ve made changes like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">➜  example-lambda git:(master) tree -I node_modules\n.\n├── IaC\n│   ├── ecr.tf\n│   ├── hello_role.tf\n│   └── main.tf\n└── server\n    ├── build-and-push-docker-image.sh\n    ├── lerna.json\n    ├── login-docker.sh\n    ├── nodemon.json\n    ├── package-lock.json\n    ├── package.json\n    ├── packages\n    │   └── hello\n    │       ├── Dockerfile\n    │       ├── README.md\n    │       ├── lib\n    │       │   └── index.ts\n    │       ├── package-lock.json\n    │       ├── package.json\n    │       └── tsconfig.json\n    └── template.yml\n\n5 directories, 17 files</code></pre></div>\n<h1 id=\"creating-terraform-resources-for-lambda-and-api-gateway\" style=\"position:relative;\">Creating Terraform resources for lambda and API gateway<a href=\"#creating-terraform-resources-for-lambda-and-api-gateway\" aria-label=\"creating terraform resources for lambda and api gateway permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>Now the majority of the prepartion is done, so we can move onto creating actual lambda and API gateway.</p>\n<h2 id=\"lambdatf\" style=\"position:relative;\"><code class=\"language-text\">lambda.tf</code><a href=\"#lambdatf\" aria-label=\"lambdatf permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>First, the most important part: you want to create lambda itself from Docker.</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">module &quot;lambda_function_container_image&quot; {\n  version = &quot;1.43.0&quot;\n  source  = &quot;terraform-aws-modules/lambda/aws&quot;\n\n  function_name = &quot;${terraform.workspace}-HelloEngFunction&quot;\n  description   = &quot;GET /hello&quot;\n\n  create_package = false\n\n  # this will allow Terraform to detect changes in the docker image because\n  # a new image will have a different SHA (digest).\n  image_uri    = &quot;{your-account-id}.dkr.ecr.{your-region}.amazonaws.com/${aws_ecr_repository.hello.name}@${data.aws_ecr_image.latest.image_digest}&quot;\n  package_type = &quot;Image&quot;\n}</code></pre></div>\n<p>There is already a module just made for this, so use it to make lambda. Once you are done, <code class=\"language-text\">apply</code> the changes.</p>\n<p>The key here is that you are going to reference an image URI from ECR where the tag is the latest. If you have previously built and pushed a new docker image, the hash of the image is going to be different, thus causing a redeployment of the lambda function. Otherwise it has no idea if the docker image is new or not.</p>\n<p>Again, after running the change, you can see the lambda on AWS console:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d5fd01295230d8baa5a5d8c9afe8e5b7/a82e6/lambda-creation-0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABXklEQVQoz32QO07EMBRFIwpEhcQUo4ntOM7Xn8SJkwwfCTr2QsdiELAH2tkFS4FVXF48MCXFkd9HOr52IvIKWaHBshrbVP0i/2XH8ggTCjtRwJYSUy0gMoWE0aAxGmUlIBUjOFheR7hqIAgmK3Dq15pTLYsWqtKRvDJYuhaPe0eOFomUO+T+CVfjAZfdB67cK8rGoqxbusiiNQ4F1cZ1kWGcULcGnR/j6foBlXYwfsLN3T2SUm0g5jckM3C2ABfTN0l6aErdanPCdevMYppnWOcwhgBjHV0wovc95nnB7Sos8g3S8BKFK+fhC7Xx8RuOCRs0mhKSsLUWQ5igSeTHAE3ibhjiLvwJldpBT8/YjJ/YDgdw/46entmTxFtK5h5g9TVCZ6m32FOidb6QaKB+GTztHCWcj09mXCJjEpw5ZCn9Z7qhU0QkE+A8gKUOOV/77LQ7wiF5Bkk1J0de1PgBnPPQZAL9/iQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lambda-creation-0\"\n        title=\"lambda-creation-0\"\n        src=\"/static/d5fd01295230d8baa5a5d8c9afe8e5b7/fcda8/lambda-creation-0.png\"\n        srcset=\"/static/d5fd01295230d8baa5a5d8c9afe8e5b7/12f09/lambda-creation-0.png 148w,\n/static/d5fd01295230d8baa5a5d8c9afe8e5b7/e4a3f/lambda-creation-0.png 295w,\n/static/d5fd01295230d8baa5a5d8c9afe8e5b7/fcda8/lambda-creation-0.png 590w,\n/static/d5fd01295230d8baa5a5d8c9afe8e5b7/efc66/lambda-creation-0.png 885w,\n/static/d5fd01295230d8baa5a5d8c9afe8e5b7/c83ae/lambda-creation-0.png 1180w,\n/static/d5fd01295230d8baa5a5d8c9afe8e5b7/a82e6/lambda-creation-0.png 3334w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>as you can see, compared to other lambdas, it has the package type of ‘Image’, which means it’s not from a Zip, but a Docker image.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/888ccce9d7aea2b1f91b5ae12db9173c/a2b91/lambda-creation-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB70lEQVQoz22ST2/UMBDF+wVa7bbZTWzHf2M7myxZiiqkUpVFpdBSihASJ4Q4cuDEBQlx4ooENz7w4222LULi8NMb2+M3k4x3rPco3Bmm7gMm4Qumco2DosDBTJCKyP8ia4fahBGl6TFXOH/+Aju1MQjtMVx/DRHWELVHtUH3pB3Xt1Q0ETqMaJdhwoK0jONY5OzZJXYkD0t7DBlOMLMnyO0j9MM1Jvk75vkjahshTYPapfFiyEvIdI3SDOyygNSahcJo+HRrGFEOP1AMv7GXf2G/+wmbTqFsgrSL0WyDTz1izvD9FUT3CUV4h6J5D9Gc89zRUN0Y1hZSzVHrEkLOIBiXklWVxVxoQpUWM+qsqrBvXmE3fMWe/4xd/w1T83rcvzOs6e74KVI30OzK+kxlzK4qaVjEblEbHKQsIcWETKGoTWNgXIP9QmwNlfHQ/X2E1RH0YoUyDhCpu2FARS1jhyputMc8rsjhSJkeQC6OoPLq7z9UHLvsLmBWVzDDS/iBCffeQA1vYYc1yvYKRbrALF1ySGc0OBwLiWYJEZeoqBWnfWdYs8PUnyIvOYjwEMZzCO4U0j+GDivq+oYnUJ7PK2Y4H2FsGHHMD03613DRd+hISHwWvBBiQGojadEwviXEBnnRc5+5sWU+z9NWbw3/ACTpHS1t/4J2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lambda-creation-1\"\n        title=\"lambda-creation-1\"\n        src=\"/static/888ccce9d7aea2b1f91b5ae12db9173c/fcda8/lambda-creation-1.png\"\n        srcset=\"/static/888ccce9d7aea2b1f91b5ae12db9173c/12f09/lambda-creation-1.png 148w,\n/static/888ccce9d7aea2b1f91b5ae12db9173c/e4a3f/lambda-creation-1.png 295w,\n/static/888ccce9d7aea2b1f91b5ae12db9173c/fcda8/lambda-creation-1.png 590w,\n/static/888ccce9d7aea2b1f91b5ae12db9173c/efc66/lambda-creation-1.png 885w,\n/static/888ccce9d7aea2b1f91b5ae12db9173c/c83ae/lambda-creation-1.png 1180w,\n/static/888ccce9d7aea2b1f91b5ae12db9173c/a2b91/lambda-creation-1.png 3360w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>You should be able to see the image URI (including the hash) of the image at the bottom of the information about lambda. If you click on that image URI, you will be navigated to the latest image on ECR that you just built and pushed.</p>\n<h2 id=\"api_gatewaytf\" style=\"position:relative;\"><code class=\"language-text\">api_gateway.tf</code><a href=\"#api_gatewaytf\" aria-label=\"api_gatewaytf permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Now, you will be able to test lambda on AWS Lambda console, but what we want in the end is something like sending GET <code class=\"language-text\">/hello</code> to a certain domain and receiving a response. To be able to do that, we need to setup API Gateway. </p>\n<p>For this example, we will setup a domain at <code class=\"language-text\">api.hello.com</code>.</p>\n<p>Here’s how: </p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">resource &quot;aws_api_gateway_rest_api&quot; &quot;hello&quot; {\n  description = &quot;all APIs related to api.hello.com&quot;\n  name = &quot;hello-api&quot;\n}\n\nresource &quot;aws_api_gateway_resource&quot; &quot;hello_eng&quot; {\n  path_part   = &quot;hello&quot; # later, you will want to add another path for /bonjour, and so on\n  parent_id   = aws_api_gateway_rest_api.hello.root_resource_id\n  rest_api_id = aws_api_gateway_rest_api.hello.id\n}\n\nresource &quot;aws_api_gateway_method&quot; &quot;hello_eng&quot; {\n  rest_api_id   = aws_api_gateway_rest_api.hello.id\n  resource_id   = aws_api_gateway_resource.hello_eng.id\n  http_method   = &quot;GET&quot;\n  authorization = &quot;NONE&quot;\n}\n\nresource &quot;aws_lambda_permission&quot; &quot;hello_eng&quot; {\n  statement_id  = &quot;AllowExecutionFromAPIGateway&quot;\n  action        = &quot;lambda:InvokeFunction&quot;\n  function_name = module.lambda_function_container_image.this_lambda_function_name\n  principal     = &quot;apigateway.amazonaws.com&quot;\n\n  # More: http://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-hello.html\n  # example: arn:aws:execute-api:{your-region}:{your-account-id}:{some-random-hash}/test-invoke-stage/GET/hello\n  # omit slash before aws_api_gateway_resource.hello_eng.path because it has a preceding slash\n  source_arn = &quot;arn:aws:execute-api:{your-region}:{your-account-id}:${aws_api_gateway_rest_api.hello.id}/*/${aws_api_gateway_method.hello_eng.http_method}${aws_api_gateway_resource.hello_eng.path}&quot;\n}\n\nresource &quot;aws_api_gateway_integration&quot; &quot;hello_eng&quot; {\n  rest_api_id             = aws_api_gateway_rest_api.hello.id\n  resource_id             = aws_api_gateway_resource.hello_eng.id\n  http_method             = aws_api_gateway_method.hello_eng.http_method\n  integration_http_method = &quot;GET&quot;\n  type                    = &quot;AWS_PROXY&quot;\n  uri                     = module.lambda_function_container_image.this_lambda_function_invoke_arn\n}\n\nresource &quot;aws_api_gateway_stage&quot; &quot;hello&quot; {\n  description   = &quot;stage of all APIs related to api.hello.com. Right now we have dev only&quot;\n  deployment_id = aws_api_gateway_deployment.hello.id\n  rest_api_id   = aws_api_gateway_rest_api.hello.id\n  stage_name    = terraform.workspace\n}\n\nresource &quot;aws_api_gateway_deployment&quot; &quot;hello&quot; {\n  rest_api_id = aws_api_gateway_rest_api.hello.id\n  description = &quot;deployment all APIs related to api.hello.com&quot;\n\n  triggers = {\n    redeployment = timestamp()\n    # https://github.com/hashicorp/terraform/issues/6613#issuecomment-322264393\n    # or you can just use md5(file(&quot;api_gateway.tf&quot;)) to make sure that things only get deployed when they changed\n  }\n\n  lifecycle {\n    create_before_destroy = true\n  }\n}</code></pre></div>\n<p>I will explain the code one by one.</p>\n<p><code class=\"language-text\">aws_api_gateway_rest_api</code> will create a REST api. It usually does not include a single endpoint; it usually contains multiple, like: <code class=\"language-text\">api.hello.co/hello</code>, <code class=\"language-text\">api.hello.co/bonjour</code>, <code class=\"language-text\">api.hello.co/nihao</code>, and so on. On AWS, it is equivalent to a single row in APIs tab:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/df88c7c30db2709b0fbf2f56f20836ce/a2b91/rest-api.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 12.837837837837837%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAmklEQVQI102MUQ7CMAxDdwvWbm2aJmk3xgQ/iHtw/7uYME2ID8uO8uyhiCFzQ3KFJAhZMGZFIPtp/M8nc3BzPbpFV+xLw/slGIgFqRikbYgOkQOmC5g854riLmzH/VU3/xVBZUXzTO7VVqg2PB/7OUgVOif0TLiKYrOGKUy4jBGZGOylGGekXGDWQT5ozt1ax1IYdzM039F1xwdB6VO947bpSwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"API\"\n        title=\"API\"\n        src=\"/static/df88c7c30db2709b0fbf2f56f20836ce/fcda8/rest-api.png\"\n        srcset=\"/static/df88c7c30db2709b0fbf2f56f20836ce/12f09/rest-api.png 148w,\n/static/df88c7c30db2709b0fbf2f56f20836ce/e4a3f/rest-api.png 295w,\n/static/df88c7c30db2709b0fbf2f56f20836ce/fcda8/rest-api.png 590w,\n/static/df88c7c30db2709b0fbf2f56f20836ce/efc66/rest-api.png 885w,\n/static/df88c7c30db2709b0fbf2f56f20836ce/c83ae/rest-api.png 1180w,\n/static/df88c7c30db2709b0fbf2f56f20836ce/a2b91/rest-api.png 3360w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><code class=\"language-text\">aws_api_gateway_resource</code>: to put it very simply, you can think of this as a single API endpoint that has not yet been deployed. In this case we create a single endpoint ending with <code class=\"language-text\">/hello</code>.</p>\n<p>In the below example, we have created two different resources with <code class=\"language-text\">OPTIONS</code> and <code class=\"language-text\">POST</code>, to the same path (hidden by black overlay). We will talk about creating OPTIONS resource to handle preflight requests later. For now, it would suffice to know that creating a REST resource means creating a certain endpoint.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bc60b0d16042ff389a967cc47063c318/fa63f/rest-resource.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.7027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABBElEQVQY03VQ7WrCMBTNG2zMj6Rp0qRJtVVrxW04V7bKNhhMh+z9X+bsplUpgj8OhPNxc+5lsU4glYZKDKzzSKzDvCzhnYWfTLBar2F9Bm3TVlPGQnsHnTnE3raQAeQXsQLLiwKOAsGoKMCjCIPhCNXjE36Of2i+vrF522HbfKDefWK1eUF1eMfi2CDbbzE91Mh/a0z3r5CpARvLGIMxp0ESMrTVGmMRITQvl0vMZjlipcDJJ04I2xRUJGwRUStB2bPGzPAB/P4OIy5agvfEEEydo1Ut8aeBNCCcKHDamHZgP8Oeyzm0EBdCyE7sjN0H/cAZt3i2qCo4On5b/arh9buPW/w/+D+kMkt/D3wAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"resource\"\n        title=\"resource\"\n        src=\"/static/bc60b0d16042ff389a967cc47063c318/fcda8/rest-resource.png\"\n        srcset=\"/static/bc60b0d16042ff389a967cc47063c318/12f09/rest-resource.png 148w,\n/static/bc60b0d16042ff389a967cc47063c318/e4a3f/rest-resource.png 295w,\n/static/bc60b0d16042ff389a967cc47063c318/fcda8/rest-resource.png 590w,\n/static/bc60b0d16042ff389a967cc47063c318/efc66/rest-resource.png 885w,\n/static/bc60b0d16042ff389a967cc47063c318/c83ae/rest-resource.png 1180w,\n/static/bc60b0d16042ff389a967cc47063c318/fa63f/rest-resource.png 2298w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><code class=\"language-text\">aws_api_gateway_method</code>: Now, you want to create a REST method for that resource. Our <code class=\"language-text\">/hello</code> endpoint will just require no auth (out of scope of this article), and be a GET method.</p>\n<p><code class=\"language-text\">aws_lambda_permission</code>: By default, there’s no permission for API gateway to invoke lambda function. So we are just granting a permission to it so that it can be executed.</p>\n<p><code class=\"language-text\">aws_api_gateway_integration</code>: API gateway supports transforming (filtering, preprocessing, …) a request before it reaches client or a response from the client before it reaches the actual lambda. We are not doing any special things here for this example, but you may want to use it in the future. For more, <a href=\"https://docs.aws.amazon.com/apigateway/latest/developerguide/how-to-integration-settings.html\">read relevant AWS docs</a>.</p>\n<p><code class=\"language-text\">aws_api_gateway_stage</code>: API gateway supports separating API into different stages out of the box. You should use this to separate your API across production, staging and development environments. For now, we will only make a stage for current terraform workspace, which is assumed to be <code class=\"language-text\">dev</code> across all examples in this article. Once you apply your changes, you are going to be able to see this on your AWS console:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cf3be85166ea628d4a8b9cc4bd8f8fc9/ad1ae/stage.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.054054054054056%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABFElEQVQY06WQ3U6EMBCFeQJjlKW0FGhLAVf+l/obhWj2Zn3/9zkOJXvhtRcnZ6Yz852kQde1ODa7bFWBqxLWnSFljkxm6Joela2RcIkoZNC6QK4Mcm2g9O6bTFGiKCsEyhhkSsOQWlsi0w9I5wuOrw7usqBeHPKXDuZtgCIvuwaTe0Y7zXjsJzTjydeqsIhijsBYiyTNkCQSVilwznB3e4NibDD/rGi+ZtiPEfp9IHCLeuixfp/xuS4YZ4d2nNGfHAHLHRiyGGHEEIsEMUFllntnTEAKCUVhgurDfQR2iBExTrsCaZqCk4eHiO5pxoVnBLVWnuyBpOuAS4JuvQ+inkK2IO9+b9/nf94Egif6kyvkv9o4vw0jpe5ljCAOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"stage\"\n        title=\"stage\"\n        src=\"/static/cf3be85166ea628d4a8b9cc4bd8f8fc9/fcda8/stage.png\"\n        srcset=\"/static/cf3be85166ea628d4a8b9cc4bd8f8fc9/12f09/stage.png 148w,\n/static/cf3be85166ea628d4a8b9cc4bd8f8fc9/e4a3f/stage.png 295w,\n/static/cf3be85166ea628d4a8b9cc4bd8f8fc9/fcda8/stage.png 590w,\n/static/cf3be85166ea628d4a8b9cc4bd8f8fc9/efc66/stage.png 885w,\n/static/cf3be85166ea628d4a8b9cc4bd8f8fc9/c83ae/stage.png 1180w,\n/static/cf3be85166ea628d4a8b9cc4bd8f8fc9/ad1ae/stage.png 2270w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><code class=\"language-text\">aws_api_gateway_deployment</code>: This is equivalent to clicking on ‘Deploy API’ on AWS console.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/943f235b40c71db8acdb815c2474cc83/4ad3a/api_gateway_deployment.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.45945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAAB1klEQVQoz21T2ZKbMBD0Y45NVby2AXEjxH0YnGyqXHnM/v8vdXpkYNlNHsaSpVFPd89wiJIEeVHA8dS78PwAqdb2Lk5TqDDCNM+4TjOKPME0dphvN8aMTOdwlG/fHKIkRd22fJTZh4/IEMYJAQ2qpoEpK+5z9MOAtmfUObROkOUG2hjmxhZMBSEO8rCqa5RVjYbAbdfZhzELqShBrEt4KoBLBgIurH78fGFRjYvrWTVy5zFktQwFUJJ9VjhdXJwd114qVnUZCdmEUciilZW9ynwHuOQefHoTRDGSTFuZspczob/K0F0FP4pQs+g0TxiGHobemqJEQTv8MNxAreSI8f34jOPzCcfTyVa2gMEj0XE8nLnGZFUQJGTxdPFPm8Iq2wBTXlZ1ha9P3xhP+PT5C0HPG0PrDdcu9PHKzr7OI+4mQxn4tqDkiSIrWTx0lYIxmlJuthkb0CJ3BcyUh/vY48/vO361FWK+k1F6s0eaEghgwLEoMYzDRlsuV8D17EzzGzbv5Tqh73s0DJmIfc6DITfixXi90uASl91gf0wuyWZg0/TC6k3NR0Aa3ElVzqFETqP/ByjFhKmzzNw6MmvYpsiPdFmaI59hYr+S+B/AfewnYH8u//8CXpdFYbhd+D8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"deployment\"\n        title=\"deployment\"\n        src=\"/static/943f235b40c71db8acdb815c2474cc83/fcda8/api_gateway_deployment.png\"\n        srcset=\"/static/943f235b40c71db8acdb815c2474cc83/12f09/api_gateway_deployment.png 148w,\n/static/943f235b40c71db8acdb815c2474cc83/e4a3f/api_gateway_deployment.png 295w,\n/static/943f235b40c71db8acdb815c2474cc83/fcda8/api_gateway_deployment.png 590w,\n/static/943f235b40c71db8acdb815c2474cc83/efc66/api_gateway_deployment.png 885w,\n/static/943f235b40c71db8acdb815c2474cc83/4ad3a/api_gateway_deployment.png 1152w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Once resources are created in API gateway, they <em>must</em> be deployed in order to be reachable from external clients. One little problematic thing is <code class=\"language-text\">redeployment</code>; Even if you make a change to your REST API resources, it will not get deployed if <code class=\"language-text\">redeployment</code> argument does not change. There are mainly two ways of getting around this:</p>\n<ol>\n<li>Use <code class=\"language-text\">timestamp()</code> to trigger redeployment for every single <code class=\"language-text\">apply</code>. Using this approach, lambda may be down for few seconds while redeployment. But it is for sure that it always deploys, so I would just go with this one if my service does not handle many users.</li>\n<li>Use <code class=\"language-text\">md5(file(&quot;api_gateway.tf&quot;))</code> to trigger redeployment whenever this file changes. But you need to always make sure that EVERYTHING related to API Gateway deployment only stays inside this file.</li>\n</ol>\n<p>Ok. So far we have set up lambda and basic API Gateway configurations. Right now, you can test your API on Postman like this: first, go to AWS API Gateway console, and find a specific endpoint that is deployed to a certain stage. There should be an ‘Invoke URL’ at the top of the page.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/52d601cce9dfcf9e3881578707f06372/60708/test-api-gateway-postman.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.37837837837838%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABCklEQVQY021QSVLDMBD0F0yRaF+szY4UkuAAFbjxA/7/mUZWzJKqHLpq1N0zPZoul4JdLjhMI1Q6IL18IqaEKWeYwTWEGOF8+IUP9e18q62PCGls/lz26JYGpQ28seAmgIYD2P4Nm/yKhzTD7mak4zuG8Qgb97A1VJkI/3TBMD2DuYx+PKOv3j6e0DGpQLiAkhJBclBGoV2ErsnDWFOPZ5TTDJ8mCG1BxdXP1AAqDSiXIFJX1FoZdJJSPBIKJmQVxdVAWQNlDNoOsM5Bar1yvPlI1UireeMIISDbDboypnWQWA3iBgu3XRruaH8LUIjyAXv5QufqgXn9dhP/NZE7Q364W6yL1BMwG/ENq4ujM4ecKvoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"test-api-gateway-postman.png\"\n        title=\"test-api-gateway-postman.png\"\n        src=\"/static/52d601cce9dfcf9e3881578707f06372/fcda8/test-api-gateway-postman.png\"\n        srcset=\"/static/52d601cce9dfcf9e3881578707f06372/12f09/test-api-gateway-postman.png 148w,\n/static/52d601cce9dfcf9e3881578707f06372/e4a3f/test-api-gateway-postman.png 295w,\n/static/52d601cce9dfcf9e3881578707f06372/fcda8/test-api-gateway-postman.png 590w,\n/static/52d601cce9dfcf9e3881578707f06372/efc66/test-api-gateway-postman.png 885w,\n/static/52d601cce9dfcf9e3881578707f06372/c83ae/test-api-gateway-postman.png 1180w,\n/static/52d601cce9dfcf9e3881578707f06372/60708/test-api-gateway-postman.png 2872w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Now, open up Postman, and </p>\n<ol>\n<li>Insert your invoke URL</li>\n<li>Click ‘Authorization’, and choose the type ‘AWS Signature’, and enter <code class=\"language-text\">AccessKey</code> and <code class=\"language-text\">SecretKey</code>. These keys should be coming from one of user’s credentials from AWS IAM Console. If you do not have one specialized for calling an API set up with lambda and API gateway from local environment, make one user for that and get the keys.</li>\n<li>Insert your AWS Region.</li>\n<li>If your API requests any more query parameters or body, insert them.</li>\n<li>Click send, then it should work.</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4fb9a87568c15b9e36cc7c3a85d965a0/8f4a5/test-api-gateway-postman-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.756756756756754%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAAx0lEQVQY03WQ2w2DMAxFswcSxM7DIYDUSvx0gU7Q/Ve5dUwpVBUfR1Yc+8SOq2PBPFUsGu+SMElGzqJkpJQQlfSh5Sxvd/mT1xg8aH2if7zgZKzaJLipbB0FS44mYWbkFDHrQ6UUxBgtF0IAcYSnAO/9BhGo78BDp0JpxSrQQtamoNRatekQiogJSRt3CTWayGhSNty5wA+DTWFCLWwr1WkyoU32FVzj9ldpF+s5hm2dJt//7zzdFSZkDrbeD3TE9j+e+L/mgjfN+alL28ms9wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"test-api-gateway-postman-1.png\"\n        title=\"test-api-gateway-postman-1.png\"\n        src=\"/static/4fb9a87568c15b9e36cc7c3a85d965a0/fcda8/test-api-gateway-postman-1.png\"\n        srcset=\"/static/4fb9a87568c15b9e36cc7c3a85d965a0/12f09/test-api-gateway-postman-1.png 148w,\n/static/4fb9a87568c15b9e36cc7c3a85d965a0/e4a3f/test-api-gateway-postman-1.png 295w,\n/static/4fb9a87568c15b9e36cc7c3a85d965a0/fcda8/test-api-gateway-postman-1.png 590w,\n/static/4fb9a87568c15b9e36cc7c3a85d965a0/efc66/test-api-gateway-postman-1.png 885w,\n/static/4fb9a87568c15b9e36cc7c3a85d965a0/c83ae/test-api-gateway-postman-1.png 1180w,\n/static/4fb9a87568c15b9e36cc7c3a85d965a0/8f4a5/test-api-gateway-postman-1.png 2185w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>If you do not provide AWS Credentials in your request header, it won’t work, because so far your API can be only used by IAM users known to the API gateway, and if you are just sending a request from your local computer without providing any access and secret keys, it won’t know it’s you. To make it work even without providing credentials for any public APIs intended to be exposed to client applications, you should now configure <strong>custom domain</strong>.</p>\n<p>So far we have made changes to make lambda and API Gateway resources. The list of files we should have by now is the following.</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">➜  example-lambda git:(master) ✗ tree -I node_modules\n.\n├── IaC\n│   ├── api_gateway.tf\n│   ├── ecr.tf\n│   ├── hello_role.tf\n│   ├── lambda.tf\n│   └── main.tf\n└── server\n    ├── build-and-push-docker-image.sh\n    ├── lerna.json\n    ├── login-docker.sh\n    ├── nodemon.json\n    ├── package-lock.json\n    ├── package.json\n    ├── packages\n    │   └── hello\n    │       ├── Dockerfile\n    │       ├── README.md\n    │       ├── lib\n    │       │   └── index.ts\n    │       ├── package-lock.json\n    │       ├── package.json\n    │       └── tsconfig.json\n    └── template.yml\n\n5 directories, 19 files</code></pre></div>\n<p>Next, we will see how to create a custom domain and relate that domain to the REST API we just made.</p>\n<h1 id=\"creating-terraform-resources-for-custom-domain\" style=\"position:relative;\">Creating Terraform resources for Custom domain<a href=\"#creating-terraform-resources-for-custom-domain\" aria-label=\"creating terraform resources for custom domain permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>Now, the problem is that we have the API, but it’s not callable from any external client applications, which is a common case for many projects. So we want to register a domain first to represent our endpoints.</p>\n<p>Before making a change for custom domain, we need to setup another AWS provider because we will need to use <code class=\"language-text\">us-east-1</code> region for Edge-optimized custom domain name (<a href=\"https://docs.aws.amazon.com/apigateway/latest/developerguide/how-to-edge-optimized-custom-domain-name.html\">that’s the only region that supports creating an ACM certificate for Edge-optimized custom domain name</a>). </p>\n<p>There are two choices available for an API endpoint: 1. edge; 2. regional. If your endpoint should be accessed by worldwide clients, use edge; if your endpoint is specifically confined to be used in one specific region in the world, use regional. If you don’t know what to do, it totally safe to go with edge for now. First, add another aws provider:</p>\n<h2 id=\"maintf-3\" style=\"position:relative;\"><code class=\"language-text\">main.tf</code><a href=\"#maintf-3\" aria-label=\"maintf 3 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">terraform {\n  required_providers {\n    aws = {\n      source  = &quot;hashicorp/aws&quot;\n      version = &quot;~&gt; 3.27&quot;\n    }\n   docker = {\n     source  = &quot;kreuzwerker/docker&quot;\n     version = &quot;&gt;= 2.8.0&quot;\n   }\n  }\n  backend &quot;s3&quot; {\n    profile = &quot;localtf&quot;\n    bucket  = &quot;my-iac&quot; # change the bucket name to yours\n    key            = &quot;your-stack-name&quot;\n    region         = &quot;us-west-2&quot; # change to your region\n    dynamodb_table = &quot;terraform-lock&quot;\n  }\n}\n\nprovider &quot;aws&quot; {\n  profile = &quot;default&quot;\n  region  = &quot;us-west-2&quot; # you will need to change this to your region\n  assume_role {\n    role_arn     = &quot;arn:aws:iam::{your-account-id}:role/hello_role&quot;\n    session_name = &quot;terraform&quot;\n  }\n}\n\n# for issuing acm certificate\n+ provider &quot;aws&quot; {\n+  profile = &quot;default&quot;\n+  region  = &quot;us-east-1&quot;\n+  alias   = &quot;default_us_east_1&quot;\n+\n+  assume_role {\n+    role_arn     = &quot;arn:aws:iam::{your-account-id}:role/hello_role&quot;\n+    session_name = &quot;terraform&quot;\n+  }\n+ }\n\n# you can create this resource in other repository because it&#39;s not specific to this project\n# resource &quot;aws_dynamodb_table&quot; &quot;terraform_state_lock&quot; {\n#   name           = &quot;tf-state-locks&quot;\n#   read_capacity  = 5\n#   write_capacity = 5\n#   hash_key       = &quot;LockID&quot;\n#   attribute {\n#     name = &quot;LockID&quot;\n#     type = &quot;S&quot;\n#   }\n# }\n\n# you can create this resource in other repository because it&#39;s not specific to this project\n# resource &quot;aws_s3_bucket&quot; &quot;terraform_backend&quot; {\n#   bucket = &quot;tf-backend&quot;\n#   acl    = &quot;private&quot;\n\n#   versioning {\n#     enabled = true\n#   }\n# }</code></pre></div>\n<p>Then, you write the actual code to make a certificate and custom domain.</p>\n<h2 id=\"custom_domaintf\" style=\"position:relative;\"><code class=\"language-text\">custom_domain.tf</code><a href=\"#custom_domaintf\" aria-label=\"custom_domaintf permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">resource &quot;aws_acm_certificate&quot; &quot;hello&quot; {\n  provider          = aws.default_us_east_1\n  domain_name       = &quot;api.hello.com&quot;\n  validation_method = &quot;DNS&quot;\n\n  tags = {\n    Environment = terraform.workspace\n  }\n\n  lifecycle {\n    create_before_destroy = true\n  }\n}\n\nresource &quot;aws_acm_certificate_validation&quot; &quot;hello&quot; {\n  provider = aws.default_us_east_1\n\n  certificate_arn         = aws_acm_certificate.hello.arn\n  validation_record_fqdns = [for record in aws_route53_record.hello : record.fqdn]\n}\n\nlocals {\n  aws_route53_your_existing_zone_id = &quot;A123A123A123A123&quot;\n}\n\nresource &quot;aws_route53_record&quot; &quot;hello&quot; {\n  for_each = {\n    for dvo in aws_acm_certificate.hello.domain_validation_options : dvo.domain_name =&gt; {\n      name   = dvo.resource_record_name\n      record = dvo.resource_record_value\n      type   = dvo.resource_record_type\n    }\n  }\n\n  allow_overwrite = true\n  name            = each.value.name\n  records         = [each.value.record]\n  ttl             = 60\n  type            = each.value.type\n  zone_id         = local.aws_route53_your_existing_zone_id\n}</code></pre></div>\n<p>Make sure you get the existing hosted zone ID (or any other zone ID that you intend to use) from AWS Route53 Console:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/52e4ba0ef9b2c12de11b0eaca5da3ece/2c960/hosted-zone-id.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.13513513513513%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABa0lEQVQoz02Qu07DQBBF3dAQ8rQT27v2em1nd/3KS6KhgCAldHwCEgWBNgL+hiCkVHzmZewESHF0R/d6ZmdshesHiPdv6Lc90tc9xHaP9vMO508fjXZePnGx2aG1+ThC2VFbJ3q2+cLgfgvLMwt0ZncYzlfEGr1y2dApbv7qbk1FdXV7qGu/+td+eY12sYRjLmFxHkKNNRazOVSqIKMY8ZFQxOBRAk7qexxSRPRNijSOkUgJKWOsCobHK4F14cN1GQ0MJQKpoYoZpCoh0hxhkoHHhsjAGgwC0qBRTTllUoFRX6JzmLxEonJ4PIIV0OuJMjBFhVQbRMkYeTmBMjnKybRB0uZZUWKss6aezheopnPkSkPTpoIHkGEEFhwHMpo8cFwMR7Q2nVYHPgtRb8+pHtEpztDDiDLXDxoY/arM9xH2B/BsB8L1yROHk7v9EQ300bc99GoGLvGrbuOfUmcO+Z7tUh+DTb215zGBH7JozeKkVQt4AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"hosted-zone-id.png\"\n        title=\"hosted-zone-id.png\"\n        src=\"/static/52e4ba0ef9b2c12de11b0eaca5da3ece/fcda8/hosted-zone-id.png\"\n        srcset=\"/static/52e4ba0ef9b2c12de11b0eaca5da3ece/12f09/hosted-zone-id.png 148w,\n/static/52e4ba0ef9b2c12de11b0eaca5da3ece/e4a3f/hosted-zone-id.png 295w,\n/static/52e4ba0ef9b2c12de11b0eaca5da3ece/fcda8/hosted-zone-id.png 590w,\n/static/52e4ba0ef9b2c12de11b0eaca5da3ece/efc66/hosted-zone-id.png 885w,\n/static/52e4ba0ef9b2c12de11b0eaca5da3ece/c83ae/hosted-zone-id.png 1180w,\n/static/52e4ba0ef9b2c12de11b0eaca5da3ece/2c960/hosted-zone-id.png 2870w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Use that ID to create Route53 Record for the custom domain name.</p>\n<p>After you apply your change, you will be able to see ACM certificate being created on AWS Certificate Manager:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ec977a41f92b999179c01a2ab705da9e/1e2b7/acm-certificate.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABuElEQVQoz2WSSY/UMBCF02qJUWdOgER3Eu+7k16gF80BOHHg//+iR5XDiNFweHLJsd/7XJXOlwWhnjCoAJ8XuDRDmAAbElwspApLqw0FhiT9KuEKVKg4CA1hI2w6QrmIThmNlBNGIaBo0y5XqPIVKl/oQID2kZQwWd8kjIO0DpPxzewgFPaTavWkDLpRaoySNscJ+vwd/vG7Kd5/EV1GmRekuiAai9kYKDbUFopMubYhItOZkIiaDb8MI16liTYEB60VlJKQZOJTRogJ1+hxzwElUStoz1OY9WENLLUFCE2GTMZqhs63D5aemetMlyImpj8MkIrCrEFxloItUTKtbaFcswSdeWdIZiQf/iWHRpOozwUvJeLHZcGRakODMgTAYgDNhOodIdOdrw/Eemx0/NRcK+pyxOlywUwhlcwsmTAlB+Xl1EyZ9H9DGnu5/UQ8vzSyVApiXgkD9476xpPn5zHRShdarV4N2Wj/dyjGrf8fp/ET2ZQvve0V154mO0wCBwJhDSTutXw7lP0oWgIbfLvd4KiXH56esOt77HY9+v6ZTGSb+v3xwHa7Rdd12Gw2bf346TORevwBh1gUUQjmanYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"acm-certificate.png\"\n        title=\"acm-certificate.png\"\n        src=\"/static/ec977a41f92b999179c01a2ab705da9e/fcda8/acm-certificate.png\"\n        srcset=\"/static/ec977a41f92b999179c01a2ab705da9e/12f09/acm-certificate.png 148w,\n/static/ec977a41f92b999179c01a2ab705da9e/e4a3f/acm-certificate.png 295w,\n/static/ec977a41f92b999179c01a2ab705da9e/fcda8/acm-certificate.png 590w,\n/static/ec977a41f92b999179c01a2ab705da9e/efc66/acm-certificate.png 885w,\n/static/ec977a41f92b999179c01a2ab705da9e/c83ae/acm-certificate.png 1180w,\n/static/ec977a41f92b999179c01a2ab705da9e/1e2b7/acm-certificate.png 1483w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Just make sure you verified the status to be ‘Issued’ and the validation status to be ‘success’. You may need to wait for several minutes before this completes. Also, if your certificate is not showing up, make sure that you are on <code class=\"language-text\">us-east-1</code>, not anywhere else.</p>\n<p>After you are done with this, now you can go back to API Gateway again, and configure custom domain. Now that you’ve registered a domain, you can see it right up from API Gateway console:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a0b7e15e4373e39f18bc6c872b46c6f0/f3c07/custom-domain-name-api-gateway.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.567567567567565%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABS0lEQVQoz32SWXKDMBBEfYVUvOAYhKTRymY7979bpyUTynaq8vGqJQGt6Rl2PmW02kP7AefW4OOzebA/U99p3tZ/2fXWwYcBPg5oe0ukcuF6Q9mXZ890+lltMRSkccZy/0YcJq4n6gifhpUMR7XE+EjSqhE2JEhMcCsSIg3F8TBjvt5hXIAyglL1Kx6KarSFNRamIhVd3t+UFRaDPC2YaKhpaFa0+A3LSzPPwnDFPMyIbJEIK3IZYiMuNuFkMxqTWGExZOT5dq9RS/xADONoxtPUEi0Rn+eKS1MlZFLe4wUqjlAhY5dFEEuUroe0CkIN3JdKZLxV7HCDzlcIzQomLzCsVkmsgygDUaQrQ9EcSmbDl2VBYC8dm+15a+YwQoXxuDfOb+2wK6UdfcE+UMY9fpvjucPpS+HYtDis7E8XHH7h/vgPJ37fKgNNrx9wxPq4Jzq+AgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"custom-domain-name-api-gateway.png\"\n        title=\"custom-domain-name-api-gateway.png\"\n        src=\"/static/a0b7e15e4373e39f18bc6c872b46c6f0/fcda8/custom-domain-name-api-gateway.png\"\n        srcset=\"/static/a0b7e15e4373e39f18bc6c872b46c6f0/12f09/custom-domain-name-api-gateway.png 148w,\n/static/a0b7e15e4373e39f18bc6c872b46c6f0/e4a3f/custom-domain-name-api-gateway.png 295w,\n/static/a0b7e15e4373e39f18bc6c872b46c6f0/fcda8/custom-domain-name-api-gateway.png 590w,\n/static/a0b7e15e4373e39f18bc6c872b46c6f0/efc66/custom-domain-name-api-gateway.png 885w,\n/static/a0b7e15e4373e39f18bc6c872b46c6f0/c83ae/custom-domain-name-api-gateway.png 1180w,\n/static/a0b7e15e4373e39f18bc6c872b46c6f0/f3c07/custom-domain-name-api-gateway.png 2516w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>In the certificate dropdown, you should be able to see the domain that you have just created. Do not make create domain name there on the console. Now come back to terraform and let’s write the equivalent code for that.</p>\n<h2 id=\"custom_domaintf-1\" style=\"position:relative;\"><code class=\"language-text\">custom_domain.tf</code><a href=\"#custom_domaintf-1\" aria-label=\"custom_domaintf 1 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">resource &quot;aws_acm_certificate&quot; &quot;hello&quot; {\n  provider          = aws.default_us_east_1\n  domain_name       = &quot;api.hello.com&quot;\n  validation_method = &quot;DNS&quot;\n\n  tags = {\n    Environment = terraform.workspace\n  }\n\n  lifecycle {\n    create_before_destroy = true\n  }\n}\n\nresource &quot;aws_acm_certificate_validation&quot; &quot;hello&quot; {\n  provider = aws.default_us_east_1\n\n  certificate_arn         = aws_acm_certificate.hello.arn\n  validation_record_fqdns = [for record in aws_route53_record.hello : record.fqdn]\n}\n\nlocals {\n  aws_route53_your_existing_zone_id = &quot;A123A123A123A123&quot;\n}\n\nresource &quot;aws_route53_record&quot; &quot;hello&quot; {\n  for_each = {\n    for dvo in aws_acm_certificate.hello.domain_validation_options : dvo.domain_name =&gt; {\n      name   = dvo.resource_record_name\n      record = dvo.resource_record_value\n      type   = dvo.resource_record_type\n    }\n  }\n\n  allow_overwrite = true\n  name            = each.value.name\n  records         = [each.value.record]\n  ttl             = 60\n  type            = each.value.type\n  zone_id         = local.aws_route53_your_existing_zone_id\n}\n\n+ resource &quot;aws_api_gateway_domain_name&quot; &quot;hello&quot; {\n+  security_policy = &quot;TLS_1_2&quot;\n+  certificate_arn = aws_acm_certificate_validation.hello.certificate_arn\n+  domain_name     = aws_acm_certificate.hello.domain_name\n+\n+  endpoint_configuration {\n+    types = [&quot;EDGE&quot;]\n+  }\n+ }\n\n+ resource &quot;aws_route53_record&quot; &quot;custom_domain_to_cloudfront&quot; {\n+ \n+  zone_id = local.aws_route53_your_existing_zone_id\n+  name    = &quot;api.hello.com&quot;\n+  type    = &quot;CNAME&quot;\n+  ttl     = &quot;300&quot;\n+  records = [aws_api_gateway_domain_name.hello.cloudfront_domain_name]\n+ }</code></pre></div>\n<p>You are just going to fill out the options that you just saw from the API Gateway console. Just fill out the relevant info about certificate, domain name, and endpoint config. </p>\n<p>Now, this is important: you need to create another Route53 Record to map your custom domain to cloudfront. Once you create your custom domain, AWS creates ‘API Gateway domain name’, circled with red in the below picture:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/71c180697299f9f69ee1ec9375832f65/b70d9/another-route53.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABLUlEQVQoz4VR2U4DMRDbT4Buyea+s9lUlEPA/3+amWRpQaqAB8szycjjONPp8QxuAhYVYFwClw6HIycI3M8cd4e9/g99tvNUtgbrM55e3lG2M2xYwZWHsnHUsTQstIQrN853fPf9TpIhF1cI7TGFXKBJkEmDmQmYkOHSCk/QxkIoBRcS+lypjRZUuivwsSC3DanufVorjI+YUllpiyXLy3jqw6IGZibBFwEhFDmIWLjBkSmCxPywo9eXfq8VCZIy4/qaQeeBw4Itr/h4fcOJnGnKt7vXPpGjOl5gQ4Elp519rsT5VvAieiQuWqGlgOetItNc+kJtDalQVM7RR/rBNgRC+l2wM5cKjDH6tDCEYl5HhjZESG2uEEpDWxIdGf4h2DPt9c+8BkbO+gZ97hOtmtRLEX/3PgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"another-route53.png\"\n        title=\"another-route53.png\"\n        src=\"/static/71c180697299f9f69ee1ec9375832f65/fcda8/another-route53.png\"\n        srcset=\"/static/71c180697299f9f69ee1ec9375832f65/12f09/another-route53.png 148w,\n/static/71c180697299f9f69ee1ec9375832f65/e4a3f/another-route53.png 295w,\n/static/71c180697299f9f69ee1ec9375832f65/fcda8/another-route53.png 590w,\n/static/71c180697299f9f69ee1ec9375832f65/efc66/another-route53.png 885w,\n/static/71c180697299f9f69ee1ec9375832f65/c83ae/another-route53.png 1180w,\n/static/71c180697299f9f69ee1ec9375832f65/b70d9/another-route53.png 2543w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>You need to route the traffic to <code class=\"language-text\">api.hello.com</code> to this API Gateway domain name (an example of an API Gateway domain name would be <code class=\"language-text\">asdfasdfasdf.cloudfront.net</code> as long as you are using <code class=\"language-text\">EDGE</code>). That’s what we are doing with <code class=\"language-text\">aws_route53_record.custom_domain_to_cloudfront</code>. Otherwise, the response to your API will keep showing some weird errors that are really hard to guess the causes of. I found AWS really lacking a documentation on this part, so please be advised on this one. <strong>You need to create another Route53 Record</strong>.</p>\n<p>You will be able to verify by entering Route53 console and looking for <code class=\"language-text\">api.hello.com</code>. It should appear as the following:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8ae9e2735af1fc7a431b24fc4ab1e9e8/76cea/route-53-record.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.5945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACHElEQVQ4y5WT6XbaMBCFBW0CNICheJG8b9jGwix2gJRAt/d/p9uRAy3pOT1pfnznziJZ8syI6dkGZraFEUmY8gAzr6FZAe5GOnqaSXaIiYj/G3Z/30e308GHbhfdbgfazMRMF5h+Ni9Y74INRxP0Bw/EEL3+J0y5h5npEPZF3wdzwzl2Tyecvv3E4XjG6fwd1aaB7SdQudekb8IMywV3AthuRIQQTghL+DC4C5Nuq7SF1pnCexNmGhzL0IY2HGLwMMairFDKFaI4A7d9yOUaWS4pvoJOZZioWs34v2toWA44d2ixaDeI9rbXm3qtf40p3+IXxI3ewLwgweHLCWGUYDjSILwILsVcVcPgD87Fd/7GV8QtNsHcKMPu9AOyPiCRG8yrBtmqQbHZtZqvX7QgjZc1HNnArXZwLypSCSug8oQ5bGoc06kZRpxj5qewswrR6rHFL2nY4xJ6tIB+oypmkG1cbUUi25xL+5k2NXDXH+Bjb4AZdbNqdtg/n1FUG3A6RATz3/raTlv7ivKFl4DZXowwyeFHc4TUWVU7FfNoplTMpYUqr1QR0BpVN5UPqFztPsorX+WZcnK5RkLjsqCB9ud0dSpBkpWI0gLzQlLTjrSpQErj83z+iiB5ya+3j1iua5T0N+ohqIayvFyibhpsOcdecNTcQmnbqLYNmt0eeSnxdDzSB4qWVJEv6C98jMYaxtoEm7qhg870wrb4Bd2+e6A2EN26AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"route-53-record.png\"\n        title=\"route-53-record.png\"\n        src=\"/static/8ae9e2735af1fc7a431b24fc4ab1e9e8/fcda8/route-53-record.png\"\n        srcset=\"/static/8ae9e2735af1fc7a431b24fc4ab1e9e8/12f09/route-53-record.png 148w,\n/static/8ae9e2735af1fc7a431b24fc4ab1e9e8/e4a3f/route-53-record.png 295w,\n/static/8ae9e2735af1fc7a431b24fc4ab1e9e8/fcda8/route-53-record.png 590w,\n/static/8ae9e2735af1fc7a431b24fc4ab1e9e8/76cea/route-53-record.png 799w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"api_gatewaytf-1\" style=\"position:relative;\"><code class=\"language-text\">api_gateway.tf</code><a href=\"#api_gatewaytf-1\" aria-label=\"api_gatewaytf 1 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Aftrer that, you don’t have to do many things; just add base path mapping resource, in <code class=\"language-text\">api_gateway.tf</code>. Even if you do not have an additional trailing path to your endpoint, you <em>must</em> create a base path mapping. Otherwise your API won’t be exposed to the public.</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">...\n\n+ resource &quot;aws_api_gateway_base_path_mapping&quot; &quot;hello&quot; {\n+  api_id      = aws_api_gateway_rest_api.hello.id\n+  stage_name  = terraform.workspace\n+  domain_name = aws_api_gateway_domain_name.hello.domain_name\n+ }\n\n...</code></pre></div>\n<p>After applying this change, verify that your API mapping has been created:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1b64c1cbf2d85a630ce659954aebb821/0ddab/api-mapping.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.78378378378378%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABLElEQVQoz4WRWW7DIBRFvYI2rtMYMGayMZ7SSJG6/6XdXrCr5q8fR28A7huopPawbkQre9RNSwTqjxbv9a3YEv/Dhfcu593q8fzGMG3oXcRNGmg7QPUBY9rQmcBCBq2y5SzbV3Lu940NEYK5qrMBGcOEHSa4MVF8gPFHLsdunJC2HWGai58Z0ox0X+Gzz/yYFgoHVM2nYBcaSlvIzrBKD0V0Z2GkhNdHrHhHig7ipPhK4yo0mpsqXElVN5LzH3uoad+4u0jx5/5AdAFD7+CyuDInfbE2+9x7thu7nKelrKH6uEq8koVH65H2O8b1YFg2GI5uYoJPKxwf59jHGev+hYnn93k+Rv4TE4cgf8q0EkEpRGsxkeRZ4PSXELBwv8k6zMzvMSI5xyYcBFf2A8M7u4Xlhpe6AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"api-mapping.png\"\n        title=\"api-mapping.png\"\n        src=\"/static/1b64c1cbf2d85a630ce659954aebb821/fcda8/api-mapping.png\"\n        srcset=\"/static/1b64c1cbf2d85a630ce659954aebb821/12f09/api-mapping.png 148w,\n/static/1b64c1cbf2d85a630ce659954aebb821/e4a3f/api-mapping.png 295w,\n/static/1b64c1cbf2d85a630ce659954aebb821/fcda8/api-mapping.png 590w,\n/static/1b64c1cbf2d85a630ce659954aebb821/efc66/api-mapping.png 885w,\n/static/1b64c1cbf2d85a630ce659954aebb821/c83ae/api-mapping.png 1180w,\n/static/1b64c1cbf2d85a630ce659954aebb821/0ddab/api-mapping.png 2220w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Now, you can go back to Postman, and test your api by requesting GET <code class=\"language-text\">api.hello.com/hello</code>. What may be confusing here is that you are not adding any <code class=\"language-text\">path</code> in base path mapping. If you add <code class=\"language-text\">hello</code> as a path, your API endpoint will be configured  as <code class=\"language-text\">api.hello.com/hello/hello</code>, which is obviously not what we want. So do not add any path mapping if you already have configured your path in <code class=\"language-text\">aws_api_gateway_resource</code>). Anyways, request and response to the API endpoint should work as expected if everything has been setup correctly so far.</p>\n<h1 id=\"enabling-options-preflight-request\" style=\"position:relative;\">Enabling OPTIONS (preflight request)<a href=\"#enabling-options-preflight-request\" aria-label=\"enabling options preflight request permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>Now, our client application, of course, is not Postman, so usually clients will request OPTIONS <code class=\"language-text\">api.hello.com/hello</code> first, and then request GET <code class=\"language-text\">api.hello.com/hello</code>, if they intend to send CORS requests, which is a very common case (<a href=\"https://developer.mozilla.org/en-US/docs/Glossary/Preflight_request\">read more about that from MDN docs</a>)</p>\n<p>If you have not done anything related to handling OPTIONS request, it’s very likely that you will get some error in your client application, like this (<a href=\"https://stackoverflow.com/questions/59909987/aws-api-gateway-403-forbidden-response-to-preflight-options-request\">I got this picture from somewhere else for the purpose of demonstration</a>):</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3fd81b114dd729524c5db7e3e1439551/f36fd/options-cors-error.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA/klEQVQY01WQy3aCQBBE+f//yiaLxHhUYBzMg2hiQAa6eQwqVArIJot7qrpmuucR1C6EO69QZmvIZQstdpiyTi3Zw1N9bee6EYtW/lSTxVd7qDMQF89ZoG6H4meF4vwMyV/YbLhxIubmEG0Vzb6mahlRDWEti2oZo8g2cPl29kFTRJDzGpqt4L7ZdEnQsanXA67NG671wk1f0csBfqLimkwwqxJIxhk5b0gf3Pc8dRvj48EgfbQ4PVnUNoSYGGINGhOhTyzGY4rh6wh/IvTj6RNgPelI7ZhJ+s6BZYl7KegyAbQC34FBFUPbzowEHdV7jH3/j6H3ZPG3puF/K34BkO14QIaIKd8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"options-cors-error.png\"\n        title=\"options-cors-error.png\"\n        src=\"/static/3fd81b114dd729524c5db7e3e1439551/fcda8/options-cors-error.png\"\n        srcset=\"/static/3fd81b114dd729524c5db7e3e1439551/12f09/options-cors-error.png 148w,\n/static/3fd81b114dd729524c5db7e3e1439551/e4a3f/options-cors-error.png 295w,\n/static/3fd81b114dd729524c5db7e3e1439551/fcda8/options-cors-error.png 590w,\n/static/3fd81b114dd729524c5db7e3e1439551/efc66/options-cors-error.png 885w,\n/static/3fd81b114dd729524c5db7e3e1439551/c83ae/options-cors-error.png 1180w,\n/static/3fd81b114dd729524c5db7e3e1439551/f36fd/options-cors-error.png 2488w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>So let’s do it! There’s already a <a href=\"https://github.com/squidfunk/terraform-aws-api-gateway-enable-cors\">handy module written by a great dev</a>, so we will just use that:</p>\n<h2 id=\"api_gatewaytf-2\" style=\"position:relative;\"><code class=\"language-text\">api_gateway.tf</code><a href=\"#api_gatewaytf-2\" aria-label=\"api_gatewaytf 2 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">...\n\n+ module &quot;cors&quot; {\n+  source  = &quot;squidfunk/api-gateway-enable-cors/aws&quot;\n+  version = &quot;0.3.1&quot;\n+  allow_headers = [\n+    # default allowed headers\n+    &quot;Authorization&quot;,\n+    &quot;Content-Type&quot;,\n+    &quot;X-Amz-Date&quot;,\n+    &quot;X-Amz-Security-Token&quot;,\n+    &quot;X-Api-Key&quot;,\n+    # custom allowed headers\n+    &quot;x-my-custom-header&quot;,\n+  ]\n+\n+  api_id          = aws_api_gateway_rest_api.hello.id\n+  api_resource_id = aws_api_gateway_resource.hello_eng.id\n+ }</code></pre></div>\n<p>Note that if you have any custom headers, you must define it in your config. Next, verify that OPTIONS requests are now allowed on the console:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 559px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f72800bcee0102e8a8f3013cf40b08f9/a65ce/verify-options.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.5945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAACJ0lEQVQ4y5VSy5LSUBC9NYM4wIhTMHncvBMSksDUQCAJWKLFLFxYs9G1C/0E/Qv/xIUfeey+AZxguZjFqb6ddJ8+fe4VjheAYbv+f8H/LYrSdilvajm360+IH74ifPgGc7ZDGIYQy2WB1XoNzZDQTesfMInnh6iqEuv1Coa0YEobunRgff6Jtz9+ofr+GzfVFyzucgiXirlBKVGKvJMySylqFHpxhmA6hxOlaoi0HRhujFs3IUwh3QiSBonZ/A51vVEql8UK2+1WnevNRp15oEGFXlYgmJfw0vvT+tKyaahNkVXTRvEcghW47JHjqSJuPsK0SAVBEkxePUowGo3R7b5Er98nDNDr9TC8GcEi8nFekodFAUZZVgcvrYboCTEPYt8MbwKd1AyGfXRedNEhYkFxMHytCEfJAoIb2HztcAnnChlMqFsuYtPAuzzCx90KuzRG5Vp440oEtLZOdYHvQhxJ1NM5PZ8mKmUHQo1ibRv4ENh4SEI85hO8dyi3NSSk+pZuPQoDiGw2RzSJcdXroz+4JgyUP9evhq2VjYOfPpnvmxKeacKhNZlIk43P0vEhitUacZJACIGLi0tcdjroEK7I7JaHB19ZqX6EZEts5S//54sVY81Els+woAd+v1giJLWGdFokx3PTeA7n5LciZKlxMkWa5ZimmXp3uvn3Qs4VHr8/RYvQsQzUZYH9fq9Ix5rRKno2ISdBOCGyGZJpCj+IWo3PJfwDauV5YD2TiAEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"verify-options.png\"\n        title=\"verify-options.png\"\n        src=\"/static/f72800bcee0102e8a8f3013cf40b08f9/a65ce/verify-options.png\"\n        srcset=\"/static/f72800bcee0102e8a8f3013cf40b08f9/12f09/verify-options.png 148w,\n/static/f72800bcee0102e8a8f3013cf40b08f9/e4a3f/verify-options.png 295w,\n/static/f72800bcee0102e8a8f3013cf40b08f9/a65ce/verify-options.png 559w\"\n        sizes=\"(max-width: 559px) 100vw, 559px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Also, you will need to change your lambda’s response header too. Just adding <code class=\"language-text\">Access-Control-Allow-Origin&quot;: &quot;*&quot;</code> will work:</p>\n<h2 id=\"packageshellolibindexts-1\" style=\"position:relative;\"><code class=\"language-text\">packages/hello/lib/index.ts</code><a href=\"#packageshellolibindexts-1\" aria-label=\"packageshellolibindexts 1 permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  APIGatewayProxyEvent<span class=\"token punctuation\">,</span>\n  APIGatewayProxyResult\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"aws-lambda\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> handler <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>\n  event<span class=\"token operator\">:</span> APIGatewayProxyEvent\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>APIGatewayProxyResult<span class=\"token operator\">></span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n<span class=\"token operator\">+</span>   headers<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"token operator\">+</span>     <span class=\"token string\">\"Access-Control-Allow-Origin\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"*\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token operator\">+</span>   <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    statusCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n    body<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">hello</span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now, apply the changes, and go back to your client app and retry the request. It should be working.</p>\n<h1 id=\"summing-up\" style=\"position:relative;\">Summing up<a href=\"#summing-up\" aria-label=\"summing up permalink\" class=\"anchor after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>If you have followed everything, you will have created these files:</p>\n<div class=\"gatsby-highlight\" data-language=\"tf\"><pre class=\"language-tf\"><code class=\"language-tf\">➜  example-lambda git:(master) ✗ tree -I node_modules\n.\n├── IaC\n│   ├── api_gateway.tf\n│   ├── custom_domain.tf\n│   ├── ecr.tf\n│   ├── hello_role.tf\n│   ├── lambda.tf\n│   └── main.tf\n└── server\n    ├── build-and-push-docker-image.sh\n    ├── lerna.json\n    ├── login-docker.sh\n    ├── nodemon.json\n    ├── package-lock.json\n    ├── package.json\n    ├── packages\n    │   └── hello\n    │       ├── Dockerfile\n    │       ├── README.md\n    │       ├── lib\n    │       │   └── index.ts\n    │       ├── package-lock.json\n    │       ├── package.json\n    │       └── tsconfig.json\n    └── template.yml\n\n5 directories, 20 files</code></pre></div>\n<p>So far, we have looked at how to setup, develop and deploy a dockerized lambda application with Typescript, Terraform and SAM CLI. There are tonnes of things to cover on lambda.. maybe next time, it will be on using resources inside VPC from lambda. I hope you enjoyed this and found some valuable insights. Thank you.</p>","frontmatter":{"title":"Complete end-to-end guide for developing dockerized lambda in Typescript, Terraform and SAM CLI","date":"March 13, 2021"}}},"pageContext":{"slug":"/2021-03-13-complete-end-to-end-guide-for-developing-dockerized-lambda-with-typescript-terraform-and-SAM-cli/","previous":{"fields":{"slug":"/2020-10-04-100BooksProject-(9):Atomic-habits/"},"frontmatter":{"title":"100BooksProject: (9): Atomic habits"}},"next":{"fields":{"slug":"/2021-05-18--part-1-writing-a-scalable-react-application-with-a-scalable-architecture/"},"frontmatter":{"title":"Part 1: writing a react application with a scalable architecture"}}}},"staticQueryHashes":["3128451518","426816048"]}